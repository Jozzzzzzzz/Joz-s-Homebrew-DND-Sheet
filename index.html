<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=0.85, maximum-scale=0.85, user-scalable=no">
<title>Joz's Homebrew DND Sheet</title>
<style>

 .section, textarea {
    transition: none !important; /* Prevent animation interference */
  }

/* Container Styles */
.section {
  position: relative;
  resize: both; /* Allows manual resizing */
  overflow: auto;
  min-height: 150px;
  min-width: 200px;
  padding: 1rem; /* Maintain padding */
  display: flex; /* New - enables flexible layout */
  flex-direction: column; /* New - stacks children vertically */
}

/* Textarea Styles */
textarea {
  resize: both;
  min-height: 100px;
  min-width: 200px;
  overflow: auto;
  flex-grow: 1; /* New - makes textarea grow to fill container */
  margin-bottom: 10px; /* Space between textarea and other content */
}

/* Special case for basic-textareas */
.basic-textarea {
  resize: both;
  min-height: 200px;
  width: 100% !important; /* Full width of container */
  flex-grow: 1;
}

/* Resizer handle styling */
.section::-webkit-resizer {
  background-color: var(--accent);
}

/* Ensure other content stays properly aligned */
.section-content {
  flex-shrink: 0; /* Prevents other content from shrinking */
}

/* Action Tracker Styles */
.action-tracker {
  display: flex;
  gap: 15px;
  padding: 10px;
  background: #2a2a2a;
  border: var(--border);
  border-radius: 4px;
  margin-bottom: 15px;
  align-items: center;
}

.action-group {
  display: flex;
  align-items: center;
  gap: 8px;
}

.action-label {
  font-size: 0.85rem;
  color: var(--accent);
  font-weight: bold;
  min-width: 60px;
}

.action-input {
  width: 40px;
  padding: 5px;
  text-align: center;
  background: #333;
  color: white;
  border: 1px solid #444;
  border-radius: 3px;
}

.usage-toggle {
  display: flex;
  align-items: center;
  gap: 5px;
}

.usage-toggle input[type="checkbox"] {
  width: 14px;
  height: 14px;
  accent-color: var(--condition-green);
  cursor: pointer;
}

.usage-toggle label {
  font-size: 0.75rem;
  color: #aaa;
  cursor: pointer;
  white-space: nowrap;
}

.usage-toggle input[type="checkbox"]:checked + label {
  color: var(--condition-green);
  font-weight: bold;
}

.new-round-btn {
  margin-left: auto;
  padding: 3px 8px;
  font-size: 0.7rem;
  background: #333;
  color: var(--accent);
  border: 1px solid #444;
}

/* === POPUP FIXES === */
.popup {
  pointer-events: none;
}

.popup[style*="display: block"] {
  pointer-events: auto;
}

/* === EXISTING CSS (OPTIMIZED) === */
:root {
  --dark-bg: #121212;
  --panel-bg: #1e1e1e;
  --border: 1px solid #444;
  --accent: gold;
  --text-light: #f0f0f0;
  --condition-red: #ff6b6b;
  --condition-blue: #6b8cff;
  --condition-green: #6bff8c;
  --popup-bg: #2a2a2a;
}

body {
  margin: 0;
  font-family: 'Segoe UI', sans-serif;
  background: var(--dark-bg);
  color: var(--text-light);
}

h1, h2, h3, h4 {
  color: var(--accent);
  margin-top: 0;
}

.tabs {
  display: flex;
  justify-content: center;
  gap: 10px;
  flex-wrap: wrap;
  padding: 10px;
  background: #222;
  position: sticky;
  top: 0;
  z-index: 100;
}

.tabs button {
  background: var(--panel-bg);
  color: white;
  border: var(--border);
  padding: 8px 16px;
  cursor: pointer;
  transition: all 0.2s;
  border-radius: 4px;
}

.tabs button.active {
  background: var(--accent);
  color: black;
  font-weight: bold;
}

/* Home Page Styles */
.welcome-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
}

.welcome-section {
  background: #2a2a2a;
  padding: 15px;
  border-radius: 6px;
  border: var(--border);
}

.divider {
  height: 1px;
  background: var(--accent);
  margin: 10px 0;
  opacity: 0.3;
}

@media (max-width: 768px) {
  .welcome-grid {
    grid-template-columns: 1fr;
  }
}

/* Character Manager Styles */
.character-manager-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 15px;
}

.character-manager-grid > div {
  background: #1e1e1e;
  padding: 10px;
  border-radius: 4px;
  border: var(--border);
}

.character-manager-grid h4 {
  margin-top: 0;
  color: var(--accent);
  font-size: 1rem;
}

.character-manager-grid input,
.character-manager-grid select {
  width: 100%;
  margin-bottom: 8px;
}

.delete-flow {
  position: relative;
}

#deleteConfirmInput {
  margin-top: 5px;
  width: calc(100% - 10px);
}

#deleteCharCount {
  position: absolute;
  right: 10px;
  bottom: -20px;
  font-size: 0.8rem;
  color: #aaa;
}

/* Delete button states */
#deleteBtn.warning {
  background-color: #ffcc00;
  color: #000;
}

#deleteBtn.danger {
  background-color: #ff6600;
  color: #000;
  animation: pulse 0.5s infinite alternate;
}

.page {
  display: none;
  padding: 1rem;
}

.page.active {
  display: block;
}

.section {
  background: var(--panel-bg);
  padding: 1rem;
  margin: 1rem 0;
  border-radius: 6px;
  border: var(--border);
  transition: all 0.3s ease;
  box-sizing: border-box;
}

.resizable {
  resize: both;
  overflow: auto;
  min-height: 50px;
  min-width: 100px;
}

.flex-wrap {
  display: flex;
  flex-wrap: wrap;
  gap: 1rem;
}

.flex-wrap .section {
  flex: 1 1 300px;
}

.horizontal-sections {
  display: flex;
  gap: 1rem;
  margin-top: 1rem;
  flex-direction: column;
}

.horizontal-sections .section {
  flex: 1;
  min-width: 300px;
}

input, textarea, select {
  width: 100%;
  padding: 8px;
  background: #2a2a2a;
  color: white;
  border: 1px solid #666;
  border-radius: 4px;
  margin: 4px 0 10px;
  box-sizing: border-box;
}

textarea {
  resize: vertical;
  min-height: 60px;
}

button {
  background: var(--accent);
  border: none;
  padding: 8px 16px;
  border-radius: 4px;
  font-weight: bold;
  cursor: pointer;
  margin: 4px 2px;
  transition: all 0.2s;
}

button:hover {
  background: #ffd700;
  transform: translateY(-1px);
}

.top-right-reset {
  position: fixed;
  top: 10px;
  right: 10px;
  background: var(--panel-bg);
  color: var(--accent);
  border: var(--border);
  cursor: pointer;
  padding: 5px 10px;
  z-index: 1000;
}

.condition {
  background: #2a2a2a;
  border-left: 4px solid var(--condition-red);
  padding: 8px;
  margin: 6px 0;
  border-radius: 0 4px 4px 0;
}

.condition.blue { border-color: var(--condition-blue); }
.condition.green { border-color: var(--condition-green); }

.condition-header {
  display: flex;
  justify-content: space-between;
  font-weight: bold;
}

.condition-turns {
  color: var(--accent);
  font-style: italic;
}

.popup {
  display: none;
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: var(--popup-bg);
  padding: 20px;
  border: var(--border);
  border-radius: 6px;
  z-index: 1000;
  width: 90%;
  max-width: 800px;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 0 20px rgba(0,0,0,0.5);
}

.popup-backdrop {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.7);
  z-index: 999;
}

.portrait-container {
  width: 200px;
  height: 250px;
  border: var(--border);
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  margin-bottom: 10px;
  background: #2a2a2a;
}

.portrait-container img {
  max-width: 100%;
  max-height: 100%;
  object-fit: contain;
}

.skill-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 10px;
  margin-bottom: 8px;
}

.skill-row label {
  flex: 1;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.skill-row input[type="checkbox"] {
  width: auto;
  margin-right: 5px;
}

.skill-row input[type="text"] {
  width: 60px;
  text-align: center;
}

table {
  width: 100%;
  border-collapse: collapse;
  margin-bottom: 10px;
}

th, td {
  padding: 8px;
  border: 1px solid #444;
  text-align: left;
}

th {
  background: #2a2a2a;
}

/* === UPDATED STYLES === */
/* Basic Textarea Style (for direct editing) */
.basic-textarea {
  width: 100%;
  min-height: 200px;
  background: #2a2a2a;
  color: white;
  border: 1px solid #666;
  padding: 10px;
  box-sizing: border-box;
  resize: vertical;
  display: block !important;
}

.basic-textarea::placeholder {
  color: #888;
  font-style: italic;
}

/* Make all sections resizable */
.section {
  resize: both;
  overflow: auto;
  min-height: 150px;
  min-width: 200px;
}

/* Adjust notes container */
.notes-container {
  min-height: 100px;
  background: #2a2a2a;
  border: 1px solid #444;
  padding: 10px;
  margin-bottom: 10px;
}

.background-grid {
  display: grid;
  grid-template-columns: 250px 1fr;
  gap: 1rem;
}

.background-textareas {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1rem;
}

.weight-display {
  font-weight: bold;
  margin-top: 10px;
  text-align: right;
}

.inventory-controls {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}

.delete-container-btn {
  background-color: #ff4444;
  color: white;
}

.delete-container-btn.confirm {
  background-color: #ff0000;
  animation: pulse 0.5s infinite alternate;
}

.ability-row {
  display: flex;
  gap: 10px;
  margin-bottom: 10px;
}

.ability-col {
  flex: 1;
}

.skills-container {
  overflow-y: auto;
}

.item-row {
  cursor: pointer;
}

.item-row:hover {
  background-color: #2a2a2a;
}

/* Add this new style for overweight containers */
.overweight {
  color: var(--condition-red) !important;
  font-weight: bold;
}

/* Improved death saves layout */
.death-saves-container {
  display: flex;
  justify-content: space-between;
  gap: 10px;
}

.death-save-group {
  flex: 1;
}

.death-save-checks {
  display: flex;
  gap: 5px;
  margin-top: 5px;
}

/* Improved notes in tables */
.table-notes {
  max-height: 100px;
  overflow-y: auto;
  padding: 5px;
  background: #2a2a2a;
  border: 1px solid #444;
  border-radius: 4px;
}

@keyframes pulse {
  from { transform: scale(1); }
  to { transform: scale(1.05); }
}

/* ===== FIXED POPUP POSITIONING ===== */
.popup {
  display: none;
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: var(--popup-bg);
  padding: 20px;
  border: var(--border);
  border-radius: 6px;
  z-index: 1000;
  width: 90%;
  max-width: 800px;
  max-height: 90vh;
  overflow-y: auto;
  box-sizing: border-box;
}

/* Mobile-specific fixes */
@media (max-width: 768px) {
  .popup {
    width: 95vw !important;
    max-width: 95vw !important;
    height: auto;
    max-height: 85vh !important;
    padding: 15px;
  }
  
  .popup table {
    display: block;
    overflow-x: auto;
    width: 100% !important;
    -webkit-overflow-scrolling: touch;
  }
  
  .popup table td, 
  .popup table th {
    white-space: nowrap;
    padding: 6px 4px;
  }
}

@media (max-width: 768px) {

   .section div[style*="grid-template-columns"] {
    grid-template-columns: 1fr !important;
  }

  .background-grid {
    grid-template-columns: 1fr;
  }
  
  .background-textareas {
    grid-template-columns: 1fr;
  }
  
  .flex-wrap .section {
    flex: 1 1 100%;
  }
  
  .horizontal-sections {
    flex-direction: column;
  }
  
  .portrait-container {
    width: 150px;
    height: 200px;
    margin: 0 auto;
  }
}
#notesPopupTextarea {
  display: block !important;
  width: 100%;
  min-height: 200px;
  background: #2a2a2a;
  color: white;
  border: 1px solid #666;
  padding: 10px;
  box-sizing: border-box;
}
/* Add these to your existing CSS */
.portrait-container img {
  max-width: 100%;
  max-height: 100%;
  object-fit: contain;
  display: block;
}

#saveDataBtn, #saveLayoutBtn {
  background: #333;
  color: var(--accent);
  margin-left: 5px;
}

#saveDataBtn:hover, #saveLayoutBtn:hover {
  background: #444;
}
</style>
</head>
<body>
<!-- Warning Banner -->
<div style="text-align:center; background:#222; color:#ccc; padding:8px; border-bottom: var(--border);">
⚠️ This sheet autosaves character data to your browser. Use Export to back up your character.
</div>

<!-- Header -->
<h1>Joz's Homebrew DND Sheet 
  <span style="font-size:0.8rem; color:#aaa; margin-left:10px;">[Autosaves Locally]</span>
</h1>

<!-- Data Controls -->
<div style="text-align:right; margin-right:1rem; margin-top:-10px;">
  <button onclick="document.getElementById('home').classList.add('active'); document.querySelectorAll('.page').forEach(p => { if(p.id !== 'home') p.classList.remove('active') }); document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));">🏠 Home</button>
  <button onclick="exportData()">📤 Export</button>
  <label style="display:inline-block; cursor:pointer;">
    📥 Import<input onchange="importData(event)" style="display:none;" type="file"/>
  </label>
  <button id="resetLayoutBtn">⟳ Reset Layout</button>
  <button id="saveLayoutBtn">💾 Save Layout</button>
  <button onclick="autosave(); alert('Character data saved!')" style="background:#333; color:var(--accent);">📥 Save Data</button>
</div>

<!-- Tabs -->
<div class="tabs">
  <button class="tab active" data-tab="page1" onclick="switchTab(this)">Stats</button>
  <button class="tab" data-tab="page2" onclick="switchTab(this)">Background</button>
  <button class="tab" data-tab="page3" onclick="switchTab(this)">Spells</button>
  <button class="tab" data-tab="page4" onclick="switchTab(this)">Inventory</button>
  <button class="tab" data-tab="page6" onclick="switchTab(this)">Notes</button>
</div>

<!-- Pages -->
<div id="pages">
  
<!-- Home Page -->
<div class="page" id="home">
  <div class="section">
    <h2>Welcome to Joz's Homebrew DND Sheet</h2>
    <div class="welcome-grid">
      <div class="welcome-section">
        <h3>Character Manager</h3>
        <div class="divider"></div>
        <div class="character-manager-grid">
          <div>
            <h4>New Character</h4>
            <input type="text" id="newCharName" placeholder="Character Name">
            <button onclick="createNewCharacter()">Create</button>
          </div>
          <div>
            <h4>Load Character</h4>
            <select id="characterList"></select>
            <button onclick="loadSelectedCharacter()">Load</button>
          </div>
          <div>
            <h4>Delete Character</h4>
            <div class="delete-flow">
              <button id="deleteBtn" onclick="initiateDelete()">Delete Character</button>
              <input type="text" id="deleteConfirmInput" placeholder="Type 'DELETE'" style="display: none;">
              <span id="deleteCharCount" style="display: none;">0/6</span>
            </div>
          </div>
        </div>
      </div>
      
      <div class="welcome-section">
        <h3>Getting Started</h3>
        <div class="divider"></div>
        <p>This digital character sheet automatically saves your data to your browser. To get started:</p>
        <ol>
          <li>Create a new character using the Character Manager</li>
          <li>Fill in your basic character information on the Stats page</li>
          <li>Use the tabs to navigate between different character sections</li>
          <li>Remember to export your character for backup</li>
        </ol>
      </div>
      
      <div class="welcome-section">
        <h3>Features</h3>
        <div class="divider"></div>
        <ul>
          <li><strong>Automatic Saving:</strong> All changes are saved automatically</li>
          <li><strong>Multiple Characters:</strong> Manage multiple character sheets</li>
          <li><strong>Resizable Sections:</strong> Drag to resize any section</li>
          <li><strong>Mobile Friendly:</strong> Works on phones and tablets</li>
          <li><strong>Homebrew Ready:</strong> Customizable for any homebrew content</li>
        </ul>
      </div>
    </div>
  </div>
</div>

  <!-- Stats Page -->
  <div class="page active" id="page1">
<!-- Character Basic Info -->
<div class="section" style="margin-bottom: 15px;">
  <h2>Character Info</h2>
  <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px;">
    <div>
      <label>Name</label>
      <input id="char_name" oninput="autosave()" placeholder="Character Name"/>
    </div>
    <div>
      <label>Race</label>
      <input id="char_race" oninput="autosave()" placeholder="Race"/>
    </div>
    <div>
      <label>Class</label>
      <input id="char_class" oninput="autosave()" placeholder="Class"/>
    </div>
    <div>
      <label>Subclass</label>
      <input id="char_subclass" oninput="autosave()" placeholder="Subclass"/>
    </div>
    <div>
      <label>Level</label>
      <input id="char_level" oninput="autosave()" type="number" min="1" placeholder="Level"/>
    </div>
  </div>
</div>
    <div class="flex-wrap">
      
      <!-- Ability Scores -->
      <div class="section">
        <h2>Ability Scores</h2>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
          <div class="ability-row">
            <div class="ability-col">
              <label>STR</label>
              <input id="str" oninput="autosave()"/>
            </div>
            <div class="ability-col">
              <label>STR Bonus</label>
              <input id="str_bonus" oninput="autosave()"/>
            </div>
          </div>
          <div class="ability-row">
            <div class="ability-col">
              <label>DEX</label>
              <input id="dex" oninput="autosave()"/>
            </div>
            <div class="ability-col">
              <label>DEX Bonus</label>
              <input id="dex_bonus" oninput="autosave()"/>
            </div>
          </div>
          <div class="ability-row">
            <div class="ability-col">
              <label>CON</label>
              <input id="con" oninput="autosave()"/>
            </div>
            <div class="ability-col">
              <label>CON Bonus</label>
              <input id="con_bonus" oninput="autosave()"/>
            </div>
          </div>
          <div class="ability-row">
            <div class="ability-col">
              <label>INT</label>
              <input id="int" oninput="autosave()"/>
            </div>
            <div class="ability-col">
              <label>INT Bonus</label>
              <input id="int_bonus" oninput="autosave()"/>
            </div>
          </div>
          <div class="ability-row">
            <div class="ability-col">
              <label>WIS</label>
              <input id="wis" oninput="autosave()"/>
            </div>
            <div class="ability-col">
              <label>WIS Bonus</label>
              <input id="wis_bonus" oninput="autosave()"/>
            </div>
          </div>
          <div class="ability-row">
            <div class="ability-col">
              <label>CHA</label>
              <input id="cha" oninput="autosave()"/>
            </div>
            <div class="ability-col">
              <label>CHA Bonus</label>
              <input id="cha_bonus" oninput="autosave()"/>
            </div>
          </div>
        </div>
        
        <!-- Combat Stats -->
        <h3 style="margin-top: 15px;">Combat Stats</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
          <div>
            <label>AC</label>
            <input id="ac" oninput="autosave()"/>
            <label>Initiative</label>
            <input id="initiative" oninput="autosave()"/>
          </div>
          <div>
            <label>Speed</label>
            <input id="speed" oninput="autosave()"/>
            <label>Prof. Bonus</label>
            <input id="prof_bonus" oninput="autosave()"/>
          </div>
        </div>
      </div>
      
      <!-- Skills -->
      <div class="section">
        <h2>Skills</h2>
        <div class="skills-container">
          <div class="skill-row">
            <input id="prof_acrobatics" oninput="autosave()" type="checkbox"/>
            <label for="prof_acrobatics">Acrobatics (Dex)</label>
            <input id="bonus_acrobatics" oninput="autosave()" type="text" placeholder="+0"/>
          </div>
          <div class="skill-row">
            <input id="prof_animal_handling" oninput="autosave()" type="checkbox"/>
            <label for="prof_animal_handling">Animal Handling (Wis)</label>
            <input id="bonus_animal_handling" oninput="autosave()" type="text" placeholder="+0"/>
          </div>
          <div class="skill-row">
            <input id="prof_arcana" oninput="autosave()" type="checkbox"/>
            <label for="prof_arcana">Arcana (Int)</label>
            <input id="bonus_arcana" oninput="autosave()" type="text" placeholder="+0"/>
          </div>
          <div class="skill-row">
            <input id="prof_athletics" oninput="autosave()" type="checkbox"/>
            <label for="prof_athletics">Athletics (Str)</label>
            <input id="bonus_athletics" oninput="autosave()" type="text" placeholder="+0"/>
          </div>
          <div class="skill-row">
            <input id="prof_deception" oninput="autosave()" type="checkbox"/>
            <label for="prof_deception">Deception (Cha)</label>
            <input id="bonus_deception" oninput="autosave()" type="text" placeholder="+0"/>
          </div>
          <div class="skill-row">
            <input id="prof_history" oninput="autosave()" type="checkbox"/>
            <label for="prof_history">History (Int)</label>
            <input id="bonus_history" oninput="autosave()" type="text" placeholder="+0"/>
          </div>
          <div class="skill-row">
            <input id="prof_insight" oninput="autosave()" type="checkbox"/>
            <label for="prof_insight">Insight (Wis)</label>
            <input id="bonus_insight" oninput="autosave()" type="text" placeholder="+0"/>
          </div>
          <div class="skill-row">
            <input id="prof_intimidation" oninput="autosave()" type="checkbox"/>
            <label for="prof_intimidation">Intimidation (Cha)</label>
            <input id="bonus_intimidation" oninput="autosave()" type="text" placeholder="+0"/>
          </div>
          <div class="skill-row">
            <input id="prof_investigation" oninput="autosave()" type="checkbox"/>
            <label for="prof_investigation">Investigation (Int)</label>
            <input id="bonus_investigation" oninput="autosave()" type="text" placeholder="+0"/>
          </div>
          <div class="skill-row">
            <input id="prof_medicine" oninput="autosave()" type="checkbox"/>
            <label for="prof_medicine">Medicine (Wis)</label>
            <input id="bonus_medicine" oninput="autosave()" type="text" placeholder="+0"/>
          </div>
          <div class="skill-row">
            <input id="prof_nature" oninput="autosave()" type="checkbox"/>
            <label for="prof_nature">Nature (Int)</label>
            <input id="bonus_nature" oninput="autosave()" type="text" placeholder="+0"/>
          </div>
          <div class="skill-row">
            <input id="prof_perception" oninput="autosave()" type="checkbox"/>
            <label for="prof_perception">Perception (Wis)</label>
            <input id="bonus_perception" oninput="autosave()" type="text" placeholder="+0"/>
          </div>
          <div class="skill-row">
            <input id="prof_performance" oninput="autosave()" type="checkbox"/>
            <label for="prof_performance">Performance (Cha)</label>
            <input id="bonus_performance" oninput="autosave()" type="text" placeholder="+0"/>
          </div>
          <div class="skill-row">
            <input id="prof_persuasion" oninput="autosave()" type="checkbox"/>
            <label for="prof_persuasion">Persuasion (Cha)</label>
            <input id="bonus_persuasion" oninput="autosave()" type="text" placeholder="+0"/>
          </div>
          <div class="skill-row">
            <input id="prof_religion" oninput="autosave()" type="checkbox"/>
            <label for="prof_religion">Religion (Int)</label>
            <input id="bonus_religion" oninput="autosave()" type="text" placeholder="+0"/>
          </div>
          <div class="skill-row">
            <input id="prof_sleight_of_hand" oninput="autosave()" type="checkbox"/>
            <label for="prof_sleight_of_hand">Sleight of Hand (Dex)</label>
            <input id="bonus_sleight_of_hand" oninput="autosave()" type="text" placeholder="+0"/>
          </div>
          <div class="skill-row">
            <input id="prof_stealth" oninput="autosave()" type="checkbox"/>
            <label for="prof_stealth">Stealth (Dex)</label>
            <input id="bonus_stealth" oninput="autosave()" type="text" placeholder="+0"/>
          </div>
          <div class="skill-row">
            <input id="prof_survival" oninput="autosave()" type="checkbox"/>
            <label for="prof_survival">Survival (Wis)</label>
            <input id="bonus_survival" oninput="autosave()" type="text" placeholder="+0"/>
          </div>
        </div>
      </div>
      
      <!-- Health -->
      <div class="section">
        <h2>Health</h2>
        <label>Max HP</label>
        <input id="max_hp" oninput="autosave()" type="number"/>
        <label>Current HP</label>
        <input id="curr_hp" oninput="autosave()" type="number"/>
        
        <div style="margin: 10px 0; display: flex; gap: 5px;">
          <button onclick="adjustHP(1)">+1</button>
          <button onclick="adjustHP(-1)">-1</button>
          <button onclick="showHPPopup()">Custom Adjust</button>
        </div>
        
        <p id="temp_hp_note" style="color: gold;"></p>
        
        <div style="margin-top: 10px;">
          <button onclick="longRest()">Long Rest</button>
        </div>
        
        <!-- Death Saves -->
        <h3 style="margin-top: 15px;">Death Saves</h3>
        <div class="death-saves-container">
          <div class="death-save-group">
            <label>Success</label>
            <div class="death-save-checks">
              <input type="checkbox" id="death_save_success_1" oninput="autosave()"/>
              <input type="checkbox" id="death_save_success_2" oninput="autosave()"/>
              <input type="checkbox" id="death_save_success_3" oninput="autosave()"/>
            </div>
          </div>
          <div class="death-save-group">
            <label>Failure</label>
            <div class="death-save-checks">
              <input type="checkbox" id="death_save_failure_1" oninput="autosave()"/>
              <input type="checkbox" id="death_save_failure_2" oninput="autosave()"/>
              <input type="checkbox" id="death_save_failure_3" oninput="autosave()"/>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Proficiencies & Training (swapped with Conditions) -->
      <div class="section">
        <h2>Proficiencies & Training</h2>
        <textarea id="proficiencies_training" class="basic-textarea" 
                  oninput="autosave()" placeholder="List your proficiencies, tools, languages, and special training..."
                  style="min-height: 100px;"></textarea>
      </div>
    </div>
    
    <!-- Weapons and Equipment at bottom -->
    <div class="horizontal-sections">
      <!-- Weapons -->
      <div class="section">
        <h2>Weapons 
          <button onclick="showWeaponsPopup()" style="float: right; padding: 2px 6px; font-size: 0.8rem;">✎ Edit</button>
        </h2>
        <div id="weapons_preview">
          <!-- Weapons preview will be shown here -->
        </div>
      </div>
      
      <!-- Action Tracker -->
<div class="action-tracker">
  <div class="action-group">
    <span class="action-label">Actions</span>
    <input class="action-input" id="action_counter" type="number" min="0" oninput="autosave()" value="0">
    <div class="usage-toggle">
      <input type="checkbox" id="action_tick" oninput="autosave()" title="Mark if used this round">
      <label for="action_tick">Used</label>
    </div>
  </div>
  
  <div class="action-group">
    <span class="action-label">Bonus</span>
    <input class="action-input" id="bonus_action_counter" type="number" min="0" oninput="autosave()" value="0">
    <div class="usage-toggle">
      <input type="checkbox" id="bonus_action_tick" oninput="autosave()" title="Mark if used this round">
      <label for="bonus_action_tick">Used</label>
    </div>
  </div>
  
  <button class="new-round-btn" onclick="resetRoundActions()">New Round</button>
</div>

<!-- Actions & Features -->
<div class="section">
  <h2>Actions & Features</h2>
  <textarea id="actions_features" class="basic-textarea" 
            oninput="autosave()" placeholder="Enter your actions and features here..."></textarea>
</div>
      
      <!-- Equipment -->
      <div class="section">
        <h2>Equipment 
          <button onclick="showEquipmentPopup()" style="float: right; padding: 2px 6px; font-size: 0.8rem;">✎ Edit</button>
        </h2>
        <div id="equipment_preview">
          <!-- Equipment preview will be shown here -->
        </div>
      </div>
    </div>
    
    <!-- Conditions (swapped with Proficiencies & Training) -->
    <div class="section">
      <h2>Long Term Conditions 
        <button onclick="showConditionPopup()" style="float: right; padding: 2px 6px; font-size: 0.8rem;">+ Add</button>
      </h2>
      <div id="conditions_container">
        <!-- itions will be added here dynamically -->
      </div>
    </div>

    <!-- Quick Notes -->
    <div class="section">
      <h2>Quick Notes</h2>
      <textarea id="stats_quick_notes" class="basic-textarea" 
                oninput="autosave()" placeholder="Jot down quick notes here..."></textarea>
    </div>
  </div>
  
  <!-- Background Page -->
  <div class="page" id="page2">
    <div class="background-grid">
<div class="section resizable">
  <h2>Portrait</h2>
  <div class="portrait-container" id="portraitPreview">
    <span style="color: #666;">No image</span>
  </div>
  <input type="file" id="portraitUpload" accept="image/*" style="width: 100%; margin-bottom: 10px;"/>
  <button onclick="removePortrait()" style="width: 100%;">Remove Portrait</button>
</div>
      <!-- Updated Background Sections with Direct Textareas -->
      <div class="section">
        <h2>Backstory</h2>
        <textarea id="char_backstory" class="basic-textarea" 
                  oninput="autosave()" placeholder="Enter your character's backstory here..."></textarea>
      </div>
    </div>
    
    <div class="background-textareas">
      <div class="section">
        <h3>Personality Traits</h3>
        <textarea id="personality_traits" class="basic-textarea" 
                  oninput="autosave()" placeholder="Describe your character's personality traits..."></textarea>
      </div>
      
      <div class="section">
        <h3>Ideals</h3>
        <textarea id="traits_ideals" class="basic-textarea" 
                  oninput="autosave()" placeholder="What ideals drive your character?"></textarea>
      </div>
      
      <div class="section">
        <h3>Bonds</h3>
        <textarea id="traits_bonds" class="basic-textarea" 
                  oninput="autosave()" placeholder="What bonds tie your character to people, places, or events?"></textarea>
      </div>
      
      <div class="section">
        <h3>Flaws</h3>
        <textarea id="traits_flaws" class="basic-textarea" 
                  oninput="autosave()" placeholder="What flaws or weaknesses does your character have?"></textarea>
      </div>
      
      <div class="section">
        <h3>Allies & Organizations</h3>
        <textarea id="traits_allies" class="basic-textarea" 
                  oninput="autosave()" placeholder="List your character's allies and organizations they belong to..."></textarea>
      </div>
      
      <div class="section">
        <h3>Appearance</h3>
        <textarea id="traits_appearance" class="basic-textarea" 
                  oninput="autosave()" placeholder="Describe your character's physical appearance..."></textarea>
      </div>
    </div>
  </div>
  
  <!-- Spells Page -->
  <div class="page" id="page3">
    <div class="section">
      <h2>Spellbook</h2>
      <textarea id="spell_notes" class="basic-textarea" 
                oninput="autosave()" placeholder="Enter your spells and spellbook details here..."></textarea>
    </div>
  </div>
  
  <!-- Inventory Page -->
  <div class="page" id="page4">
    <!-- Equipment section first -->
    <div class="section">
      <h2>Equipment</h2>
      <table id="equipment_table_inventory">
        <thead>
          <tr>
            <th>Name</th>
            <th>Type</th>
            <th>Bonus</th>
            <th>Weight (lbs)</th>
            <th>Notes</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <!-- Equipment will be added here -->
        </tbody>
      </table>
      <button onclick="showEquipmentPopup()" style="margin-top: 10px;">+ Add Equipment</button>
      <div class="weight-display" id="equipment_weight_total">Total: 0 lbs / 0 kg</div>
    </div>
    
    <!-- Main inventory second -->
    <div class="section">
      <div class="inventory-controls">
        <h2>Inventory</h2>
        <div>
          Gold: <input id="gold_field" oninput="autosave()" style="width:100px;" type="number" value="0"/>
        </div>
      </div>
      
      <table id="inventory_table">
        <thead>
          <tr>
            <th>Item</th>
            <th>Description</th>
            <th>Notes</th>
            <th>Weight (lbs)</th>
            <th>Weight (kg)</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <!-- Inventory items will be added here -->
        </tbody>
      </table>
      <button onclick="showAddItemPopup()" style="margin-top: 10px;">+ Add Item</button>
      <div class="weight-display" id="inventory_weight_total">Total: 0 lbs / 0 kg</div>
    </div>
    
    <!-- Extra containers last -->
    <div id="extra_containers">
      <!-- Additional containers will be added here -->
    </div>
    
    <div class="section">
      <h3>Add New Storage</h3>
      <label>Container Name:</label>
      <input id="container_name" type="text" placeholder="e.g. Backpack, Bag of Holding"/>
      
      <label>Max Weight (lbs):</label>
      <input id="container_max_weight" type="number" placeholder="0 for unlimited"/>
      
      <button onclick="addExtraContainer()" style="margin-top: 10px;">+ Add Storage</button>
    </div>
  </div>
  
  <!-- Notes Page -->
  <div class="page" id="page6">
    <div class="section">
      <h2>General Notes</h2>
      <textarea id="general_notes" class="basic-textarea" 
                oninput="autosave()" placeholder="Enter general notes about your character or campaign..."></textarea>
    </div>
    
    <div class="section">
      <h2>Quest Log</h2>
      <textarea id="quest_log" class="basic-textarea" 
                oninput="autosave()" placeholder="Track your quests and objectives here..."></textarea>
    </div>
    
    <div class="section">
      <h2>NPC Notes</h2>
      <textarea id="npc_notes" class="basic-textarea" 
                oninput="autosave()" placeholder="Record information about NPCs you encounter..."></textarea>
    </div>
  </div>
</div>

<!-- Popups -->
<div class="popup-backdrop" id="popupBackdrop"></div>

<!-- HP Adjustment Popup -->
<div class="popup" id="hpPopup">
  <h3>Adjust HP</h3>
  <label>Amount:</label>
  <input type="number" id="hp_adjust_amount" value="1"/>
  <div style="margin-top: 15px; display: flex; justify-content: space-between;">
    <button onclick="adjustHP(1)">Add HP</button>
    <button onclick="adjustHP(-1)">Remove HP</button>
    <button onclick="closePopup('hpPopup')">Cancel</button>
  </div>
</div>

<!-- Condition Popup -->
<div class="popup" id="conditionPopup">
  <h3>Add Condition</h3>
  <label>Condition Name:</label>
  <input type="text" id="condition_name" placeholder="e.g. Poisoned"/>
  
  <label>Duration (turns):</label>
  <input type="number" id="condition_turns" placeholder="Leave blank for indefinite"/>
  
  <label>Effect:</label>
  <textarea id="condition_effect" placeholder="Describe the effect"></textarea>
  
  <label>Color:</label>
  <select id="condition_color">
    <option value="red">Red</option>
    <option value="blue">Blue</option>
    <option value="green">Green</option>
  </select>
  
  <div style="margin-top: 15px; display: flex; justify-content: space-between;">
    <button onclick="addCondition()">Add Condition</button>
    <button onclick="closePopup('conditionPopup')">Cancel</button>
  </div>
</div>

<!-- Notes Editor Popup -->
<div class="popup" id="notesPopup">
  <h3 id="notesPopupTitle">Edit Notes</h3>
  <textarea id="notesPopupTextarea" rows="12"></textarea>
  <input type="hidden" id="notesPopupTargetId"/>
  <div style="margin-top: 15px; display: flex; justify-content: space-between;">
    <button onclick="saveNotes()">Save</button>
    <button onclick="closePopup('notesPopup')">Cancel</button>
  </div>
</div>

<!-- Add Item Popup -->
<div class="popup" id="addItemPopup">
  <h3>Add Inventory Item</h3>
  <label>Item Name:</label>
  <input type="text" id="item_name" placeholder="e.g. Health Potion"/>
  
  <label>Description:</label>
  <input type="text" id="item_description" placeholder="Brief description"/>
  
  <label>Notes:</label>
  <textarea id="item_notes" placeholder="Any special notes" style="min-height: 100px;"></textarea>
  
  <label>Weight (lbs):</label>
  <input type="number" id="item_weight" step="0.1" placeholder="0.1"/>
  
  <label>Container:</label>
  <select id="item_container">
    <option value="main">Main Inventory</option>
    <!-- Additional containers will be added here dynamically -->
  </select>
  
  <div style="margin-top: 15px; display: flex; justify-content: space-between;">
    <button onclick="addInventoryItem()">Add Item</button>
    <button onclick="closePopup('addItemPopup')">Cancel</button>
  </div>
</div>

<!-- Weapons Editor Popup -->
<div class="popup" id="weaponsPopup">
  <h3>Edit Weapons</h3>
  <table id="weapons_table_popup" style="width: 100%;">
    <thead>
      <tr>
        <th>Weapon</th>
        <th>To Hit</th>
        <th>Dmg</th>
        <th>Bonus Dmg</th>
        <th>Notes</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <!-- Weapons will be added here -->
    </tbody>
  </table>
  <button onclick="addWeapon()" style="margin-top: 10px;">+ Add Weapon</button>
  <div style="margin-top: 15px; display: flex; justify-content: space-between;">
    <button onclick="updateWeaponsPreview(); closePopup('weaponsPopup')">Save</button>
    <button onclick="closePopup('weaponsPopup')">Cancel</button>
  </div>
</div>

<!-- Equipment Editor Popup -->
<div class="popup" id="equipmentPopup">
  <h3>Edit Equipment</h3>
  <table id="equipment_table_popup" style="width: 100%;">
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Bonus</th>
        <th>Weight (lbs)</th>
        <th>Notes</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <!-- Equipment will be added here -->
    </tbody>
  </table>
  <button onclick="addEquipment()" style="margin-top: 10px;">+ Add Equipment</button>
  <div style="margin-top: 15px; display: flex; justify-content: space-between;">
    <button onclick="updateEquipmentPreviews(); closePopup('equipmentPopup')">Save</button>
    <button onclick="closePopup('equipmentPopup')">Cancel</button>
  </div>
</div>

<!-- Item Details Popup -->
<div class="popup" id="itemDetailsPopup">
  <h3 id="itemDetailsTitle">Item Details</h3>
  <div id="itemDetailsContent"></div>
  <div style="margin-top: 15px;">
    <button onclick="closePopup('itemDetailsPopup')">Close</button>
  </div>
</div>

<!-- Script Section -->
<script>

// Auto-resize containers when textareas change
function setupAutoResize() {
  document.querySelectorAll('.section textarea').forEach(textarea => {
    textarea.addEventListener('input', function() {
      const section = this.closest('.section');
      if (this.scrollHeight > section.clientHeight) {
        section.style.height = `${this.scrollHeight + 30}px`; // Add some padding
      }
      if (this.scrollWidth > section.clientWidth) {
        section.style.width = `${this.scrollWidth + 30}px`;
      }
    });
  });
}

// Call this in your window.onload
window.onload = function() {
  // ... your existing load code ...
  setupAutoResize();
};
// Enable resizable containers
function makeContainersResizable() {
  document.querySelectorAll('.section').forEach(section => {
    section.classList.add('resizable-container');
    
    // Store initial size for reset functionality
    if (!section.dataset.originalWidth) {
      section.dataset.originalWidth = section.style.width || 'auto';
      section.dataset.originalHeight = section.style.height || 'auto';
    }
  });
}


// ========== GLOBAL VARIABLES ==========
let weaponsData = [];
let equipmentData = [];
let currentCharacter = null;
let deleteState = 0;

// ========== INITIALIZATION ==========
window.onload = function() {
  // Initialize character system
  loadCharacterList();
  
  // Try to load last used character or first in list
  const characters = JSON.parse(localStorage.getItem('dndCharacters')) || [];
  if (characters.length > 0) {
    currentCharacter = characters[0].id;
    loadData();
    document.querySelector('.tab[data-tab="page1"]').click(); // Start on Stats page
  } else {
    // Show home page if no characters exist
    showHomePage();
  }
  
  // Initialize portrait functionality
  document.getElementById('portraitUpload').addEventListener('change', handlePortraitUpload);
  document.getElementById('portraitPreview').addEventListener('click', function() {
    document.getElementById('portraitUpload').click();
  });
  
  // Initialize weapons and equipment if empty
  if (weaponsData.length === 0) {
    weaponsData.push({ name: '', toHit: '', damage: '', bonusDamage: '', notes: '' });
    updateWeaponsPreview();
  }
  
  if (equipmentData.length === 0) {
    equipmentData.push({ name: '', type: '', bonus: '', weight: 0, notes: '' });
    updateEquipmentPreviews();
  }
  
  // Update weights
  updateWeight();
  document.querySelectorAll('#extra_containers .section').forEach(container => {
    updateContainerWeight(container.id);
  });

  // Enable resizing
  makeContainersResizable();
  loadLayout(); // This should come after all elements are created

};

// ========== CHARACTER MANAGEMENT ==========
function showHomePage() {
  document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
  document.getElementById('home').classList.add('active');
  document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
}

function createNewCharacter() {
  const charName = document.getElementById('newCharName').value.trim();
  if (!charName) {
    alert("Please enter a character name");
    return;
  }
  
  const newChar = {
    id: Date.now().toString(),
    name: charName,
    data: {
      characterInfo: { name: charName },
      page1: {},
      page2: {},
      page3: {},
      page4: {},
      page6: {},
      weapons: [],
      equipment: []
    }
  };
  
  let characters = JSON.parse(localStorage.getItem('dndCharacters')) || [];
  characters.push(newChar);
  localStorage.setItem('dndCharacters', JSON.stringify(characters));
  
  currentCharacter = newChar.id;
  loadCharacterList();
  loadData();
  document.querySelector('.tab[data-tab="page1"]').click();
  document.getElementById('newCharName').value = '';
}

function loadCharacterList() {
  const characters = JSON.parse(localStorage.getItem('dndCharacters')) || [];
  const select = document.getElementById('characterList');
  select.innerHTML = '';
  
  if (characters.length === 0) {
    const option = document.createElement('option');
    option.textContent = "No characters found";
    select.appendChild(option);
    select.disabled = true;
    return;
  }
  
  select.disabled = false;
  characters.forEach(char => {
    const option = document.createElement('option');
    option.value = char.id;
    option.textContent = char.name;
    if (char.id === currentCharacter) option.selected = true;
    select.appendChild(option);
  });
}

function loadSelectedCharacter() {
  const select = document.getElementById('characterList');
  const charId = select.value;
  if (!charId) return;
  
  currentCharacter = charId;
  loadData();
  document.querySelector('.tab[data-tab="page1"]').click();
}

function initiateDelete() {
  const btn = document.getElementById('deleteBtn');
  const input = document.getElementById('deleteConfirmInput');
  const count = document.getElementById('deleteCharCount');
  
  deleteState++;
  
  if (deleteState === 1) {
    const charName = document.getElementById('char_name').value || 'Character';
    btn.textContent = `Delete ${charName}?`;
    btn.classList.add('warning');
  } else if (deleteState === 2) {
    btn.textContent = 'CONFIRM DELETE!';
    btn.classList.remove('warning');
    btn.classList.add('danger');
  } else if (deleteState === 3) {
    btn.textContent = 'DELETE FOREVER';
    input.style.display = 'block';
    count.style.display = 'inline';
    input.focus();
    
    input.oninput = function() {
      count.textContent = `${input.value.length}/6`;
      btn.disabled = input.value !== 'DELETE';
    };
  } else if (deleteState === 4 && input.value === 'DELETE') {
    const charName = document.getElementById('char_name').value || 'character';
    const characters = JSON.parse(localStorage.getItem('dndCharacters')) || [];
    const updatedChars = characters.filter(char => char.id !== currentCharacter);
    
    localStorage.setItem('dndCharacters', JSON.stringify(updatedChars));
    resetDeleteUI();
    loadCharacterList();
    alert(`${charName} deleted permanently`);
    
    if (updatedChars.length > 0) {
      currentCharacter = updatedChars[0].id;
      loadData();
      document.querySelector('.tab[data-tab="page1"]').click();
    } else {
      currentCharacter = null;
      showHomePage();
    }
  }
}

function resetDeleteUI() {
  const btn = document.getElementById('deleteBtn');
  const input = document.getElementById('deleteConfirmInput');
  const count = document.getElementById('deleteCharCount');
  
  deleteState = 0;
  btn.textContent = 'Delete Character';
  btn.classList.remove('warning', 'danger');
  btn.disabled = false;
  input.style.display = 'none';
  input.value = '';
  count.style.display = 'none';
}

// ========== EXISTING FUNCTIONALITY (UPDATED FOR CHARACTER SYSTEM) ==========
function autosave() {
  if (!currentCharacter) return;
  
  const characters = JSON.parse(localStorage.getItem('dndCharacters')) || [];
  const charIndex = characters.findIndex(char => char.id === currentCharacter);
  if (charIndex === -1) return;
  
  const data = {
    characterInfo: {
      name: document.getElementById('char_name').value,
      race: document.getElementById('char_race').value,
      class: document.getElementById('char_class').value,
      subclass: document.getElementById('char_subclass').value,
      level: document.getElementById('char_level').value
    },
    actionTracker: {
      actions: document.getElementById('action_counter').value,
      actionUsed: document.getElementById('action_tick').checked,
      bonusActions: document.getElementById('bonus_action_counter').value,
      bonusActionUsed: document.getElementById('bonus_action_tick').checked
    },
    page1: {
      abilities: ['str','dex','con','int','wis','cha'].reduce((obj,ability) => {
        obj[ability] = document.getElementById(ability).value;
        obj[`${ability}_bonus`] = document.getElementById(`${ability}_bonus`).value;
        return obj;
      }, {}),
      combatStats: {
        ac: document.getElementById('ac').value,
        initiative: document.getElementById('initiative').value,
        speed: document.getElementById('speed').value,
        prof_bonus: document.getElementById('prof_bonus').value
      },
      health: {
        max_hp: document.getElementById('max_hp').value,
        curr_hp: document.getElementById('curr_hp').value
      },
      skills: ['acrobatics','animal_handling','arcana','athletics','deception','history',
               'insight','intimidation','investigation','medicine','nature','perception',
               'performance','persuasion','religion','sleight_of_hand','stealth','survival']
               .reduce((obj,skill) => {
        obj[`prof_${skill}`] = document.getElementById(`prof_${skill}`).checked;
        obj[`bonus_${skill}`] = document.getElementById(`bonus_${skill}`).value;
        return obj;
      }, {}),
      deathSaves: {
        success: [
          document.getElementById('death_save_success_1').checked,
          document.getElementById('death_save_success_2').checked,
          document.getElementById('death_save_success_3').checked
        ],
        failure: [
          document.getElementById('death_save_failure_1').checked,
          document.getElementById('death_save_failure_2').checked,
          document.getElementById('death_save_failure_3').checked
        ]
      },
      actionsFeatures: document.getElementById('actions_features').value,
      proficienciesTraining: document.getElementById('proficiencies_training').value,
      statsQuickNotes: document.getElementById('stats_quick_notes').value
    },
    page2: {
      portrait: document.getElementById('portraitPreview').querySelector('img')?.src || null,
      backstory: document.getElementById('char_backstory').value,
      traits: {
        personality: document.getElementById('personality_traits').value,
        ideals: document.getElementById('traits_ideals').value,
        bonds: document.getElementById('traits_bonds').value,
        flaws: document.getElementById('traits_flaws').value,
        allies: document.getElementById('traits_allies').value,
        appearance: document.getElementById('traits_appearance').value
      }
    },
    page3: {
      spellNotes: document.getElementById('spell_notes').value
    },
    page4: {
      gold: document.getElementById('gold_field').value,
      equipment: equipmentData,
      inventory: Array.from(document.querySelectorAll('#inventory_table tbody tr')).map(row => ({
        name: row.cells[0].textContent,
        description: row.cells[1].textContent,
        notes: row.cells[2].textContent,
        weight: parseFloat(row.cells[3].textContent) || 0
      })),
      containers: Array.from(document.querySelectorAll('#extra_containers .section')).map(container => ({
        name: container.querySelector('h3').textContent,
        maxWeight: container.querySelector('div').textContent.includes('Max Weight') ? 
                   parseInt(container.querySelector('div').textContent.match(/\d+/)[0]) : 0,
        items: Array.from(container.querySelectorAll('tbody tr')).map(row => ({
          name: row.cells[0].textContent,
          description: row.cells[1].textContent,
          notes: row.cells[2].textContent,
          weight: parseFloat(row.cells[3].textContent) || 0
        }))
      }))
    },
    page6: {
      generalNotes: document.getElementById('general_notes').value,
      questLog: document.getElementById('quest_log').value,
      npcNotes: document.getElementById('npc_notes').value
    },
    weapons: weaponsData,
    conditions: Array.from(document.querySelectorAll('#conditions_container .condition')).map(condition => ({
      name: condition.querySelector('.condition-header').children[0].textContent,
      turns: condition.querySelector('.condition-header').children[1].textContent,
      effect: condition.children[1].textContent,
      color: condition.classList.contains('blue') ? 'blue' : 
             condition.classList.contains('green') ? 'green' : 'red'
    }))
  };
  
  characters[charIndex].data = data;
  characters[charIndex].name = document.getElementById('char_name').value || 'Unnamed';
  localStorage.setItem('dndCharacters', JSON.stringify(characters));
}

function loadData() {
  if (!currentCharacter) return;
  
  const characters = JSON.parse(localStorage.getItem('dndCharacters')) || [];
  const character = characters.find(char => char.id === currentCharacter);
  if (!character) return;
  
  const data = character.data;
  
  // Character Info
  if (data.characterInfo) {
    document.getElementById('char_name').value = data.characterInfo.name || '';
    document.getElementById('char_race').value = data.characterInfo.race || '';
    document.getElementById('char_class').value = data.characterInfo.class || '';
    document.getElementById('char_subclass').value = data.characterInfo.subclass || '';
    document.getElementById('char_level').value = data.characterInfo.level || '';
  }

  // Action Tracker
  if (data.actionTracker) {
    document.getElementById('action_counter').value = data.actionTracker.actions || 0;
    document.getElementById('action_tick').checked = data.actionTracker.actionUsed || false;
    document.getElementById('bonus_action_counter').value = data.actionTracker.bonusActions || 0;
    document.getElementById('bonus_action_tick').checked = data.actionTracker.bonusActionUsed || false;
  }

  // Page 1: Stats
  if (data.page1) {
    // Abilities
    for (const ability in data.page1.abilities) {
      const element = document.getElementById(ability);
      if (element) element.value = data.page1.abilities[ability];
    }
    
    // Combat Stats
    if (data.page1.combatStats) {
      document.getElementById('ac').value = data.page1.combatStats.ac || '';
      document.getElementById('initiative').value = data.page1.combatStats.initiative || '';
      document.getElementById('speed').value = data.page1.combatStats.speed || '';
      document.getElementById('prof_bonus').value = data.page1.combatStats.prof_bonus || '';
    }
    
    // Health
    if (data.page1.health) {
      document.getElementById('max_hp').value = data.page1.health.max_hp || '';
      document.getElementById('curr_hp').value = data.page1.health.curr_hp || '';
    }
    
    // Skills
    if (data.page1.skills) {
      for (const skill in data.page1.skills) {
        if (skill.startsWith('prof_')) {
          const checkbox = document.getElementById(skill);
          if (checkbox) checkbox.checked = data.page1.skills[skill];
        } else if (skill.startsWith('bonus_')) {
          const input = document.getElementById(skill);
          if (input) input.value = data.page1.skills[skill];
        }
      }
    }
    
    // Death Saves
    if (data.page1.deathSaves) {
      for (let i = 0; i < 3; i++) {
        if (data.page1.deathSaves.success[i]) {
          document.getElementById(`death_save_success_${i+1}`).checked = true;
        }
        if (data.page1.deathSaves.failure[i]) {
          document.getElementById(`death_save_failure_${i+1}`).checked = true;
        }
      }
    }
    
    // Actions & Features
    if (data.page1.actionsFeatures) {
      document.getElementById('actions_features').value = data.page1.actionsFeatures;
    }
    
    // Proficiencies & Training
    if (data.page1.proficienciesTraining) {
      document.getElementById('proficiencies_training').value = data.page1.proficienciesTraining;
    }
    
    // Quick Notes
    if (data.page1.statsQuickNotes) {
      document.getElementById('stats_quick_notes').value = data.page1.statsQuickNotes;
    }
  }
  
  // Page 2: Background
  if (data.page2) {
    // Portrait
    if (data.page2.portrait) {
      const img = document.createElement('img');
      img.src = data.page2.portrait;
      img.style.maxWidth = '100%';
      img.style.maxHeight = '100%';
      document.getElementById('portraitPreview').innerHTML = '';
      document.getElementById('portraitPreview').appendChild(img);
    }
    
    // Backstory
    if (data.page2.backstory) {
      document.getElementById('char_backstory').value = data.page2.backstory;
    }
    
    // Traits
    if (data.page2.traits) {
      document.getElementById('personality_traits').value = data.page2.traits.personality || '';
      document.getElementById('traits_ideals').value = data.page2.traits.ideals || '';
      document.getElementById('traits_bonds').value = data.page2.traits.bonds || '';
      document.getElementById('traits_flaws').value = data.page2.traits.flaws || '';
      document.getElementById('traits_allies').value = data.page2.traits.allies || '';
      document.getElementById('traits_appearance').value = data.page2.traits.appearance || '';
    }
  }
  
  // Page 3: Spells
  if (data.page3 && data.page3.spellNotes) {
    document.getElementById('spell_notes').value = data.page3.spellNotes;
  }
  
  // Page 4: Inventory
  if (data.page4) {
    // Gold
    if (data.page4.gold) {
      document.getElementById('gold_field').value = data.page4.gold;
    }
    
    // Equipment
    if (data.page4.equipment) {
      equipmentData = data.page4.equipment;
      updateEquipmentPreviews();
    }
    
    // Main Inventory
    if (data.page4.inventory) {
      const tbody = document.getElementById('inventory_table').querySelector('tbody');
      tbody.innerHTML = '';
      
      data.page4.inventory.forEach(item => {
        const row = tbody.insertRow();
        row.className = 'item-row';
        row.innerHTML = `
          <td>${item.name || ''}</td>
          <td>${item.description || ''}</td>
          <td class="table-notes">${item.notes || ''}</td>
          <td>${item.weight || 0}</td>
          <td>${(item.weight * 0.453592).toFixed(2)}</td>
          <td><button onclick="this.closest('tr').remove(); updateWeight(); autosave()">Remove</button></td>
        `;
        row.onclick = () => showItemDetails(item, 'inventory');
      });
      
      updateWeight();
    }
    
    // Containers
    if (data.page4.containers) {
      const extraContainers = document.getElementById('extra_containers');
      extraContainers.innerHTML = '';
      const containerDropdown = document.getElementById('item_container');
      
      while (containerDropdown.children.length > 1) {
        containerDropdown.removeChild(containerDropdown.lastChild);
      }
      
      data.page4.containers.forEach(containerData => {
        const containerId = 'container_' + Date.now();
        const containerHTML = `
          <div class="section" id="${containerId}">
            <div class="inventory-controls">
              <h3>${containerData.name}</h3>
              ${containerData.maxWeight > 0 ? `<div>Max Weight: ${containerData.maxWeight} lbs</div>` : ''}
              <button class="delete-container-btn" onclick="confirmContainerDeletion('${containerId}')">Delete Container</button>
            </div>
            <table>
              <thead>
                <tr>
                  <th>Item</th>
                  <th>Description</th>
                  <th>Notes</th>
                  <th>Weight (lbs)</th>
                  <th>Weight (kg)</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                ${containerData.items.map(item => `
                  <tr class="item-row">
                    <td>${item.name || ''}</td>
                    <td>${item.description || ''}</td>
                    <td class="table-notes">${item.notes || ''}</td>
                    <td>${item.weight || 0}</td>
                    <td>${(item.weight * 0.453592).toFixed(2)}</td>
                    <td><button onclick="this.closest('tr').remove(); updateContainerWeight('${containerId}'); autosave()">Remove</button></td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
            <button onclick="showAddContainerItemPopup('${containerId}')" style="margin-top: 10px;">+ Add Item</button>
            <div class="weight-display">Current: ${containerData.items.reduce((sum, item) => sum + (parseFloat(item.weight) || 0), 0).toFixed(1)} lbs / 
              ${(containerData.items.reduce((sum, item) => sum + (parseFloat(item.weight) || 0), 0) * 0.453592).toFixed(1)} kg</div>
          </div>
        `;
        
        extraContainers.insertAdjacentHTML('beforeend', containerHTML);
        
        containerData.items.forEach(item => {
          const rows = document.querySelectorAll(`#${containerId} tbody tr`);
          rows.forEach(row => {
            if (row.cells[0].textContent === item.name) {
              row.onclick = () => showItemDetails(item, 'inventory');
            }
          });
        });
        
        const option = document.createElement('option');
        option.value = containerId;
        option.textContent = containerData.name;
        containerDropdown.appendChild(option);
      });
    }
  }
  
  // Page 6: Notes
  if (data.page6) {
    if (data.page6.generalNotes) {
      document.getElementById('general_notes').value = data.page6.generalNotes;
    }
    if (data.page6.questLog) {
      document.getElementById('quest_log').value = data.page6.questLog;
    }
    if (data.page6.npcNotes) {
      document.getElementById('npc_notes').value = data.page6.npcNotes;
    }
  }
  
  // Weapons
  if (data.weapons) {
    weaponsData = data.weapons;
    updateWeaponsPreview();
  }
  
  // Conditions
  if (data.conditions) {
    const container = document.getElementById('conditions_container');
    container.innerHTML = '';
    
    data.conditions.forEach(condition => {
      const conditionId = Date.now();
      const conditionHTML = `
        <div class="condition ${condition.color}" id="condition_${conditionId}">
          <div class="condition-header">
            <span>${condition.name}</span>
            <span class="condition-turns">${condition.turns}</span>
          </div>
          <div>${condition.effect}</div>
          <button onclick="removeCondition('${conditionId}')" style="float:right; padding:2px 5px; margin-top:5px;">Remove</button>
        </div>
      `;
      
      container.insertAdjacentHTML('beforeend', conditionHTML);
    });
  }
}

// ========== EXISTING FUNCTIONS (UPDATED) ==========
function exportData() {
  if (!currentCharacter) {
    alert("No character loaded to export");
    return;
  }
  
  const characters = JSON.parse(localStorage.getItem('dndCharacters')) || [];
  const character = characters.find(char => char.id === currentCharacter);
  
  if (!character) return;
  
  const blob = new Blob([JSON.stringify(character.data)], {type: 'application/json'});
  const url = URL.createObjectURL(blob);
  
  const a = document.createElement('a');
  a.href = url;
  a.download = `${character.name || 'dnd_character'}_backup.json`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

function importData(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const importedData = JSON.parse(e.target.result);
      const charName = importedData.characterInfo?.name || 'Imported Character';
      
      const newChar = {
        id: Date.now().toString(),
        name: charName,
        data: importedData
      };
      
      let characters = JSON.parse(localStorage.getItem('dndCharacters')) || [];
      characters.push(newChar);
      localStorage.setItem('dndCharacters', JSON.stringify(characters));
      
      currentCharacter = newChar.id;
      loadCharacterList();
      loadData();
      
      alert(`Character "${charName}" imported successfully!`);
      document.querySelector('.tab[data-tab="page1"]').click();
    } catch (err) {
      alert("Error importing file: " + err.message);
    }
    event.target.value = '';
  };
  reader.readAsText(file);
}

// ========== WEAPONS SYSTEM ==========
function showWeaponsPopup() {
  const tbody = document.getElementById('weapons_table_popup').querySelector('tbody');
  tbody.innerHTML = '';
  
  weaponsData.forEach((weapon, index) => {
    const row = tbody.insertRow();
    row.innerHTML = `
      <td><input type="text" value="${weapon.name || ''}" oninput="weaponsData[${index}].name = this.value"></td>
      <td><input type="text" value="${weapon.toHit || ''}" oninput="weaponsData[${index}].toHit = this.value"></td>
      <td><input type="text" value="${weapon.damage || ''}" oninput="weaponsData[${index}].damage = this.value"></td>
      <td><input type="text" value="${weapon.bonusDamage || ''}" oninput="weaponsData[${index}].bonusDamage = this.value"></td>
      <td><textarea class="table-notes" oninput="weaponsData[${index}].notes = this.value">${weapon.notes || ''}</textarea></td>
      <td><button onclick="weaponsData.splice(${index}, 1); showWeaponsPopup()">Remove</button></td>
    `;
  });
  
  showPopup('weaponsPopup');
}

function addWeapon() {
  weaponsData.push({ name: '', toHit: '', damage: '', bonusDamage: '', notes: '' });
  showWeaponsPopup();
}

function updateWeaponsPreview() {
  const preview = document.getElementById('weapons_preview');
  preview.innerHTML = '';
  
  if (weaponsData.length === 0) {
    preview.innerHTML = '<p>No weapons added</p>';
    return;
  }
  
  const table = document.createElement('table');
  const header = table.createTHead();
  const headerRow = header.insertRow();
  headerRow.innerHTML = '<th>Weapon</th><th>To Hit</th><th>Dmg</th>';
  
  const body = table.createTBody();
  weaponsData.forEach(weapon => {
    const row = body.insertRow();
    row.className = 'item-row';
    row.innerHTML = `
      <td>${weapon.name || '-'}</td>
      <td>${weapon.toHit || '-'}</td>
      <td>${weapon.damage || '-'}</td>
    `;
    row.onclick = () => showItemDetails(weapon, 'weapon');
  });
  
  preview.appendChild(table);
  autosave();
}

// ========== EQUIPMENT SYSTEM ==========
function showEquipmentPopup() {
  const tbody = document.getElementById('equipment_table_popup').querySelector('tbody');
  tbody.innerHTML = '';
  
  equipmentData.forEach((item, index) => {
    const row = tbody.insertRow();
    row.innerHTML = `
      <td><input type="text" value="${item.name || ''}" oninput="equipmentData[${index}].name = this.value"></td>
      <td><input type="text" value="${item.type || ''}" oninput="equipmentData[${index}].type = this.value"></td>
      <td><input type="text" value="${item.bonus || ''}" oninput="equipmentData[${index}].bonus = this.value"></td>
      <td><input type="number" value="${item.weight || 0}" step="0.1" oninput="equipmentData[${index}].weight = parseFloat(this.value) || 0"></td>
      <td><textarea class="table-notes" oninput="equipmentData[${index}].notes = this.value">${item.notes || ''}</textarea></td>
      <td><button onclick="equipmentData.splice(${index}, 1); updateEquipmentPreviews()">Remove</button></td>
    `;
  });
  
  showPopup('equipmentPopup');
}

function addEquipment() {
  equipmentData.push({ name: '', type: '', bonus: '', weight: 0, notes: '' });
  showEquipmentPopup();
}

function updateEquipmentPreviews() {
  const preview = document.getElementById('equipment_preview');
  preview.innerHTML = '';
  
  if (equipmentData.length === 0) {
    preview.innerHTML = '<p>No equipment added</p>';
    return;
  }
  
  const table = document.createElement('table');
  const header = table.createTHead();
  const headerRow = header.insertRow();
  headerRow.innerHTML = '<th>Name</th><th>Type</th><th>Bonus</th>';
  
  const body = table.createTBody();
  equipmentData.forEach(item => {
    const row = body.insertRow();
    row.className = 'item-row';
    row.innerHTML = `
      <td>${item.name || '-'}</td>
      <td>${item.type || '-'}</td>
      <td>${item.bonus || '-'}</td>
    `;
    row.onclick = () => showItemDetails(item, 'equipment');
  });
  
  preview.appendChild(table);
  
  const inventoryTbody = document.getElementById('equipment_table_inventory').querySelector('tbody');
  inventoryTbody.innerHTML = '';
  
  equipmentData.forEach((item, index) => {
    const row = inventoryTbody.insertRow();
    row.className = 'item-row';
    row.innerHTML = `
      <td>${item.name || ''}</td>
      <td>${item.type || ''}</td>
      <td>${item.bonus || ''}</td>
      <td>${item.weight || 0}</td>
      <td class="table-notes">${item.notes || ''}</td>
      <td><button onclick="equipmentData.splice(${index}, 1); updateEquipmentPreviews(); updateEquipmentWeight()">Remove</button></td>
    `;
    row.onclick = () => showItemDetails(item, 'equipment');
  });
  
  updateEquipmentWeight();
  autosave();
}

function updateEquipmentWeight() {
  let totalWeight = equipmentData.reduce((sum, item) => sum + (parseFloat(item.weight) || 0), 0);
  document.getElementById('equipment_weight_total').textContent = 
    `Total: ${totalWeight.toFixed(1)} lbs / ${(totalWeight * 0.453592).toFixed(1)} kg`;
}

// ========== INVENTORY FUNCTIONS ==========
function showAddItemPopup() {
  document.getElementById('item_name').value = '';
  document.getElementById('item_description').value = '';
  document.getElementById('item_notes').value = '';
  document.getElementById('item_weight').value = '';
  
  const containerDropdown = document.getElementById('item_container');
  containerDropdown.innerHTML = '<option value="main">Main Inventory</option>';
  
  document.querySelectorAll('#extra_containers .section').forEach(container => {
    const option = document.createElement('option');
    option.value = container.id;
    option.textContent = container.querySelector('h3').textContent;
    containerDropdown.appendChild(option);
  });
  
  showPopup('addItemPopup');
}

function addInventoryItem() {
  const name = document.getElementById('item_name').value;
  const description = document.getElementById('item_description').value;
  const notes = document.getElementById('item_notes').value;
  const weight = parseFloat(document.getElementById('item_weight').value) || 0;
  const containerId = document.getElementById('item_container').value;

  if (!name) {
    alert("Please enter an item name");
    return;
  }

  const item = {
    name,
    description,
    notes,
    weight
  };

  if (containerId === 'main') {
    const tbody = document.getElementById('inventory_table').querySelector('tbody');
    const row = tbody.insertRow();
    row.className = 'item-row';
    row.innerHTML = `
      <td>${name}</td>
      <td>${description}</td>
      <td class="table-notes">${notes}</td>
      <td>${weight}</td>
      <td>${(weight * 0.453592).toFixed(2)}</td>
      <td><button onclick="this.closest('tr').remove(); updateWeight(); autosave()">Remove</button></td>
    `;
    row.onclick = () => showItemDetails(item, 'inventory');
    updateWeight();
  } else {
    const container = document.getElementById(containerId);
    if (container) {
      const tbody = container.querySelector('tbody');
      const row = tbody.insertRow();
      row.className = 'item-row';
      row.innerHTML = `
        <td>${name}</td>
        <td>${description}</td>
        <td class="table-notes">${notes}</td>
        <td>${weight}</td>
        <td>${(weight * 0.453592).toFixed(2)}</td>
        <td><button onclick="this.closest('tr').remove(); updateContainerWeight('${containerId}'); autosave()">Remove</button></td>
      `;
      row.onclick = () => showItemDetails(item, 'inventory');
      updateContainerWeight(containerId);
    }
  }

  closePopup('addItemPopup');
  autosave();
}

function addExtraContainer() {
  const containerName = document.getElementById('container_name').value;
  const maxWeight = document.getElementById('container_max_weight').value;
  
  if (!containerName) {
    alert("Please enter a container name");
    return;
  }
  
  const containerId = 'container_' + Date.now();
  
  const containerHTML = `
    <div class="section" id="${containerId}">
      <div class="inventory-controls">
        <h3>${containerName}</h3>
        ${maxWeight > 0 ? `<div>Max Weight: ${maxWeight} lbs</div>` : ''}
        <button class="delete-container-btn" onclick="confirmContainerDeletion('${containerId}')">Delete Container</button>
      </div>
      <table>
        <thead>
          <tr>
            <th>Item</th>
            <th>Description</th>
            <th>Notes</th>
            <th>Weight (lbs)</th>
            <th>Weight (kg)</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
        </tbody>
      </table>
      <button onclick="showAddContainerItemPopup('${containerId}')" style="margin-top: 10px;">+ Add Item</button>
      <div class="weight-display">Current: 0 lbs / 0 kg</div>
    </div>
  `;
  
  document.getElementById('extra_containers').insertAdjacentHTML('beforeend', containerHTML);
  
  const containerDropdown = document.getElementById('item_container');
  const option = document.createElement('option');
  option.value = containerId;
  option.textContent = containerName;
  containerDropdown.appendChild(option);
  
  document.getElementById('container_name').value = '';
  document.getElementById('container_max_weight').value = '';
  
  autosave();
}

function confirmContainerDeletion(containerId) {
  const container = document.getElementById(containerId);
  const deleteBtn = container.querySelector('.delete-container-btn');
  
  if (deleteBtn.classList.contains('confirm')) {
    const containerDropdown = document.getElementById('item_container');
    const option = containerDropdown.querySelector(`option[value="${containerId}"]`);
    if (option) containerDropdown.removeChild(option);
    
    container.remove();
    autosave();
  } else {
    deleteBtn.textContent = 'Confirm Delete';
    deleteBtn.classList.add('confirm');
    setTimeout(() => {
      if (deleteBtn) {
        deleteBtn.textContent = 'Delete Container';
        deleteBtn.classList.remove('confirm');
      }
    }, 3000);
  }
}

function showAddContainerItemPopup(containerId) {
  document.getElementById('item_container').value = containerId;
  showAddItemPopup();
}

// ========== WEIGHT CALCULATION FUNCTIONS ==========
function updateWeight() {
  let totalWeight = 0;
  const rows = document.querySelectorAll('#inventory_table tbody tr');
  
  rows.forEach(row => {
    const weightCell = row.cells[3];
    totalWeight += parseFloat(weightCell.textContent) || 0;
  });
  
  document.getElementById('inventory_weight_total').textContent = 
    `Total: ${totalWeight.toFixed(1)} lbs / ${(totalWeight * 0.453592).toFixed(1)} kg`;
}

function updateContainerWeight(containerId) {
  const container = document.getElementById(containerId);
  if (!container) return;
  
  let totalWeight = 0;
  const rows = container.querySelectorAll('tbody tr');
  
  rows.forEach(row => {
    const weightCell = row.cells[3];
    totalWeight += parseFloat(weightCell.textContent) || 0;
  });
  
  const weightDisplay = container.querySelector('.weight-display');
  if (weightDisplay) {
    weightDisplay.textContent = 
      `Current: ${totalWeight.toFixed(1)} lbs / ${(totalWeight * 0.453592).toFixed(1)} kg`;
    
    const maxWeightText = container.querySelector('.inventory-controls div');
    if (maxWeightText && maxWeightText.textContent.includes('Max Weight')) {
      const maxWeight = parseFloat(maxWeightText.textContent.match(/[\d.]+/)[0]);
      if (maxWeight > 0 && totalWeight > maxWeight) {
        weightDisplay.classList.add('overweight');
      } else {
        weightDisplay.classList.remove('overweight');
      }
    }
  }
  autosave();
}

// ========== PORTRAIT FUNCTIONS ==========
function handlePortraitUpload(event) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function(e) {
    const portraitPreview = document.getElementById('portraitPreview');
    portraitPreview.innerHTML = '';
    const img = document.createElement('img');
    img.src = e.target.result;
    img.style.maxWidth = '100%';
    img.style.maxHeight = '100%';
    portraitPreview.appendChild(img);
    autosave();
  };
  reader.readAsDataURL(file);
}

function removePortrait() {
  const portraitPreview = document.getElementById('portraitPreview');
  portraitPreview.innerHTML = '<span style="color: #666;">No image</span>';
  document.getElementById('portraitUpload').value = '';
  autosave();
}

// ========== POPUP FUNCTIONS ==========
function showPopup(id) {
  const popup = document.getElementById(id);
  if (!popup) return;
  
  // Reset positioning
  popup.style.top = '50%';
  popup.style.left = '50%';
  popup.style.transform = 'translate(-50%, -50%)';
  
  // Mobile adjustments
  if (window.innerWidth <= 768) {
    popup.style.width = '95vw';
    popup.style.maxHeight = '85vh';
  }
  
  popup.style.display = 'block';
  document.getElementById('popupBackdrop').style.display = 'block';
}

function closePopup(id) {
  document.getElementById(id).style.display = 'none';
  document.getElementById('popupBackdrop').style.display = 'none';
}

function closeAllPopups() {
  document.querySelectorAll('.popup').forEach(popup => {
    popup.style.display = 'none';
  });
  document.getElementById('popupBackdrop').style.display = 'none';
}

// Initialize backdrop click handler
document.getElementById('popupBackdrop').addEventListener('click', closeAllPopups);

// ========== TAB SYSTEM ==========
function switchTab(button) {
  document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
  document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
  
  button.classList.add('active');
  const tabId = button.getAttribute('data-tab');
  document.getElementById(tabId).classList.add('active');
}

// ========== HEALTH SYSTEM ==========
function adjustHP(amount) {
  const currHP = document.getElementById('curr_hp');
  let newHP = parseInt(currHP.value) + amount;
  if (isNaN(newHP)) newHP = 0;
  currHP.value = Math.max(0, newHP);
  autosave();
}

function showHPPopup() {
  document.getElementById('hp_adjust_amount').value = 1;
  showPopup('hpPopup');
}

function longRest() {
  const currHP = document.getElementById('curr_hp');
  const maxHP = document.getElementById('max_hp');
  currHP.value = maxHP.value;
  
  for (let i = 1; i <= 3; i++) {
    document.getElementById(`death_save_success_${i}`).checked = false;
    document.getElementById(`death_save_failure_${i}`).checked = false;
  }
  
  autosave();
  alert("Long rest completed - HP restored, death saves reset");
}

// ========== CONDITIONS SYSTEM ==========
function showConditionPopup() {
  document.getElementById('condition_name').value = '';
  document.getElementById('condition_turns').value = '';
  document.getElementById('condition_effect').value = '';
  document.getElementById('condition_color').value = 'red';
  showPopup('conditionPopup');
}

function addCondition() {
  const name = document.getElementById('condition_name').value;
  const turns = document.getElementById('condition_turns').value;
  const effect = document.getElementById('condition_effect').value;
  const color = document.getElementById('condition_color').value;
  
  if (!name) {
    alert("Please enter a condition name");
    return;
  }
  
  const conditionId = Date.now();
  const conditionHTML = `
    <div class="condition ${color}" id="condition_${conditionId}">
      <div class="condition-header">
        <span>${name}</span>
        <span class="condition-turns">${turns ? turns + ' turns' : 'Indefinite'}</span>
      </div>
      <div>${effect}</div>
      <button onclick="removeCondition('${conditionId}')" style="float:right; padding:2px 5px; margin-top:5px;">Remove</button>
    </div>
  `;
  
  document.getElementById('conditions_container').insertAdjacentHTML('beforeend', conditionHTML);
  closePopup('conditionPopup');
  autosave();
}

function removeCondition(id) {
  document.getElementById(`condition_${id}`).remove();
  autosave();
}

// ========== ITEM DETAILS ==========
function showItemDetails(item, type) {
  document.getElementById('itemDetailsTitle').textContent = item.name || 'Unnamed Item';
  
  let content = '';
  if (type === 'weapon') {
    content = `
      <p><strong>To Hit:</strong> ${item.toHit || '-'}</p>
      <p><strong>Damage:</strong> ${item.damage || '-'}</p>
      <p><strong>Bonus Damage:</strong> ${item.bonusDamage || '-'}</p>
      <p><strong>Notes:</strong> ${item.notes || '-'}</p>
    `;
  } else if (type === 'equipment') {
    content = `
      <p><strong>Type:</strong> ${item.type || '-'}</p>
      <p><strong>Bonus:</strong> ${item.bonus || '-'}</p>
      <p><strong>Weight:</strong> ${item.weight || 0} lbs (${(item.weight * 0.453592).toFixed(2)} kg)</p>
      <p><strong>Notes:</strong> ${item.notes || '-'}</p>
    `;
  } else if (type === 'inventory') {
    content = `
      <p><strong>Description:</strong> ${item.description || '-'}</p>
      <p><strong>Weight:</strong> ${item.weight || 0} lbs (${(item.weight * 0.453592).toFixed(2)} kg)</p>
      <p><strong>Notes:</strong> ${item.notes || '-'}</p>
    `;
  }
  
  document.getElementById('itemDetailsContent').innerHTML = content;
  showPopup('itemDetailsPopup');
}

// ========== ROUND RESET BUTTON ==========
function resetRoundActions() {
  document.getElementById('action_tick').checked = false;
  document.getElementById('bonus_action_tick').checked = false;
  autosave();
  alert("Action counters reset for new round!");
}

function debugLocalStorage() {
  console.log("Checking localStorage...");
  for (let i = 0; i < localStorage.length; i++) {
    const key = localStorage.key(i);
    console.log(`${key}:`, localStorage.getItem(key));
  }
}

// ========== LAYOUT SYSTEM ==========
const LayoutManager = {
  STORAGE_KEY: 'dndSheetLayout_final',
  initialized: false,
  
  init() {
    if (this.initialized) return;
    this.initialized = true;
    
    window.addEventListener('load', () => {
      console.log('LayoutManager ready');
      this.ensureElementIds();
      
      // Set up save button
      const saveBtn = document.getElementById('saveLayoutBtn');
      if (saveBtn) {
        saveBtn.addEventListener('click', (e) => {
          e.preventDefault();
          this.save();
        });
      }
      
      // Set up reset button
      const resetBtn = document.getElementById('resetLayoutBtn');
      if (resetBtn) {
        resetBtn.addEventListener('click', (e) => {
          e.preventDefault();
          this.reset();
        });
      }
      
      this.load();
    });
  },
  
  ensureElementIds() {
    document.querySelectorAll('.section:not([id])').forEach((el, i) => {
      el.id = `section-${i+1}`;
    });
    
    document.querySelectorAll('textarea:not([id])').forEach((el, i) => {
      el.id = `textarea-${i+1}`;
    });
  },
  
  save() {
    try {
      const layout = {
        version: 'final',
        timestamp: new Date().toISOString(),
        sections: {},
        textareas: {}
      };

      document.querySelectorAll('.section').forEach(section => {
        if (section.offsetParent) {
          layout.sections[section.id] = {
            width: section.style.width || `${section.offsetWidth}px`,
            height: section.style.height || `${section.offsetHeight}px`,
            position: window.getComputedStyle(section).position
          };
        }
      });

      document.querySelectorAll('textarea').forEach(textarea => {
        if (textarea.offsetParent) {
          layout.textareas[textarea.id] = {
            width: textarea.style.width || `${textarea.offsetWidth}px`,
            height: textarea.style.height || `${textarea.offsetHeight}px`
          };
        }
      });

      localStorage.setItem(this.STORAGE_KEY, JSON.stringify(layout));
      alert('Layout saved successfully!');
      return true;
    } catch (e) {
      console.error('Save failed:', e);
      alert('Save error: ' + e.message);
      return false;
    }
  },
  
  load() {
    try {
      const data = localStorage.getItem(this.STORAGE_KEY);
      if (!data) return false;

      const layout = JSON.parse(data);
      console.log('Loading layout:', layout);

      Object.entries(layout.sections || {}).forEach(([id, style]) => {
        const el = document.getElementById(id);
        if (el) {
          el.style.width = style.width;
          el.style.height = style.height;
          if (style.position) el.style.position = style.position;
        }
      });

      Object.entries(layout.textareas || {}).forEach(([id, style]) => {
        const el = document.getElementById(id);
        if (el) {
          el.style.width = style.width;
          el.style.height = style.height;
        }
      });

      return true;
    } catch (e) {
      console.error('Load failed:', e);
      return false;
    }
  },
  
  reset() {
    if (confirm('Are you sure you want to reset ALL layout settings to default?')) {
      // Reset sections
      document.querySelectorAll('.section').forEach(section => {
        section.style.width = '';
        section.style.height = '';
        section.style.position = '';
        section.style.left = '';
        section.style.top = '';
      });
      
      // Reset textareas
      document.querySelectorAll('textarea').forEach(textarea => {
        textarea.style.width = '';
        textarea.style.height = '';
      });
      
      // Clear storage
      localStorage.removeItem(this.STORAGE_KEY);
      alert('Layout has been reset to default settings');
    }
  }
};

// Initialize
document.addEventListener('DOMContentLoaded', () => {
  LayoutManager.init();
});

</script>
</body>
</html>
