<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=0.85, maximum-scale=0.85, user-scalable=no">
<title>Joz's Homebrew DND Sheet</title>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<style>
  .section, textarea {
    transition: none !important; /* Prevent animation interference */
  }

  /* Container Styles */
  .section {
    position: relative;
    resize: both; /* Allows manual resizing */
    overflow: auto;
    min-height: 150px;
    min-width: 200px;
    padding: 1rem; /* Maintain padding */
    display: flex; /* New - enables flexible layout */
    flex-direction: column; /* New - stacks children vertically */
  }

  /* Textarea Styles */
  textarea {
    resize: both;
    min-height: 100px;
    min-width: 200px;
    overflow: auto;
    flex-grow: 1; /* New - makes textarea grow to fill container */
    margin-bottom: 10px; /* Space between textarea and other content */
  }

  /* Special case for basic-textareas */
  .basic-textarea {
    resize: both;
    min-height: 200px;
    width: 100% !important; /* Full width of container */
    flex-grow: 1;
  }

  /* Resizer handle styling */
  .section::-webkit-resizer {
    background-color: var(--accent);
  }

  /* Ensure other content stays properly aligned */
  .section-content {
    flex-shrink: 0; /* Prevents other content from shrinking */
  }

  /* Action Tracker Styles */
  .action-tracker {
    display: flex;
    gap: 15px;
    padding: 10px;
    background: #2a2a2a;
    border: var(--border);
    border-radius: 4px;
    margin-bottom: 15px;
    align-items: center;
  }

  .action-group {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .action-label {
    font-size: 0.85rem;
    color: var(--accent);
    font-weight: bold;
    min-width: 60px;
  }

  .action-input {
    width: 40px;
    padding: 5px;
    text-align: center;
    background: #333;
    color: white;
    border: 1px solid #444;
    border-radius: 3px;
  }

  .usage-toggle {
    display: flex;
    align-items: center;
    gap: 5px;
  }

  .usage-toggle input[type="checkbox"] {
    width: 14px;
    height: 14px;
    accent-color: var(--condition-green);
    cursor: pointer;
  }

  .usage-toggle label {
    font-size: 0.75rem;
    color: #aaa;
    cursor: pointer;
    white-space: nowrap;
  }

  .usage-toggle input[type="checkbox"]:checked + label {
    color: var(--condition-green);
    font-weight: bold;
  }

  .new-round-btn {
    margin-left: auto;
    padding: 3px 8px;
    font-size: 0.7rem;
    background: #333;
    color: var(--accent);
    border: 1px solid #444;
  }

  /* === POPUP FIXES === */
  .popup {
    pointer-events: none;
  }

  .popup[style*="display: block"] {
    pointer-events: auto;
  }

  /* === EXISTING CSS (OPTIMIZED) === */
  /* ========== THEME SYSTEM ========== */
  :root {
    --dark-bg: #121212;
    --panel-bg: #1e1e1e;
    --border: 1px solid #444;
    --accent: gold;
    --text-light: #f0f0f0;
    --condition-red: #ff6b6b;
    --condition-blue: #6b8cff;
    --condition-green: #6bff8c;
    --popup-bg: #2a2a2a;
    
    /* Light theme variables (default hidden) */
    --light-bg: #f5f5f5;
    --light-panel: #ffffff;
    --light-border: 1px solid #ddd;
    --light-text: #333333;
    --light-popup: #f0f0f0;
  }

   /* ==========  FIXES ========== */
    [data-theme="light"] .tabs button {
      color: #333333 !important;
    }
    
/* Fix for home button text color on mobile */
button[onclick*="home"] {
    color: black !important;
}

/* Ensure it works in both themes */
[data-theme="light"] button[onclick*="home"] {
    color: black !important;
}

/* Mobile-specific fix */
@media (max-width: 768px) {
    button[onclick*="home"] {
        color: black !important;
    }
    
    [data-theme="light"] button[onclick*="home"] {
        color: black !important;
    }
}

    [data-theme="light"] .tabs button.active {
      color: #000000 !important;
    }
    
    [data-theme="light"] #saveLayoutBtn {
      color: #333333 !important;
      background: #e0e0e0 !important;
    }

    [data-theme="light"] #saveLayoutBtn:hover {
      color: #000000 !important;
      background: #d0d0d0 !important;
    }
    
    /* Fix for settings dropdown buttons */
    [data-theme="light"] #settingsDropdown button {
      color: #333333 !important;
      background: #e0e0e0 !important;
    }
    
    [data-theme="light"] #settingsDropdown button:hover {
      color: #000000 !important;
      background: #d0d0d0 !important;
    }
    
    /* Center align text in settings dropdown */
    #settingsDropdown label {
      text-align: left;
      display: block;
      width: 100%;
    }
    
    /* Make import button match export button size */
    #settingsDropdown .import-label {
      display: block;
      width: 100%;
      text-align: center;
      cursor: pointer;
      background: var(--accent);
      color: black;
      padding: 8px;
      border-radius: 4px;
      margin-top: 5px;
      box-sizing: border-box;
      font-weight: bold; /* Added bold font weight */
    }
    
    [data-theme="light"] #settingsDropdown .import-label {
      background: #e0e0e0 !important;
      color: #333333 !important;
    }
    
    [data-theme="light"] #settingsDropdown .import-label:hover {
      background: #d0d0d0 !important;
      color: #000000 !important;
    }
    
    /* Center the theme toggle labels */
    .theme-toggle-container {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      margin-bottom: 5px;
    }
    
    .theme-label {
      font-size: 0.9rem;
      color: var(--text-light);
    }

  [data-theme="light"] {
    --dark-bg: var(--light-bg);
    --panel-bg: var(--light-panel);
    --border: var(--light-border);
    --text-light: var(--light-text);
    --popup-bg: var(--light-popup);
    
    /* Adjust text colors for light theme */
    color: var(--light-text);
  }

  [data-theme="light"] input,
  [data-theme="light"] textarea,
  [data-theme="light"] select {
    background: #f0f0f0;
    color: #333;
    border: 1px solid #ccc;
  }

  [data-theme="light"] .condition {
    background: #f0f0f0;
  }

  [data-theme="light"] .action-tracker {
    background: #e0e0e0;
  }

  [data-theme="light"] .welcome-section,
  [data-theme="light"] .character-manager-grid > div {
    background: #f0f0f0;
  }

  [data-theme="light"] th {
    background: #e0e0e0;
    color: #333;
  }

  [data-theme="light"] .top-right-reset {
    background: var(--light-panel);
    color: var(--accent);
    border: var(--light-border);
  }
  [data-theme="light"] button {
    color: #333333 !important;
  }

  [data-theme="light"] button:hover {
    color: #000000 !important;
  }

  [data-theme="light"] #saveDataBtn,
  [data-theme="light"] #saveLayoutBtn {
    color: #333333 !important;
    background: #e0e0e0 !important;
  }

  [data-theme="light"] #saveDataBtn:hover,
  [data-theme="light"] #saveLayoutBtn:hover {
    color: #000000 !important;
    background: #d0d0d0 !important;
  }

  [data-theme="light"] .new-round-btn {
    color: #333333 !important;
    background: #e0e0e0 !important;
  }

  [data-theme="light"] .new-round-btn:hover {
    color: #000000 !important;
    background: #d0d0d0 !important;
  }

  [data-theme="light"] .delete-container-btn {
    color: white !important; /* Keep danger buttons white for visibility */
  }

  [data-theme="light"] .top-right-reset {
    color: #333333 !important;
  }
  body {
    margin: 0;
    font-family: 'Segoe UI', sans-serif;
    background: var(--dark-bg);
    color: var(--text-light);
  }

  h1, h2, h3, h4 {
    color: var(--accent);
    margin-top: 0;
  }

  .tabs {
    display: flex;
    justify-content: center;
    gap: 10px;
    flex-wrap: wrap;
    padding: 10px;
    background: #222;
    position: sticky;
    top: 0;
    z-index: 100;
  }

  .tabs button {
    background: var(--panel-bg);
    color: white;
    border: var(--border);
    padding: 8px 16px;
    cursor: pointer;
    transition: all 0.2s;
    border-radius: 4px;
  }

  .tabs button.active {
    background: var(--accent);
    color: black;
    font-weight: bold;
  }

  /* Home Page Styles */
  .welcome-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
  }

  .welcome-section {
    background: #2a2a2a;
    padding: 15px;
    border-radius: 6px;
    border: var(--border);
  }

  .divider {
    height: 1px;
    background: var(--accent);
    margin: 10px 0;
    opacity: 0.3;
  }

  @media (max-width: 768px) {
    .welcome-grid {
      grid-template-columns: 1fr;
    }
  }

  /* Character Manager Styles */
  .character-manager-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
  }

  .character-manager-grid > div {
    background: #1e1e1e;
    padding: 10px;
    border-radius: 4px;
    border: var(--border);
  }

  .character-manager-grid h4 {
    margin-top: 0;
    color: var(--accent);
    font-size: 1rem;
  }

  .character-manager-grid input,
  .character-manager-grid select {
    width: 100%;
    margin-bottom: 8px;
  }

  .delete-flow {
    position: relative;
  }

  #deleteConfirmInput {
    margin-top: 5px;
    width: calc(100% - 10px);
  }

  #deleteCharCount {
    position: absolute;
    right: 10px;
    bottom: -20px;
    font-size: 0.8rem;
    color: #aaa;
  }

  /* Delete button states */
  #deleteBtn.warning {
    background-color: #ffcc00;
    color: #000;
  }

  #deleteBtn.danger {
    background-color: #ff6600;
    color: #000;
    animation: pulse 0.5s infinite alternate;
  }

  .page {
    display: none;
    padding: 1rem;
  }

  .page.active {
    display: block;
  }

  .section {
    background: var(--panel-bg);
    padding: 1rem;
    margin: 1rem 0;
    border-radius: 6px;
    border: var(--border);
    transition: all 0.3s ease;
    box-sizing: border-box;
  }

  .resizable {
    resize: both;
    overflow: auto;
    min-height: 50px;
    min-width: 100px;
  }

  .flex-wrap {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
  }

  .flex-wrap .section {
    flex: 1 1 300px;
  }

  .horizontal-sections {
    display: flex;
    gap: 1rem;
    margin-top: 1rem;
    flex-direction: column;
  }

  .horizontal-sections .section {
    flex: 1;
    min-width: 300px;
  }

  input, textarea, select {
    width: 100%;
    padding: 8px;
    background: #2a2a2a;
    color: white;
    border: 1px solid #666;
    border-radius: 4px;
    margin: 4px 0 10px;
    box-sizing: border-box;
  }

  textarea {
    resize: vertical;
    min-height: 60px;
  }

  button {
    background: var(--accent);
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    font-weight: bold;
    cursor: pointer;
    margin: 4px 2px;
    transition: all 0.2s;
  }

 button:hover {
  background: var(--accent);
  filter: brightness(1.1);
  transform: translateY(-1px);
}


  .top-right-reset {
    position: fixed;
    top: 10px;
    right: 10px;
    background: var(--panel-bg);
    color: var(--accent);
    border: var(--border);
    cursor: pointer;
    padding: 5px 10px;
    z-index: 1000;
  }

  .condition {
    background: #2a2a2a;
    border-left: 4px solid var(--condition-red);
    padding: 8px;
    margin: 6px 0;
    border-radius: 0 4px 4px 0;
  }

  .condition.blue { border-color: var(--condition-blue); }
  .condition.green { border-color: var(--condition-green); }

  .condition-header {
    display: flex;
    justify-content: space-between;
    font-weight: bold;
  }

  .condition-turns {
    color: var(--accent);
    font-style: italic;
  }

  .popup {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: var(--popup-bg);
    padding: 20px;
    border: var(--border);
    border-radius: 6px;
    z-index: 1000;
    width: 90%;
    max-width: 800px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 0 20px rgba(0,0,0,0.5);
  }

  .popup-backdrop {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.7);
    z-index: 999;
  }

  .portrait-container {
    width: 200px;
    height: 250px;
    border: var(--border);
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    margin-bottom: 10px;
    background: #2a2a2a;
  }

  .portrait-container img {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
  }

  .skill-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
    margin-bottom: 8px;
  }

  .skill-row label {
    flex: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .skill-row input[type="checkbox"] {
    width: auto;
    margin-right: 5px;
  }

  .skill-row input[type="text"] {
    width: 60px;
    text-align: center;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 10px;
  }

  th, td {
    padding: 8px;
    border: 1px solid #444;
    text-align: left;
  }

  th {
    background: #2a2a2a;
  }

  /* Settings dropdown styles */
  [data-theme="light"] #settingsDropdown {
    background: var(--light-panel);
    border: var(--light-border);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  }

  [data-theme="light"] #settingsDropdown label {
    color: var(--light-text);
  }

  /* Basic Textarea Style (for direct editing) */
  .basic-textarea {
    width: 100%;
    min-height: 200px;
    background: #2a2a2a;
    color: white;
    border: 1px solid #666;
    padding: 10px;
    box-sizing: border-box;
    resize: vertical;
    display: block !important;
  }

  .basic-textarea::placeholder {
    color: #888;
    font-style: italic;
  }

  /* Make all sections resizable */
  .section {
    resize: both;
    overflow: auto;
    min-height: 150px;
    min-width: 200px;
  }

  /* Adjust notes container */
  .notes-container {
    min-height: 100px;
    background: #2a2a2a;
    border: 1px solid #444;
    padding: 10px;
    margin-bottom: 10px;
  }

  .background-grid {
    display: grid;
    grid-template-columns: 250px 1fr;
    gap: 1rem;
  }

  .background-textareas {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
  }

  .weight-display {
    font-weight: bold;
    margin-top: 10px;
    text-align: right;
  }

  .inventory-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
  }

  .delete-container-btn {
    background-color: #ff4444;
    color: white;
  }

  .delete-container-btn.confirm {
    background-color: #ff0000;
    animation: pulse 0.5s infinite alternate;
  }

  .ability-row {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
  }

  .ability-col {
    flex: 1;
  }

  .skills-container {
    overflow-y: auto;
  }

  .item-row {
    cursor: pointer;
  }

  .item-row:hover {
    background-color: #2a2a2a;
  }

  /* Add this new style for overweight containers */
  .overweight {
    color: var(--condition-red) !important;
    font-weight: bold;
  }

  /* Improved death saves layout */
  .death-saves-container {
    display: flex;
    justify-content: space-between;
    gap: 10px;
  }

  .death-save-group {
    flex: 1;
  }

  .death-save-checks {
    display: flex;
    gap: 5px;
    margin-top: 5px;
  }

  /* Improved notes in tables */
  .table-notes {
    max-height: 100px;
    overflow-y: auto;
    padding: 5px;
    background: #2a2a2a;
    border: 1px solid #444;
    border-radius: 4px;
  }

  @keyframes pulse {
    from { transform: scale(1); }
    to { transform: scale(1.05); }
  }

  /* ===== FIXED POPUP POSITIONING ===== */
  .popup {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: var(--popup-bg);
    padding: 20px;
    border: var(--border);
    border-radius: 6px;
    z-index: 1000;
    width: 90%;
    max-width: 800px;
    max-height: 90vh;
    overflow-y: auto;
    box-sizing: border-box;
  }

  /* Mobile-specific fixes */
  @media (max-width: 768px) {
    .popup {
      width: 95vw !important;
      max-width: 95vw !important;
      height: auto;
      max-height: 85vh !important;
      padding: 15px;
    }
    
    .popup table {
      display: block;
      overflow-x: auto;
      width: 100% !important;
      -webkit-overflow-scrolling: touch;
    }
    
    .popup table td, 
    .popup table th {
      white-space: nowrap;
      padding: 6px 4px;
    }
  }

  @media (max-width: 768px) {

     .section div[style*="grid-template-columns"] {
      grid-template-columns: 1fr !important;
    }

    .background-grid {
      grid-template-columns: 1fr;
    }
    
    .background-textareas {
      grid-template-columns: 1fr;
    }
    
    .flex-wrap .section {
      flex: 1 1 100%;
    }
    
    .horizontal-sections {
      flex-direction: column;
    }
    
    .portrait-container {
      width: 150px;
      height: 200px;
      margin: 0 auto;
    }
  }
  #notesPopupTextarea {
    display: block !important;
    width: 100%;
    min-height: 200px;
    background: #2a2a2a;
    color: white;
    border: 1px solid #666;
    padding: 10px;
    box-sizing: border-box;
  }
  /* Add these to your existing CSS */
  .portrait-container img {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
    display: block;
  }

  #saveDataBtn, #saveLayoutBtn {
    background: #333;
    color: var(--accent);
    margin-left: 5px;
  }

  #saveDataBtn:hover, #saveLayoutBtn:hover {
    background: #444;
  }

  /* Theme toggle switch - FIXED SCALING */
  .switch {
    position: relative;
    display: inline-block;
    width: 40px; /* Reduced from 50px */
    height: 20px; /* Reduced from 24px */
  }

  .switch input {
    opacity: 0;
    width: 0;
    height: 0;
  }

  .slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    transition: .4s;
  }

  .slider:before {
    position: absolute;
    content: "";
    height: 14px; /* Reduced from 16px */
    width: 14px; /* Reduced from 16px */
    left: 3px; /* Adjusted from 4px */
    bottom: 3px; /* Adjusted from 4px */
    background-color: white;
    transition: .4s;
  }

  input:checked + .slider {
    background-color: var(--accent);
  }

  input:checked + .slider:before {
    transform: translateX(20px); /* Reduced from 26px */
  }

  .slider.round {
    border-radius: 20px; /* Adjusted from 24px */
  }

  .slider.round:before {
    border-radius: 50%;
  }


    #saveDataBtn {
      background: #333;
      color: var(--accent);
      margin-left: 5px;
    }

    #saveDataBtn:hover {
      background: #444;
    }

    [data-theme="light"] #saveDataBtn {
      background: #e0e0e0 !important;
      color: #333333 !important;
    }

    [data-theme="light"] #saveDataBtn:hover {
      background: #d0d0d0 !important;
      color: #000000 !important;
    }

  /* Fix for button alignment */
  #resetLayoutBtn {
    vertical-align: middle;
  }

  /* Ensure all top buttons have consistent styling */
  #saveDataBtn, #saveLayoutBtn, #resetLayoutBtn {
    vertical-align: middle;
  }

  /* Fix for save buttons in light mode */
  [data-theme="light"] #saveDataBtn,
  [data-theme="light"] #saveLayoutBtn {
    background: var(--accent) !important;
    color: #000000 !important;
  }

  [data-theme="light"] #saveDataBtn:hover,
  [data-theme="light"] #saveLayoutBtn:hover {
    background: #ffd700 !important;
    color: #000000 !important;
  }
  
 /* ========== SPELLS PAGE STYLES ========== */
  .spells-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    margin-bottom: 1rem;
  }
  
  .spell-slots-container {
    background: var(--panel-bg);
    padding: 1rem;
    border-radius: 6px;
    border: var(--border);
  }
  
  .spell-level-row {
    display: flex;
    align-items: center;
    margin-bottom: 10px;
    gap: 10px;
  }
  
  .spell-level-label {
    min-width: 80px;
    font-weight: bold;
    color: var(--accent);
  }
  
  .spell-slot-input {
    width: 50px !important;
    text-align: center;
  }
  
  .spell-slots-used {
    display: flex;
    gap: 5px;
  }
  
  .spell-slot-dot {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    border: 1px solid var(--accent);
    cursor: pointer;
    transition: all 0.2s;
  }
  
  .spell-slot-dot.used {
    background-color: var(--accent);
  }
  
  .spells-list-container {
    background: var(--panel-bg);
    padding: 1rem;
    border-radius: 6px;
    border: var(--border);
    max-height: 400px;
    overflow-y: auto;
  }
  
  .spell-level-section {
    margin-bottom: 20px;
  }
  
  .spell-level-header {
    color: var(--accent);
    border-bottom: 1px solid var(--accent);
    padding-bottom: 5px;
    margin-bottom: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .spell-item {
    padding: 8px;
    margin-bottom: 5px;
    background: #2a2a2a;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .spell-item:hover {
    background: #333;
    transform: translateX(5px);
  }
  
  .spell-item-actions {
    display: flex;
    gap: 5px;
  }
  
  .spell-item-btn {
    padding: 2px 5px;
    font-size: 0.7rem;
    background: #333;
    border: 1px solid #444;
    color: var(--text-light);
    cursor: pointer;
    border-radius: 3px;
  }
  
  .spell-item-btn:hover {
    background: #444;
  }
  
  .spell-prepared {
    color: var(--condition-green) !important;
    font-weight: bold;
  }
  
  .spell-ritual {
    border-left: 3px solid var(--condition-blue);
  }
  
  .spell-concentration {
    border-left: 3px solid var(--condition-red);
  }
  
  .spells-controls {
    display: flex;
    justify-content: space-between;
    margin-bottom: 15px;
  }
  
  .spell-filter {
    display: flex;
    gap: 10px;
    align-items: center;
  }
  
  .spell-filter select, .spell-filter input {
    width: auto !important;
    margin: 0 !important;
  }
  
  /* Spell Details Popup */
  #spellDetailsPopup {
    max-width: 600px;
  }
  
  .spell-detail-row {
    display: flex;
    margin-bottom: 10px;
  }
  
  .spell-detail-label {
    font-weight: bold;
    min-width: 120px;
    color: var(--accent);
  }
  
  .spell-detail-value {
    flex: 1;
  }
  
  .spell-description {
    margin-top: 15px;
    padding: 10px;
    background: #2a2a2a;
    border-radius: 4px;
    max-height: 200px;
    overflow-y: auto;
  }
  
  /* Add/Edit Spell Popup */
  #spellFormPopup {
    max-width: 700px;
  }
  
  .spell-form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
  }
  
  .spell-form-full {
    grid-column: 1 / -1;
  }
  
  .spell-form-actions {
    grid-column: 1 / -1;
    display: flex;
    justify-content: space-between;
    margin-top: 15px;
  }

  /* Favorites Section Styles */
  .favorites-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
  }

  .favorites-cantrips, .favorites-spells {
    background: var(--panel-bg);
    padding: 1rem;
    border-radius: 6px;
    border: var(--border);
  }

  .favorites-cantrips h3, .favorites-spells h3 {
    color: var(--accent);
    margin-bottom: 10px;
    text-align: center;
  }

  /* Import Popup Styles */
  .import-content {
    display: flex;
    flex-direction: column;
    gap: 20px;
  }

  .class-selection {
    background: #2a2a2a;
    padding: 15px;
    border-radius: 6px;
  }

  .class-level-row {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 10px;
    padding: 8px;
    background: #333;
    border-radius: 4px;
  }

  .class-level-row select {
    flex: 1;
  }

  .class-level-row input {
    width: 60px;
    text-align: center;
  }

  .remove-class-btn {
    background: #ff4444;
    color: white;
    border: none;
    padding: 5px 8px;
    border-radius: 3px;
    cursor: pointer;
  }

  .remove-class-btn:hover {
    background: #ff6666;
  }

  /* Star icon for favorites */
  .favorite-star {
    color: #ffd700;
    cursor: pointer;
    font-size: 1.2em;
    margin-right: 5px;
  }

  .favorite-star:hover {
    color: #ffed4e;
  }

  .favorite-star.favorited {
    color: #ffd700;
  }

  .favorite-star.not-favorited {
    color: #666;
  }

  /* Clear All Button Styles */
  .clear-all-btn {
    background-color: #ff4444 !important;
    color: white !important;
    border: 1px solid #cc3333;
  }

  .clear-all-btn:hover {
    background-color: #ff6666 !important;
    border-color: #ff4444;
  }

  .clear-all-btn:active {
    background-color: #cc3333 !important;
  }
  
  @media (max-width: 768px) {
    .spells-grid {
      grid-template-columns: 1fr;
    }
    
    .spell-form-grid {
      grid-template-columns: 1fr;
    }
    
    .spell-detail-row {
      flex-direction: column;
      margin-bottom: 15px;
    }
    
    .spell-detail-label {
      margin-bottom: 5px;
    }
  }

</style>
</head>
<body>
<!-- Warning Banner -->
<div style="text-align:center; background:#222; color:#ccc; padding:8px; border-bottom: var(--border);">
⚠️ This sheet autosaves character data to your browser. Use Export to back up your character.
</div>

<!-- Header -->
<h1>Joz's Homebrew DND Sheet 
  <span style="font-size:0.8rem; color:#aaa; margin-left:10px;">[Autosaves Locally]</span>
</h1>

<!-- Data Controls -->
<div style="display: flex; justify-content: flex-end; align-items: center; gap: 8px; margin: 10px 1rem 0 0;">

  <!-- Home Button -->
  <button onclick="
    document.getElementById('home').classList.add('active'); 
    document.querySelectorAll('.page').forEach(p => { if(p.id !== 'home') p.classList.remove('active'); });
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  ">Home</button>

  <!-- Reset Layout -->
  <button id="resetLayoutBtn" style="background: var(--accent); color: black;">Reset Layout</button>

  <!-- Save Layout -->
  <button id="saveLayoutBtn" style="background: var(--accent); color: black;">Save Layout</button>

  <!-- Save Data -->
  <button id="saveDataBtn" onclick="autosave(); alert('Character data saved!');" style="background: var(--accent); color: black;">Save Data</button>

  <!-- Settings Dropdown -->
  <div style="position: relative; display: inline-block;">
    <button id="settingsBtn" style="background: var(--accent); color: black;">Settings</button>
    <div id="settingsDropdown" style="display: none; position: absolute; right: 0; background: var(--panel-bg); border: var(--border); border-radius: 4px; padding: 10px; min-width: 200px; z-index: 1000; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
      
      <!-- Theme Toggle -->
      <div style="margin-bottom: 10px;">
        <div class="theme-toggle-container">
          <span class="theme-label">Dark</span>
          <label class="switch">
            <input type="checkbox" id="themeToggle" onchange="toggleTheme()">
            <span class="slider round"></span>
          </label>
          <span class="theme-label">Light</span>
        </div>
      </div>

      <!-- Accent Color -->
      <div style="margin-bottom: 10px;">
        <label style="display: block; margin-bottom: 5px; color: var(--text-light);">Accent Color:</label>
        <input type="color" id="accentColor" onchange="updateAccentColor(this.value)" value="#ffd700" style="width: 100%; height: 30px; padding: 0; border: 1px solid #666; border-radius: 4px;">
      </div>

      <!-- Cloud Sync -->
      <div style="border-top: 1px solid #444; margin: 10px 0; padding-top: 10px;">
        <div id="cloudSyncSection">
          <div id="signedOutView">
            <button onclick="signInWithGoogle()" style="width: 100%; margin-bottom: 5px; background: #4285f4; color: white;">Sign In with Google</button>
            <p style="font-size: 0.8rem; color: var(--text-light); margin: 5px 0;">Sign in to sync characters across devices</p>
          </div>
          <div id="signedInView" style="display: none;">
            <p style="font-size: 0.8rem; color: var(--text-light); margin: 5px 0;">Signed in as: <span id="userEmail"></span></p>
            <button onclick="syncToCloud()" style="width: 100%; margin-bottom: 5px; background: #34a853; color: white;">Upload to Cloud</button>
            <button onclick="syncFromCloud()" style="width: 100%; margin-bottom: 5px; background: #ea4335; color: white;">Download from Cloud</button>
            <button onclick="signOut()" style="width: 100%; margin-bottom: 5px; background: #666; color: white;">Sign Out</button>
            <p id="syncStatus" style="font-size: 0.7rem; color: var(--text-light); margin: 2px 0;"></p>
          </div>
        </div>
      </div>

      <!-- Export / Import -->
      <div style="border-top: 1px solid #444; margin: 10px 0; padding-top: 10px;">
        <button onclick="exportData()" style="width: 100%; margin-bottom: 5px; background: var(--accent); color: black;">Export Character</button>
        <label class="import-label" style="width: 100%; display: block; cursor: pointer; text-align: center; background: var(--accent); color: black; padding: 5px; border-radius: 4px;">
          Import Character
          <input onchange="importData(event)" style="display: none;" type="file"/>
        </label>
      </div>

    </div>
  </div>

</div>

<!-- Tabs -->
<div class="tabs">
  <button class="tab active" data-tab="page1" onclick="switchTab(this)">Stats</button>
  <button class="tab" data-tab="page2" onclick="switchTab(this)">Background</button>
  <button class="tab" data-tab="page3" onclick="switchTab(this)">Spells</button>
  <button class="tab" data-tab="page4" onclick="switchTab(this)">Inventory</button>
  <button class="tab" data-tab="page6" onclick="switchTab(this)">Notes</button>
</div>

<!-- Pages -->
<div id="pages">
  
<!-- Home Page -->
<div class="page" id="home">
  <div class="section">
    <h2>Welcome to Joz's Homebrew DND Sheet</h2>
    <div class="welcome-grid">
      <div class="welcome-section">
        <h3>Character Manager</h3>
        <div class="divider"></div>
        <div class="character-manager-grid">
          <div>
            <h4>New Character</h4>
            <input type="text" id="newCharName" placeholder="Character Name">
            <button onclick="createNewCharacter()">Create</button>
          </div>
          <div>
            <h4>Load Character</h4>
            <select id="characterList"></select>
            <button onclick="loadSelectedCharacter()">Load</button>
          </div>
          <div>
            <h4>Delete Character</h4>
            <div class="delete-flow">
              <button id="deleteBtn" onclick="initiateDelete()">Delete Character</button>
              <input type="text" id="deleteConfirmInput" placeholder="Type 'DELETE'" style="display: none;">
              <span id="deleteCharCount" style="display: none;">0/6</span>
            </div>
          </div>
        </div>
      </div>
      
      <div class="welcome-section">
        <h3>Getting Started</h3>
        <div class="divider"></div>
        <p>This digital character sheet automatically saves your data to your browser. To get started:</p>
        <ol>
          <li>Create a new character using the Character Manager</li>
          <li>Fill in your basic character information on the Stats page</li>
          <li>Use the tabs to navigate between different character sections</li>
          <li>Remember to export your character for backup</li>
        </ol>
      </div>
      
      <div class="welcome-section">
        <h3>Features</h3>
        <div class="divider"></div>
        <ul>
          <li><strong>Automatic Saving:</strong> All changes are saved automatically</li>
          <li><strong>Multiple Characters:</strong> Manage multiple character sheets</li>
          <li><strong>Resizable Sections:</strong> Drag to resize any section</li>
          <li><strong>Mobile Friendly:</strong> Works on phones and tablets</li>
          <li><strong>Homebrew Ready:</strong> Customizable for any homebrew content</li>
        </ul>
      </div>
    </div>
  </div>
</div>

  <!-- Stats Page -->
  <div class="page active" id="page1">
<!-- Character Basic Info -->
<div class="section" style="margin-bottom: 15px;">
  <h2>Character Info</h2>
  <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px;">
    <div>
      <label>Name</label>
      <input id="char_name" oninput="autosave()" placeholder="Character Name"/>
    </div>
    <div>
      <label>Race</label>
      <input id="char_race" oninput="autosave()" placeholder="Race"/>
    </div>
    <div>
      <label>Class</label>
      <input id="char_class" oninput="autosave()" placeholder="Class"/>
    </div>
    <div>
      <label>Subclass</label>
      <input id="char_subclass" oninput="autosave()" placeholder="Subclass"/>
    </div>
    <div>
      <label>Level</label>
      <input id="char_level" oninput="autosave()" type="number" min="1" placeholder="Level"/>
    </div>
  </div>
</div>
    <div class="flex-wrap">
      
      <!-- Ability Scores -->
      <div class="section">
        <h2>Ability Scores</h2>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
          <div class="ability-row">
            <div class="ability-col">
              <label>STR</label>
              <input id="str" oninput="autosave()"/>
            </div>
            <div class="ability-col">
              <label>STR Bonus</label>
              <input id="str_bonus" oninput="autosave()"/>
            </div>
          </div>
          <div class="ability-row">
            <div class="ability-col">
              <label>DEX</label>
              <input id="dex" oninput="autosave()"/>
            </div>
            <div class="ability-col">
              <label>DEX Bonus</label>
              <input id="dex_bonus" oninput="autosave()"/>
            </div>
          </div>
          <div class="ability-row">
            <div class="ability-col">
              <label>CON</label>
              <input id="con" oninput="autosave()"/>
            </div>
            <div class="ability-col">
              <label>CON Bonus</label>
              <input id="con_bonus" oninput="autosave()"/>
            </div>
          </div>
          <div class="ability-row">
            <div class="ability-col">
              <label>INT</label>
              <input id="int" oninput="autosave()"/>
            </div>
            <div class="ability-col">
              <label>INT Bonus</label>
              <input id="int_bonus" oninput="autosave()"/>
            </div>
          </div>
          <div class="ability-row">
            <div class="ability-col">
              <label>WIS</label>
              <input id="wis" oninput="autosave()"/>
            </div>
            <div class="ability-col">
              <label>WIS Bonus</label>
              <input id="wis_bonus" oninput="autosave()"/>
            </div>
          </div>
          <div class="ability-row">
            <div class="ability-col">
              <label>CHA</label>
              <input id="cha" oninput="autosave()"/>
            </div>
            <div class="ability-col">
              <label>CHA Bonus</label>
              <input id="cha_bonus" oninput="autosave()"/>
            </div>
          </div>
        </div>
        
        <!-- Combat Stats -->
        <h3 style="margin-top: 15px;">Combat Stats</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
          <div>
            <label>AC</label>
            <input id="ac" oninput="autosave()"/>
            <label>Initiative</label>
            <input id="initiative" oninput="autosave()"/>
          </div>
          <div>
            <label>Speed</label>
            <input id="speed" oninput="autosave()"/>
            <label>Prof. Bonus</label>
            <input id="prof_bonus" oninput="autosave()"/>
          </div>
        </div>
        <!-- Saving Throws - Added inside the same section -->
<h3 style="margin-top: 15px;">Saving Throws</h3>
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
  <div>
    <label>STR Save</label>
    <input id="str_save" oninput="autosave()"/>
    <label>DEX Save</label>
    <input id="dex_save" oninput="autosave()"/>
    <label>CON Save</label>
    <input id="con_save" oninput="autosave()"/>
  </div>
  <div>
    <label>INT Save</label>
    <input id="int_save" oninput="autosave()"/>
    <label>WIS Save</label>
    <input id="wis_save" oninput="autosave()"/>
    <label>CHA Save</label>
    <input id="cha_save" oninput="autosave()"/>
  </div>
</div>
      </div>
      
      <!-- Skills -->
      <div class="section">
        <h2>Skills</h2>
        <div class="skills-container">
          <div class="skill-row">
            <input id="prof_acrobatics" oninput="autosave()" type="checkbox"/>
            <label for="prof_acrobatics">Acrobatics (Dex)</label>
            <input id="bonus_acrobatics" oninput="autosave()" type="text" placeholder="+0"/>
          </div>
          <div class="skill-row">
            <input id="prof_animal_handling" oninput="autosave()" type="checkbox"/>
            <label for="prof_animal_handling">Animal Handling (Wis)</label>
            <input id="bonus_animal_handling" oninput="autosave()" type="text" placeholder="+0"/>
          </div>
          <div class="skill-row">
            <input id="prof_arcana" oninput="autosave()" type="checkbox"/>
            <label for="prof_arcana">Arcana (Int)</label>
            <input id="bonus_arcana" oninput="autosave()" type="text" placeholder="+0"/>
          </div>
          <div class="skill-row">
            <input id="prof_athletics" oninput="autosave()" type="checkbox"/>
            <label for="prof_athletics">Athletics (Str)</label>
            <input id="bonus_athletics" oninput="autosave()" type="text" placeholder="+0"/>
          </div>
          <div class="skill-row">
            <input id="prof_deception" oninput="autosave()" type="checkbox"/>
            <label for="prof_deception">Deception (Cha)</label>
            <input id="bonus_deception" oninput="autosave()" type="text" placeholder="+0"/>
          </div>
          <div class="skill-row">
            <input id="prof_history" oninput="autosave()" type="checkbox"/>
            <label for="prof_history">History (Int)</label>
            <input id="bonus_history" oninput="autosave()" type="text" placeholder="+0"/>
          </div>
          <div class="skill-row">
            <input id="prof_insight" oninput="autosave()" type="checkbox"/>
            <label for="prof_insight">Insight (Wis)</label>
            <input id="bonus_insight" oninput="autosave()" type="text" placeholder="+0"/>
          </div>
          <div class="skill-row">
            <input id="prof_intimidation" oninput="autosave()" type="checkbox"/>
            <label for="prof_intimidation">Intimidation (Cha)</label>
            <input id="bonus_intimidation" oninput="autosave()" type="text" placeholder="+0"/>
          </div>
          <div class="skill-row">
            <input id="prof_investigation" oninput="autosave()" type="checkbox"/>
            <label for="prof_investigation">Investigation (Int)</label>
            <input id="bonus_investigation" oninput="autosave()" type="text" placeholder="+0"/>
          </div>
          <div class="skill-row">
            <input id="prof_medicine" oninput="autosave()" type="checkbox"/>
            <label for="prof_medicine">Medicine (Wis)</label>
            <input id="bonus_medicine" oninput="autosave()" type="text" placeholder="+0"/>
          </div>
          <div class="skill-row">
            <input id="prof_nature" oninput="autosave()" type="checkbox"/>
            <label for="prof_nature">Nature (Int)</label>
            <input id="bonus_nature" oninput="autosave()" type="text" placeholder="+0"/>
          </div>
          <div class="skill-row">
            <input id="prof_perception" oninput="autosave()" type="checkbox"/>
            <label for="prof_perception">Perception (Wis)</label>
            <input id="bonus_perception" oninput="autosave()" type="text" placeholder="+0"/>
          </div>
          <div class="skill-row">
            <input id="prof_performance" oninput="autosave()" type="checkbox"/>
            <label for="prof_performance">Performance (Cha)</label>
            <input id="bonus_performance" oninput="autosave()" type="text" placeholder="+0"/>
          </div>
          <div class="skill-row">
            <input id="prof_persuasion" oninput="autosave()" type="checkbox"/>
            <label for="prof_persuasion">Persuasion (Cha)</label>
            <input id="bonus_persuasion" oninput="autosave()" type="text" placeholder="+0"/>
          </div>
          <div class="skill-row">
            <input id="prof_religion" oninput="autosave()" type="checkbox"/>
            <label for="prof_religion">Religion (Int)</label>
            <input id="bonus_religion" oninput="autosave()" type="text" placeholder="+0"/>
          </div>
          <div class="skill-row">
            <input id="prof_sleight_of_hand" oninput="autosave()" type="checkbox"/>
            <label for="prof_sleight_of_hand">Sleight of Hand (Dex)</label>
            <input id="bonus_sleight_of_hand" oninput="autosave()" type="text" placeholder="+0"/>
          </div>
          <div class="skill-row">
            <input id="prof_stealth" oninput="autosave()" type="checkbox"/>
            <label for="prof_stealth">Stealth (Dex)</label>
            <input id="bonus_stealth" oninput="autosave()" type="text" placeholder="+0"/>
          </div>
          <div class="skill-row">
            <input id="prof_survival" oninput="autosave()" type="checkbox"/>
            <label for="prof_survival">Survival (Wis)</label>
            <input id="bonus_survival" oninput="autosave()" type="text" placeholder="+0"/>
          </div>
        </div>
      </div>
      
      <!-- Health -->
      <div class="section">
        <h2>Health</h2>
        <label>Max HP</label>
        <input id="max_hp" oninput="autosave()" type="number"/>
        <label>Current HP</label>
        <input id="curr_hp" oninput="autosave()" type="number"/>
        
        <div style="margin: 10px 0; display: flex; gap: 5px;">
          <button onclick="adjustHP(1)">+1</button>
          <button onclick="adjustHP(-1)">-1</button>
        </div>
        
        <p id="temp_hp_note" style="color: gold;"></p>
        
        <div style="margin-top: 10px;">
          <button onclick="longRest()">Long Rest</button>
        </div>
        
        <!-- Death Saves -->
        <h3 style="margin-top: 15px;">Death Saves</h3>
        <div class="death-saves-container">
          <div class="death-save-group">
            <label>Success</label>
            <div class="death-save-checks">
              <input type="checkbox" id="death_save_success_1" oninput="autosave()"/>
              <input type="checkbox" id="death_save_success_2" oninput="autosave()"/>
              <input type="checkbox" id="death_save_success_3" oninput="autosave()"/>
            </div>
          </div>
          <div class="death-save-group">
            <label>Failure</label>
            <div class="death-save-checks">
              <input type="checkbox" id="death_save_failure_1" oninput="autosave()"/>
              <input type="checkbox" id="death_save_failure_2" oninput="autosave()"/>
              <input type="checkbox" id="death_save_failure_3" oninput="autosave()"/>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Proficiencies & Training (swapped with Conditions) -->
      <div class="section">
        <h2>Proficiencies & Training</h2>
        <textarea id="proficiencies_training" class="basic-textarea" 
                  oninput="autosave()" placeholder="List your proficiencies, tools, languages, and special training..."
                  style="min-height: 100px;"></textarea>
      </div>
    </div>
    
    <!-- Weapons and Equipment at bottom -->
    <div class="horizontal-sections">
        <!-- Weapons -->
         <div class="section">
           <h2>Weapons 
             <button onclick="showWeaponsPopup()" style="float: right; padding: 2px 6px; font-size: 0.8rem;">✎ Edit</button>
          </h2>
          <div id="weapons_preview">
            <!-- Weapons preview will be shown here -->
          </div>
        </div>
            
         <!-- Equipment -->
         <div class="section">
           <h2>Equipment 
            <button onclick="showEquipmentPopup()" style="float: right; padding: 2px 6px; font-size: 0.8rem;">✎ Edit</button>
           </h2>
           <div id="equipment_stats_preview">
            <h4>Equipment</h4>
            <!-- Equipment will be dynamically loaded here by JavaScript -->
          </div>
           <div id="equipment_preview">
            <!-- This is for the inventory page, or other general equipment preview -->
         </div>
      </div>
    </div>

      <!-- Action Tracker -->
      <div class="action-tracker">
        <div class="action-group">
          <span class="action-label">Actions</span>
          <input class="action-input" id="action_counter" type="number" min="0" oninput="autosave()" value="0">
          <div class="usage-toggle">
            <input type="checkbox" id="action_tick" oninput="autosave()" title="Mark if used this round">
            <label for="action_tick">Used</label>
          </div>
        </div>

        <div class="action-group">
          <span class="action-label">Bonus</span>
          <input class="action-input" id="bonus_action_counter" type="number" min="0" oninput="autosave()" value="0">
          <div class="usage-toggle">
            <input type="checkbox" id="bonus_action_tick" oninput="autosave()" title="Mark if used this round">
            <label for="bonus_action_tick">Used</label>
          </div>
        </div>

        <button class="new-round-btn" onclick="resetRoundActions()">New Round</button>
      </div>

      <!-- Actions & Features -->
      <div class="section">
        <h2>Actions & Features</h2>
        <textarea id="actions_features" class="basic-textarea" 
                  oninput="autosave()" placeholder="Enter your actions and features here..."></textarea>
      </div>

      <!-- Conditions (swapped with Proficiencies & Training) -->
      <div class="section">
        <h2>Long Term Conditions 
          <button onclick="showConditionPopup()" style="float: right; padding: 2px 6px; font-size: 0.8rem;">+ Add</button>
        </h2>
        <div id="conditions_container">
          <!-- itions will be added here dynamically -->
        </div>
      </div>

      <!-- Quick Notes -->
      <div class="section">
        <h2>Quick Notes</h2>
        <textarea id="stats_quick_notes" class="basic-textarea" 
                  oninput="autosave()" placeholder="Jot down quick notes here..."></textarea>
      </div>
    </div>
  </div>

  <!-- Background Page -->
  <div class="page" id="page2">
    <div class="background-grid">
<div class="section resizable">
  <h2>Portrait</h2>
  <div class="portrait-container" id="portraitPreview">
    <span style="color: #666;">No image</span>
  </div>
  <input type="file" id="portraitUpload" accept="image/*" style="width: 100%; margin-bottom: 10px;"/>
  <button onclick="removePortrait()" style="width: 100%;">Remove Portrait</button>
</div>
      <!-- Updated Background Sections with Direct Textareas -->
      <div class="section">
        <h2>Backstory</h2>
        <textarea id="char_backstory" class="basic-textarea" 
                  oninput="autosave()" placeholder="Enter your character's backstory here..."></textarea>
      </div>
    </div>
    
    <div class="background-textareas">
      <div class="section">
        <h3>Personality Traits</h3>
        <textarea id="personality_traits" class="basic-textarea" 
                  oninput="autosave()" placeholder="Describe your character's personality traits..."></textarea>
      </div>
      
      <div class="section">
        <h3>Ideals</h3>
        <textarea id="traits_ideals" class="basic-textarea" 
                  oninput="autosave()" placeholder="What ideals drive your character?"></textarea>
      </div>
      
      <div class="section">
        <h3>Bonds</h3>
        <textarea id="traits_bonds" class="basic-textarea" 
                  oninput="autosave()" placeholder="What bonds tie your character to people, places, or events?"></textarea>
      </div>
      
      <div class="section">
        <h3>Flaws</h3>
        <textarea id="traits_flaws" class="basic-textarea" 
                  oninput="autosave()" placeholder="What flaws or weaknesses does your character have?"></textarea>
      </div>
      
      <div class="section">
        <h3>Allies & Organizations</h3>
        <textarea id="traits_allies" class="basic-textarea" 
                  oninput="autosave()" placeholder="List your character's allies and organizations they belong to..."></textarea>
      </div>
      
      <div class="section">
        <h3>Appearance</h3>
        <textarea id="traits_appearance" class="basic-textarea" 
                  oninput="autosave()" placeholder="Describe your character's physical appearance..."></textarea>
      </div>
    </div>
  </div>
  
  <!-- Spells Page -->
  <div class="page" id="page3">
    <!-- Spell Slots Tracker -->
    <div class="section">
      <h2>Spell Slots</h2>
      <div class="spells-grid">
        <div class="spell-slots-container">
          <h3>Spell Slots</h3>
          <div class="spell-level-row">
            <span class="spell-level-label">Cantrips:</span>
            <input type="number" class="spell-slot-input" id="cantrip_slots" min="0" max="20" value="0" onchange="updateSpellSlots()">
            <div class="spell-slots-used" id="cantrip_used"></div>
          </div>
          <div class="spell-level-row">
            <span class="spell-level-label">1st Level:</span>
            <input type="number" class="spell-slot-input" id="spell_slots_1" min="0" max="20" value="0" onchange="updateSpellSlots()">
            <div class="spell-slots-used" id="spell_used_1"></div>
          </div>
          <div class="spell-level-row">
            <span class="spell-level-label">2nd Level:</span>
            <input type="number" class="spell-slot-input" id="spell_slots_2" min="0" max="20" value="0" onchange="updateSpellSlots()">
            <div class="spell-slots-used" id="spell_used_2"></div>
          </div>
          <div class="spell-level-row">
            <span class="spell-level-label">3rd Level:</span>
            <input type="number" class="spell-slot-input" id="spell_slots_3" min="0" max="20" value="0" onchange="updateSpellSlots()">
            <div class="spell-slots-used" id="spell_used_3"></div>
          </div>
          <div class="spell-level-row">
            <span class="spell-level-label">4th Level:</span>
            <input type="number" class="spell-slot-input" id="spell_slots_4" min="0" max="20" value="0" onchange="updateSpellSlots()">
            <div class="spell-slots-used" id="spell_used_4"></div>
          </div>
          <div class="spell-level-row">
            <span class="spell-level-label">5th Level:</span>
            <input type="number" class="spell-slot-input" id="spell_slots_5" min="0" max="20" value="0" onchange="updateSpellSlots()">
            <div class="spell-slots-used" id="spell_used_5"></div>
          </div>
          <div class="spell-level-row">
            <span class="spell-level-label">6th Level:</span>
            <input type="number" class="spell-slot-input" id="spell_slots_6" min="0" max="20" value="0" onchange="updateSpellSlots()">
            <div class="spell-slots-used" id="spell_used_6"></div>
          </div>
          <div class="spell-level-row">
            <span class="spell-level-label">7th Level:</span>
            <input type="number" class="spell-slot-input" id="spell_slots_7" min="0" max="20" value="0" onchange="updateSpellSlots()">
            <div class="spell-slots-used" id="spell_used_7"></div>
          </div>
          <div class="spell-level-row">
            <span class="spell-level-label">8th Level:</span>
            <input type="number" class="spell-slot-input" id="spell_slots_8" min="0" max="20" value="0" onchange="updateSpellSlots()">
            <div class="spell-slots-used" id="spell_used_8"></div>
          </div>
          <div class="spell-level-row">
            <span class="spell-level-label">9th Level:</span>
            <input type="number" class="spell-slot-input" id="spell_slots_9" min="0" max="20" value="0" onchange="updateSpellSlots()">
            <div class="spell-slots-used" id="spell_used_9"></div>
          </div>
          <button onclick="resetSpellSlots()" style="margin-top: 10px; width: 100%;">Reset All Slots</button>
        </div>
        
        <!-- Spellcasting Info -->
        <div class="spell-slots-container">
          <h3>Spellcasting Info</h3>
          <div class="spell-detail-row">
            <span class="spell-detail-label">Spellcasting Ability:</span>
            <select id="spellcasting_ability" onchange="autosave()">
              <option value="int">Intelligence</option>
              <option value="wis">Wisdom</option>
              <option value="cha">Charisma</option>
            </select>
          </div>
          <div class="spell-detail-row">
            <span class="spell-detail-label">Spell Save DC:</span>
            <input type="number" id="spell_save_dc" min="0" max="30" value="8" onchange="autosave()">
          </div>
          <div class="spell-detail-row">
            <span class="spell-detail-label">Spell Attack Bonus:</span>
            <input type="number" id="spell_attack_bonus" min="0" max="20" value="0" onchange="autosave()">
          </div>
          <div class="spell-detail-row">
            <span class="spell-detail-label">Caster Type:</span>
            <select id="caster_type" onchange="autosave()">
              <option value="prepared">Prepared Caster</option>
              <option value="known">Spells Known</option>
              <option value="spellbook">Spellbook</option>
            </select>
          </div>
          <div class="spell-detail-row">
            <span class="spell-detail-label">Spells Prepared:</span>
            <input type="number" id="spells_prepared" min="0" max="50" value="0" onchange="autosave()">
          </div>
        </div>
      </div>
    </div>

    <!-- Favorites Section -->
    <div class="section">
      <h2>⭐ Favorites</h2>
      <div class="favorites-grid">
        <div class="favorites-cantrips">
          <h3>Favorite Cantrips</h3>
          <div class="spells-list-container" id="favorites_cantrips_list">
            <!-- Favorite cantrips will be populated here -->
          </div>
        </div>
        <div class="favorites-spells">
          <h3>Favorite Spells</h3>
          <div class="spells-list-container" id="favorites_spells_list">
            <!-- Favorite spells will be populated here -->
          </div>
        </div>
      </div>
    </div>

    <!-- Cantrips Section -->
    <div class="section">
      <h2>Cantrips</h2>
      <div class="spells-controls">
        <button onclick="showSpellForm('cantrip')">+ Add Cantrip</button>
        <button onclick="showImportPopup('cantrip')" style="margin-left: 10px;">Import Cantrips</button>
        <button onclick="clearAllSpells('cantrip')" class="clear-all-btn" style="margin-left: 10px;">Clear All Cantrips</button>
        <div class="spell-filter">
          <select id="cantrip_filter" onchange="filterSpells('cantrip')">
            <option value="all">All Cantrips</option>
            <option value="prepared">Prepared</option>
            <option value="known">Known</option>
            <option value="favorites">Favorites</option>
          </select>
        </div>
      </div>
      <div class="spells-list-container" id="cantrips_list">
        <!-- Cantrips will be populated here -->
      </div>
    </div>

    <!-- Spells Section -->
    <div class="section">
      <h2>Spells</h2>
      <div class="spells-controls">
        <button onclick="showSpellForm('spell')">+ Add Spell</button>
        <button onclick="showImportPopup('spell')" style="margin-left: 10px;">Import Spells</button>
        <button onclick="clearAllSpells('spell')" class="clear-all-btn" style="margin-left: 10px;">Clear All Spells</button>
        <div class="spell-filter">
          <select id="spell_level_filter" onchange="filterSpells('spell')">
            <option value="all">All Levels</option>
            <option value="1">1st Level</option>
            <option value="2">2nd Level</option>
            <option value="3">3rd Level</option>
            <option value="4">4th Level</option>
            <option value="5">5th Level</option>
            <option value="6">6th Level</option>
            <option value="7">7th Level</option>
            <option value="8">8th Level</option>
            <option value="9">9th Level</option>
          </select>
          <select id="spell_school_filter" onchange="filterSpells('spell')">
            <option value="all">All Schools</option>
            <option value="Abjuration">Abjuration</option>
            <option value="Conjuration">Conjuration</option>
            <option value="Divination">Divination</option>
            <option value="Enchantment">Enchantment</option>
            <option value="Evocation">Evocation</option>
            <option value="Illusion">Illusion</option>
            <option value="Necromancy">Necromancy</option>
            <option value="Transmutation">Transmutation</option>
          </select>
          <select id="spell_status_filter" onchange="filterSpells('spell')">
            <option value="all">All Spells</option>
            <option value="prepared">Prepared</option>
            <option value="known">Known</option>
            <option value="ritual">Ritual</option>
            <option value="favorites">Favorites</option>
          </select>
        </div>
      </div>
      <div class="spells-list-container" id="spells_list">
        <!-- Spells will be populated here -->
      </div>
    </div>

    <!-- Spell Notes -->
    <div class="section">
      <h2>Spell Notes</h2>
      <textarea id="spell_notes" class="basic-textarea" 
                oninput="autosave()" placeholder="Enter additional spell notes, homebrew rules, or spell modifications here..."></textarea>
    </div>
  </div>
  
  <!-- Inventory Page -->
  <div class="page" id="page4">
    <!-- Equipment section first -->
    <div class="section">
      <h2>Equipment</h2>
      <table id="equipment_table_inventory">
        <thead>
          <tr>
            <th>Name</th>
            <th>Type</th>
            <th>Bonus</th>
            <th>Weight</th>
            <th>Notes</th>
            <th></th> <!-- For remove button -->
          </tr>
        </thead>
        <tbody>
          <!-- Equipment will be added here -->
        </tbody>
      </table>
      <button onclick="showEquipmentPopup()" style="margin-top: 10px;">+ Add Equipment</button>
      <div class="weight-display" id="equipment_weight_total">Total: 0 lbs / 0 kg</div>
    </div>
    
    <!-- Main inventory second -->
    <div class="section">
      <div class="inventory-controls">
        <h2>Inventory</h2>
        <div>
          Gold: <input id="gold_field" oninput="autosave()" style="width:100px;" type="number" value="0"/>
        </div>
      </div>
      
      <table id="inventory_table">
        <thead>
          <tr>
            <th>Item</th>
            <th>Description</th>
            <th>Notes</th>
            <th>Weight (lbs)</th>
            <th>Weight (kg)</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <!-- Inventory items will be added here -->
        </tbody>
      </table>
      <button onclick="showAddItemPopup()" style="margin-top: 10px;">+ Add Item</button>
      <div class="weight-display" id="inventory_weight_total">Total: 0 lbs / 0 kg</div>
    </div>
    
    <!-- Extra containers last -->
    <div id="extra_containers">
      <!-- Additional containers will be added here -->
    </div>
    
    <div class="section">
      <h3>Add New Storage</h3>
      <label>Container Name:</label>
      <input id="container_name" type="text" placeholder="e.g. Backpack, Bag of Holding"/>
      
      <label>Max Weight (lbs):</label>
      <input id="container_max_weight" type="number" placeholder="0 for unlimited"/>
      
      <button onclick="addExtraContainer()" style="margin-top: 10px;">+ Add Storage</button>
    </div>
  </div>
  
  <!-- Notes Page -->
  <div class="page" id="page6">
    <div class="section">
      <h2>General Notes</h2>
      <textarea id="general_notes" class="basic-textarea" 
                oninput="autosave()" placeholder="Enter general notes about your character or campaign..."></textarea>
    </div>
    
    <div class="section">
      <h2>Quest Log</h2>
      <textarea id="quest_log" class="basic-textarea" 
                oninput="autosave()" placeholder="Track your quests and objectives here..."></textarea>
    </div>
    
    <div class="section">
      <h2>NPC Notes</h2>
      <textarea id="npc_notes" class="basic-textarea" 
                oninput="autosave()" placeholder="Record information about NPCs you encounter..."></textarea>
    </div>
  </div>
</div>

<!-- Popups -->
<div class="popup-backdrop" id="popupBackdrop"></div>

<!-- HP Adjustment Popup -->
<div class="popup" id="hpPopup">
  <h3>Adjust HP</h3>
  <label>Amount:</label>
  <input type="number" id="hp_adjust_amount" value="1"/>
  <div style="margin-top: 15px; display: flex; justify-content: space-between;">
    <button onclick="adjustHP(1)">Add HP</button>
    <button onclick="adjustHP(-1)">Remove HP</button>
    <button onclick="closePopup('hpPopup')">Cancel</button>
  </div>
</div>

<!-- Condition Popup -->
<div class="popup" id="conditionPopup">
  <h3>Add Condition</h3>
  <label>Condition Name:</label>
  <input type="text" id="condition_name" placeholder="e.g. Poisoned"/>
  
  <label>Duration (turns):</label>
  <input type="number" id="condition_turns" placeholder="Leave blank for indefinite"/>
  
  <label>Effect:</label>
  <textarea id="condition_effect" placeholder="Describe the effect"></textarea>
  
  <label>Color:</label>
  <select id="condition_color">
    <option value="red">Red</option>
    <option value="blue">Blue</option>
    <option value="green">Green</option>
  </select>
  
  <div style="margin-top: 15px; display: flex; justify-content: space-between;">
    <button onclick="addCondition()">Add Condition</button>
    <button onclick="closePopup('conditionPopup')">Cancel</button>
  </div>
</div>

<!-- Notes Editor Popup -->
<div class="popup" id="notesPopup">
  <h3 id="notesPopupTitle">Edit Notes</h3>
  <textarea id="notesPopupTextarea" rows="12"></textarea>
  <input type="hidden" id="notesPopupTargetId"/>
  <div style="margin-top: 15px; display: flex; justify-content: space-between;">
    <button onclick="saveNotes()">Save</button>
    <button onclick="closePopup('notesPopup')">Cancel</button>
  </div>
</div>

<!-- Add Item Popup -->
<div class="popup" id="addItemPopup">
  <h3>Add Inventory Item</h3>
  <label>Item Name:</label>
  <input type="text" id="item_name" placeholder="e.g. Health Potion"/>
  
  <label>Description:</label>
  <input type="text" id="item_description" placeholder="Brief description"/>
  
  <label>Notes:</label>
  <textarea id="item_notes" placeholder="Any special notes" style="min-height: 100px;"></textarea>
  
  <label>Weight (lbs):</label>
  <input type="number" id="item_weight" step="0.1" placeholder="0.1"/>
  
  <label>Container:</label>
  <select id="item_container">
    <option value="main">Main Inventory</option>
    <!-- Additional containers will be added here dynamically -->
  </select>
  
  <div style="margin-top: 15px; display: flex; justify-content: space-between;">
    <button onclick="addInventoryItem()">Add Item</button>
    <button onclick="closePopup('addItemPopup')">Cancel</button>
  </div>
</div>

<!-- Weapons Editor Popup -->
<div class="popup" id="weaponsPopup">
  <h3>Edit Weapons</h3>
  <table id="weapons_table_popup" style="width: 100%;">
    <thead>
      <tr>
        <th>Weapon</th>
        <th>To Hit</th>
        <th>Dmg</th>
        <th>Bonus Dmg</th>
        <th>Notes</th>
        <th>Properties</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <!-- Weapons will be added here -->
    </tbody>
  </table>
  <button onclick="addWeapon()" style="margin-top: 10px;">+ Add Weapon</button>
  <div style="margin-top: 15px; display: flex; justify-content: space-between;">
    <button onclick="updateWeaponsPreview(); closePopup('weaponsPopup')">Save</button>
    <button onclick="closePopup('weaponsPopup')">Cancel</button>
  </div>
</div>

<!-- Equipment Editor Popup -->
<div class="popup" id="equipmentPopup">
  <h3>Edit Equipment</h3>
  <table id="equipment_table_popup" style="width: 100%;">
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Bonus</th>
        <th>Weight</th>
        <th>Notes</th>
        <th></th> <!-- For remove button -->
      </tr>
    </thead>
    <tbody>
      <!-- Equipment will be added here -->
    </tbody>
  </table>
  <button onclick="addEquipment()" style="margin-top: 10px;">+ Add Equipment</button>
  <div style="margin-top: 15px; display: flex; justify-content: space-between;">
    <button onclick="updateEquipmentPreviews(); closePopup('equipmentPopup')">Save</button>
    <button onclick="closePopup('equipmentPopup')">Cancel</button>
  </div>
</div>

<!-- Item Details Popup -->
<div class="popup" id="itemDetailsPopup">
  <h3 id="itemDetailsTitle">Item Details</h3>
  <div id="itemDetailsContent"></div>
  <div style="margin-top: 15px;">
    <button onclick="closePopup('itemDetailsPopup')">Close</button>
  </div>
</div>

<!-- Spell Details Popup -->
<div class="popup" id="spellDetailsPopup">
  <h3 id="spellDetailsTitle">Spell Details</h3>
  <div id="spellDetailsContent">
    <div class="spell-detail-row">
      <span class="spell-detail-label">Name:</span>
      <span class="spell-detail-value" id="spellDetailName"></span>
    </div>
    <div class="spell-detail-row">
      <span class="spell-detail-label">Level:</span>
      <span class="spell-detail-value" id="spellDetailLevel"></span>
    </div>
    <div class="spell-detail-row">
      <span class="spell-detail-label">School:</span>
      <span class="spell-detail-value" id="spellDetailSchool"></span>
    </div>
    <div class="spell-detail-row">
      <span class="spell-detail-label">Casting Time:</span>
      <span class="spell-detail-value" id="spellDetailCastingTime"></span>
    </div>
    <div class="spell-detail-row">
      <span class="spell-detail-label">Range:</span>
      <span class="spell-detail-value" id="spellDetailRange"></span>
    </div>
    <div class="spell-detail-row">
      <span class="spell-detail-label">Components:</span>
      <span class="spell-detail-value" id="spellDetailComponents"></span>
    </div>
    <div class="spell-detail-row">
      <span class="spell-detail-label">Duration:</span>
      <span class="spell-detail-value" id="spellDetailDuration"></span>
    </div>
    <div class="spell-detail-row">
      <span class="spell-detail-label">Damage:</span>
      <span class="spell-detail-value" id="spellDetailDamage"></span>
    </div>
    <div class="spell-detail-row">
      <span class="spell-detail-label">Save:</span>
      <span class="spell-detail-value" id="spellDetailSave"></span>
    </div>
    <div class="spell-detail-row">
      <span class="spell-detail-label">Attack:</span>
      <span class="spell-detail-value" id="spellDetailAttack"></span>
    </div>
    <div class="spell-detail-row">
      <span class="spell-detail-label">Ritual:</span>
      <span class="spell-detail-value" id="spellDetailRitual"></span>
    </div>
    <div class="spell-detail-row">
      <span class="spell-detail-label">Concentration:</span>
      <span class="spell-detail-value" id="spellDetailConcentration"></span>
    </div>
    <div class="spell-description" id="spellDetailDescription"></div>
    <div class="spell-detail-row" id="spellDetailWikiLink" style="display: none;">
      <span class="spell-detail-label">D&D Wiki:</span>
      <span class="spell-detail-value">
        <a id="spellWikiLink" href="#" target="_blank" style="color: #4CAF50; text-decoration: underline;">View on D&D Beyond</a>
      </span>
    </div>
  </div>
  <div style="margin-top: 15px;">
    <button onclick="closePopup('spellDetailsPopup')">Close</button>
  </div>
</div>

<!-- Add/Edit Spell Popup -->
<div class="popup" id="spellFormPopup">
  <h3 id="spellFormTitle">Add Spell</h3>
  <form id="spellForm" onsubmit="saveSpell(event)">
    <div class="spell-form-grid">
      <div>
        <label>Name:</label>
        <input type="text" id="spellName" required>
      </div>
      <div>
        <label>Level:</label>
        <select id="spellLevel" required>
          <option value="0">Cantrip</option>
          <option value="1">1st Level</option>
          <option value="2">2nd Level</option>
          <option value="3">3rd Level</option>
          <option value="4">4th Level</option>
          <option value="5">5th Level</option>
          <option value="6">6th Level</option>
          <option value="7">7th Level</option>
          <option value="8">8th Level</option>
          <option value="9">9th Level</option>
        </select>
      </div>
      <div>
        <label>School:</label>
        <select id="spellSchool" required>
          <option value="Abjuration">Abjuration</option>
          <option value="Conjuration">Conjuration</option>
          <option value="Divination">Divination</option>
          <option value="Enchantment">Enchantment</option>
          <option value="Evocation">Evocation</option>
          <option value="Illusion">Illusion</option>
          <option value="Necromancy">Necromancy</option>
          <option value="Transmutation">Transmutation</option>
        </select>
      </div>
      <div>
        <label>Casting Time:</label>
        <input type="text" id="spellCastingTime" placeholder="e.g., 1 action">
      </div>
      <div>
        <label>Range:</label>
        <input type="text" id="spellRange" placeholder="e.g., 60 feet">
      </div>
      <div>
        <label>Components:</label>
        <input type="text" id="spellComponents" placeholder="V, S, M">
      </div>
      <div>
        <label>Duration:</label>
        <input type="text" id="spellDuration" placeholder="e.g., Instantaneous">
      </div>
      <div>
        <label>Damage:</label>
        <input type="text" id="spellDamage" placeholder="e.g., 1d10 fire damage">
      </div>
      <div>
        <label>Save:</label>
        <input type="text" id="spellSave" placeholder="e.g., Dex save">
      </div>
      <div>
        <label>Attack:</label>
        <input type="text" id="spellAttack" placeholder="e.g., Ranged spell attack">
      </div>
      <div class="spell-form-full">
        <label>
          <input type="checkbox" id="spellRitual"> Ritual
        </label>
        <label>
          <input type="checkbox" id="spellConcentration"> Concentration
        </label>
        <label>
          <input type="checkbox" id="spellPrepared"> Prepared
        </label>
      </div>
      <div class="spell-form-full">
        <label>Description:</label>
        <textarea id="spellDescription" rows="6" placeholder="Enter the full spell description..."></textarea>
      </div>
      <div class="spell-form-full">
        <label>D&D Wiki Link (optional):</label>
        <input type="url" id="spellWikiLink" placeholder="https://www.dndbeyond.com/spells/spell-name">
      </div>
      <div class="spell-form-actions">
        <button type="button" onclick="closePopup('spellFormPopup')">Cancel</button>
        <button type="submit">Save Spell</button>
      </div>
    </div>
  </form>
</div>

<!-- Import Spells Popup -->
<div class="popup" id="importSpellsPopup">
  <h3 id="importSpellsTitle">Import Spells</h3>
  <div class="import-content">
    <div class="class-selection">
      <h4>Select Classes and Levels:</h4>
      <div id="classLevelContainer">
        <!-- Class/level selections will be added here -->
      </div>
      <button onclick="addClassLevel()" style="margin-top: 10px;">+ Add Another Class</button>
    </div>
    <div class="import-preview">
      <h4>Spells to Import:</h4>
      <div id="importPreview" style="max-height: 200px; overflow-y: auto; background: #2a2a2a; padding: 10px; border-radius: 4px;">
        <!-- Preview will be shown here -->
      </div>
    </div>
  </div>
  <div style="margin-top: 15px;">
    <button onclick="executeImport()">Import Selected Spells</button>
    <button onclick="closePopup('importSpellsPopup')">Cancel</button>
  </div>
</div>

<!-- Script Section -->
<script>
// Auto-resize containers when textareas change
function setupAutoResize() {
  document.querySelectorAll('.section textarea').forEach(textarea => {
    textarea.addEventListener('input', function() {
      const section = this.closest('.section');
      if (this.scrollHeight > section.clientHeight) {
        section.style.height = `${this.scrollHeight + 30}px`; // Add some padding
      }
      if (this.scrollWidth > section.clientWidth) {
        section.style.width = `${this.scrollWidth + 30}px`;
      }
    });
  });
}

function loadLayout() {
  console.log("loadLayout function called.");
  // Add layout loading logic here if needed
}

// Enable resizable containers
function makeContainersResizable() {
  document.querySelectorAll('.section').forEach(section => {
    section.classList.add('resizable-container');
    
    // Store initial size for reset functionality
    if (!section.dataset.originalWidth) {
      section.dataset.originalWidth = section.style.width || 'auto';
      section.dataset.originalHeight = section.style.height || 'auto';
    }
  });
}

// ========== GLOBAL VARIABLES ==========
let weaponsData = [];
let equipmentData = [];
let currentCharacter = null;
let deleteState = 0;

// ========== THEME MANAGEMENT ==========
function toggleTheme() {
  const themeToggle = document.getElementById('themeToggle');
  if (themeToggle.checked) {
    document.documentElement.setAttribute('data-theme', 'light');
    localStorage.setItem('dndTheme', 'light');
  } else {
    document.documentElement.removeAttribute('data-theme');
    localStorage.setItem('dndTheme', 'dark');
  }
}

function updateAccentColor(color) {
  document.documentElement.style.setProperty('--accent', color);
  localStorage.setItem('dndAccentColor', color);
}

function loadThemeSettings() {
  // Load theme preference
  const savedTheme = localStorage.getItem('dndTheme');
  const themeToggle = document.getElementById('themeToggle');
  
  if (savedTheme === 'light') {
    document.documentElement.setAttribute('data-theme', 'light');
    if (themeToggle) themeToggle.checked = true;
  } else {
    document.documentElement.removeAttribute('data-theme');
    if (themeToggle) themeToggle.checked = false;
  }
  
  // Load accent color
  const savedAccentColor = localStorage.getItem('dndAccentColor');
  if (savedAccentColor) {
    document.documentElement.style.setProperty('--accent', savedAccentColor);
    const colorPicker = document.getElementById('accentColor');
    if (colorPicker) colorPicker.value = savedAccentColor;
  }
}

// ========== INITIALIZATION ==========
window.onload = function() {
  // Initialize character system
  loadCharacterList();
  
  // Initialize theme system
  loadThemeSettings();

  // Try to load last used character or first in list; if none, auto-create one
  const characters = JSON.parse(localStorage.getItem('dndCharacters')) || [];
  if (characters.length > 0) {
    currentCharacter = characters[0].id;
    loadData();
    document.querySelector('.tab[data-tab="page1"]').click(); // Start on Stats page
  } else {
    // Auto-create a default character so autosave works immediately
    const defaultChar = {
      id: Date.now().toString(),
      name: 'New Character',
      data: { characterInfo: { name: 'New Character' }, page1: {}, page2: {}, page3: {}, page4: {}, page6: {}, weapons: [], equipment: [] }
    };
    localStorage.setItem('dndCharacters', JSON.stringify([defaultChar]));
    currentCharacter = defaultChar.id;
    loadCharacterList();
    loadData();
    document.querySelector('.tab[data-tab="page1"]').click();
  }
  
  // Initialize portrait functionality (guard if elements absent)
  const portraitUpload = document.getElementById('portraitUpload');
  const portraitPreview = document.getElementById('portraitPreview');
  if (portraitUpload && portraitPreview) {
    portraitUpload.addEventListener('change', handlePortraitUpload);
    portraitPreview.addEventListener('click', function() {
      portraitUpload.click();
    });
  }
  
  // Initialize weapons and equipment if empty
  if (weaponsData.length === 0) {
    weaponsData.push({ name: '', toHit: '', damage: '', bonusDamage: '', notes: '', properties: '' });
    updateWeaponsPreview();
  }
  
  if (equipmentData.length === 0) {
    equipmentData.push({ name: '', type: '', bonus: '', weight: 0, notes: '' });
    updateEquipmentPreviews();
  }
  
  // Update weights
  updateWeight();
  document.querySelectorAll('#extra_containers .section').forEach(container => {
    updateContainerWeight(container.id);
  });

 // Enable resizing
makeContainersResizable();
setupAutoResize();
loadLayout(); // This should come after all elements are created
};

// ========== CHARACTER MANAGEMENT ==========
function showHomePage() {
  document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
  document.getElementById('home').classList.add('active');
  document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
}

function createNewCharacter() {
  const charName = document.getElementById('newCharName').value.trim();
  if (!charName) {
    alert("Please enter a character name");
    return;
  }
  
  const newChar = {
    id: Date.now().toString(),
    name: charName,
    data: {
      characterInfo: { name: charName },
      page1: {},
      page2: {},
      page3: {},
      page4: {},
      page6: {},
      weapons: [],
      equipment: []
    }
  };
  
  let characters = JSON.parse(localStorage.getItem('dndCharacters')) || [];
  characters.push(newChar);
  localStorage.setItem('dndCharacters', JSON.stringify(characters));
  
  currentCharacter = newChar.id;
  loadCharacterList();
  loadData();
  document.querySelector('.tab[data-tab="page1"]').click();
  document.getElementById('newCharName').value = '';
}

function loadCharacterList() {
  const characters = JSON.parse(localStorage.getItem('dndCharacters')) || [];
  const select = document.getElementById('characterList');
  select.innerHTML = '';
  
  if (characters.length === 0) {
    const option = document.createElement('option');
    option.textContent = "No characters found";
    select.appendChild(option);
    select.disabled = true;
    return;
  }
  
  select.disabled = false;
  characters.forEach(char => {
    const option = document.createElement('option');
    option.value = char.id;
    option.textContent = char.name;
    if (char.id === currentCharacter) option.selected = true;
    select.appendChild(option);
  });
}

function loadSelectedCharacter() {
  const select = document.getElementById('characterList');
  const charId = select.value;
  if (!charId) return;
  
  currentCharacter = charId;
  loadData();
  document.querySelector('.tab[data-tab="page1"]').click();
}

function initiateDelete() {
  const btn = document.getElementById('deleteBtn');
  const input = document.getElementById('deleteConfirmInput');
  const count = document.getElementById('deleteCharCount');
  
  deleteState++;
  
  if (deleteState === 1) {
    const charName = document.getElementById('char_name').value || 'Character';
    btn.textContent = `Delete ${charName}?`;
    btn.classList.add('warning');
  } else if (deleteState === 2) {
    btn.textContent = 'CONFIRM DELETE!';
    btn.classList.remove('warning');
    btn.classList.add('danger');
  } else if (deleteState === 3) {
    btn.textContent = 'DELETE FOREVER';
    input.style.display = 'block';
    count.style.display = 'inline';
    input.focus();
    
    input.oninput = function() {
      count.textContent = `${input.value.length}/6`;
      btn.disabled = input.value !== 'DELETE';
    };
  } else if (deleteState === 4 && input.value === 'DELETE') {
    const charName = document.getElementById('char_name').value || 'character';
    const characters = JSON.parse(localStorage.getItem('dndCharacters')) || [];
    const updatedChars = characters.filter(char => char.id !== currentCharacter);
    
    localStorage.setItem('dndCharacters', JSON.stringify(updatedChars));
    resetDeleteUI();
    loadCharacterList();
    alert(`${charName} deleted permanently`);
    
    if (updatedChars.length > 0) {
      currentCharacter = updatedChars[0].id;
      loadData();
      document.querySelector('.tab[data-tab="page1"]').click();
    } else {
      currentCharacter = null;
      showHomePage();
    }
  }
}

function resetDeleteUI() {
  const btn = document.getElementById('deleteBtn');
  const input = document.getElementById('deleteConfirmInput');
  const count = document.getElementById('deleteCharCount');
  
  deleteState = 0;
  btn.textContent = 'Delete Character';
  btn.classList.remove('warning', 'danger');
  btn.disabled = false;
  input.style.display = 'none';
  input.value = '';
  count.style.display = 'none';
}

// ========== EXISTING FUNCTIONALITY (UPDATED FOR CHARACTER SYSTEM) ==========
function autosave() {
  // Ensure a character target exists
  if (!currentCharacter) {
    let characters = JSON.parse(localStorage.getItem('dndCharacters')) || [];
    if (characters.length === 0) {
      const defaultChar = {
        id: Date.now().toString(),
        name: 'New Character',
        data: { characterInfo: { name: 'New Character' }, page1: {}, page2: {}, page3: {}, page4: {}, page6: {}, weapons: [], equipment: [] }
      };
      characters = [defaultChar];
      localStorage.setItem('dndCharacters', JSON.stringify(characters));
      currentCharacter = defaultChar.id;
      loadCharacterList();
    } else {
      currentCharacter = characters[0].id;
    }
  }
  
  const characters = JSON.parse(localStorage.getItem('dndCharacters')) || [];
  const charIndex = characters.findIndex(char => char.id === currentCharacter);
  if (charIndex === -1) return;
  
  const data = {
    characterInfo: {
      name: document.getElementById('char_name').value,
      race: document.getElementById('char_race').value,
      class: document.getElementById('char_class').value,
      subclass: document.getElementById('char_subclass').value,
      level: document.getElementById('char_level').value
    },
    actionTracker: {
      actions: document.getElementById('action_counter').value,
      actionUsed: document.getElementById('action_tick').checked,
      bonusActions: document.getElementById('bonus_action_counter').value,
      bonusActionUsed: document.getElementById('bonus_action_tick').checked
    },
    page1: {
    abilities: ['str','dex','con','int','wis','cha'].reduce((obj,ability) => {
  obj[ability] = document.getElementById(ability).value;
  obj[`${ability}_bonus`] = document.getElementById(`${ability}_bonus`).value;
  // Add this line for saving throws:
  obj[`${ability}_save`] = document.getElementById(`${ability}_save`).value;
  return obj;
}, {}),
      combatStats: {
        ac: document.getElementById('ac').value,
        initiative: document.getElementById('initiative').value,
        speed: document.getElementById('speed').value,
        prof_bonus: document.getElementById('prof_bonus').value
      },

      health: {
        max_hp: document.getElementById('max_hp').value,
        curr_hp: document.getElementById('curr_hp').value
      },
      skills: ['acrobatics','animal_handling','arcana','athletics','deception','history',
               'insight','intimidation','investigation','medicine','nature','perception',
               'performance','persuasion','religion','sleight_of_hand','stealth','survival']
               .reduce((obj,skill) => {
        obj[`prof_${skill}`] = document.getElementById(`prof_${skill}`).checked;
        obj[`bonus_${skill}`] = document.getElementById(`bonus_${skill}`).value;
        return obj;
      }, {}),
      deathSaves: {
        success: [
          document.getElementById('death_save_success_1').checked,
          document.getElementById('death_save_success_2').checked,
          document.getElementById('death_save_success_3').checked
        ],
        failure: [
          document.getElementById('death_save_failure_1').checked,
          document.getElementById('death_save_failure_2').checked,
          document.getElementById('death_save_failure_3').checked
        ]
      },
      actionsFeatures: document.getElementById('actions_features').value,
      proficienciesTraining: document.getElementById('proficiencies_training').value,
      statsQuickNotes: document.getElementById('stats_quick_notes').value
    },
    page2: {
      portrait: document.getElementById('portraitPreview').querySelector('img')?.src || null,
      backstory: document.getElementById('char_backstory').value,
      traits: {
        personality: document.getElementById('personality_traits').value,
        ideals: document.getElementById('traits_ideals').value,
        bonds: document.getElementById('traits_bonds').value,
        flaws: document.getElementById('traits_flaws').value,
        allies: document.getElementById('traits_allies').value,
        appearance: document.getElementById('traits_appearance').value
      }
    },
    page3: {
      spellNotes: document.getElementById('spell_notes').value,
      spellcastingInfo: {
        ability: document.getElementById('spellcasting_ability').value,
        saveDC: document.getElementById('spell_save_dc').value,
        attackBonus: document.getElementById('spell_attack_bonus').value,
        casterType: document.getElementById('caster_type').value,
        spellsPrepared: document.getElementById('spells_prepared').value
      },
      spellSlots: {
        cantrip: document.getElementById('cantrip_slots').value,
        1: document.getElementById('spell_slots_1').value,
        2: document.getElementById('spell_slots_2').value,
        3: document.getElementById('spell_slots_3').value,
        4: document.getElementById('spell_slots_4').value,
        5: document.getElementById('spell_slots_5').value,
        6: document.getElementById('spell_slots_6').value,
        7: document.getElementById('spell_slots_7').value,
        8: document.getElementById('spell_slots_8').value,
        9: document.getElementById('spell_slots_9').value
      },
      spellSlotsUsed: spellSlotsUsed,
      spellsData: spellsData,
      favoritesData: favoritesData
    },
    page4: {
      gold: document.getElementById('gold_field').value,
      equipment: equipmentData,
      inventory: Array.from(document.querySelectorAll('#inventory_table tbody tr')).map(row => ({
        name: row.cells[0].textContent,
        description: row.cells[1].textContent,
        notes: row.cells[2].textContent,
        weight: parseFloat(row.cells[3].textContent) || 0
      })),
      containers: Array.from(document.querySelectorAll('#extra_containers .section')).map(container => ({
        name: container.querySelector('h3').textContent,
        maxWeight: container.querySelector('div').textContent.includes('Max Weight') ? 
                   parseInt(container.querySelector('div').textContent.match(/\d+/)[0]) : 0,
        items: Array.from(container.querySelectorAll('tbody tr')).map(row => ({
          name: row.cells[0].textContent,
          description: row.cells[1].textContent,
          notes: row.cells[2].textContent,
          weight: parseFloat(row.cells[3].textContent) || 0
        }))
      }))
    },
    page6: {
      generalNotes: document.getElementById('general_notes').value,
      questLog: document.getElementById('quest_log').value,
      npcNotes: document.getElementById('npc_notes').value
    },
    weapons: weaponsData,
    conditions: Array.from(document.querySelectorAll('#conditions_container .condition')).map(condition => ({
      name: condition.querySelector('.condition-header').children[0].textContent,
      turns: condition.querySelector('.condition-header').children[1].textContent,
      effect: condition.children[1].textContent,
      color: condition.classList.contains('blue') ? 'blue' : 
             condition.classList.contains('green') ? 'green' : 'red'
    }))
  };
  
  characters[charIndex].data = data;
  characters[charIndex].name = document.getElementById('char_name').value || 'Unnamed';
  localStorage.setItem('dndCharacters', JSON.stringify(characters));
}

function loadData() {
  if (!currentCharacter) return;
  
  const characters = JSON.parse(localStorage.getItem('dndCharacters')) || [];
  const character = characters.find(char => char.id === currentCharacter);
  if (!character) return;
  
  const data = character.data;
  
  // Character Info
  if (data.characterInfo) {
    document.getElementById('char_name').value = data.characterInfo.name || '';
    document.getElementById('char_race').value = data.characterInfo.race || '';
    document.getElementById('char_class').value = data.characterInfo.class || '';
    document.getElementById('char_subclass').value = data.characterInfo.subclass || '';
    document.getElementById('char_level').value = data.characterInfo.level || '';
  }

  // Action Tracker
  if (data.actionTracker) {
    document.getElementById('action_counter').value = data.actionTracker.actions || 0;
    document.getElementById('action_tick').checked = data.actionTracker.actionUsed || false;
    document.getElementById('bonus_action_counter').value = data.actionTracker.bonusActions || 0;
    document.getElementById('bonus_action_tick').checked = data.actionTracker.bonusActionUsed || false;
  }

  // Page 1: Stats
  if (data.page1) {
    // Abilities
    for (const ability in data.page1.abilities) {
      const element = document.getElementById(ability);
      if (element) element.value = data.page1.abilities[ability];
  // Add these lines for saving throws:
  const saveElement = document.getElementById(`${ability}_save`);
  if (saveElement) saveElement.value = data.page1.abilities[`${ability}_save`] || '';

    }
    
    // Combat Stats
    if (data.page1.combatStats) {
      document.getElementById('ac').value = data.page1.combatStats.ac || '';
      document.getElementById('initiative').value = data.page1.combatStats.initiative || '';
      document.getElementById('speed').value = data.page1.combatStats.speed || '';
      document.getElementById('prof_bonus').value = data.page1.combatStats.prof_bonus || '';
    }

    // Health
    if (data.page1.health) {
      document.getElementById('max_hp').value = data.page1.health.max_hp || '';
      document.getElementById('curr_hp').value = data.page1.health.curr_hp || '';
    }
    
    // Skills
    if (data.page1.skills) {
      for (const skill in data.page1.skills) {
        if (skill.startsWith('prof_')) {
          const checkbox = document.getElementById(skill);
          if (checkbox) checkbox.checked = data.page1.skills[skill];
        } else if (skill.startsWith('bonus_')) {
          const input = document.getElementById(skill);
          if (input) input.value = data.page1.skills[skill];
        }
      }
    }
    
    // Death Saves
    if (data.page1.deathSaves) {
      for (let i = 0; i < 3; i++) {
        if (data.page1.deathSaves.success[i]) {
          document.getElementById(`death_save_success_${i+1}`).checked = true;
        }
        if (data.page1.deathSaves.failure[i]) {
          document.getElementById(`death_save_failure_${i+1}`).checked = true;
        }
      }
    }
    
    // Actions & Features
    if (data.page1.actionsFeatures) {
      document.getElementById('actions_features').value = data.page1.actionsFeatures;
    }
    
    // Proficiencies & Training
    if (data.page1.proficienciesTraining) {
      document.getElementById('proficiencies_training').value = data.page1.proficienciesTraining;
    }
    
    // Quick Notes
    if (data.page1.statsQuickNotes) {
      document.getElementById('stats_quick_notes').value = data.page1.statsQuickNotes;
    }
  }
  
  // Page 2: Background
  if (data.page2) {
    // Portrait
    if (data.page2.portrait) {
      const img = document.createElement('img');
      img.src = data.page2.portrait;
      img.style.maxWidth = '100%';
      img.style.maxHeight = '100%';
      document.getElementById('portraitPreview').innerHTML = '';
      document.getElementById('portraitPreview').appendChild(img);
    }
    
    // Backstory
    if (data.page2.backstory) {
      document.getElementById('char_backstory').value = data.page2.backstory;
    }
    
    // Traits
    if (data.page2.traits) {
      document.getElementById('personality_traits').value = data.page2.traits.personality || '';
      document.getElementById('traits_ideals').value = data.page2.traits.ideals || '';
      document.getElementById('traits_bonds').value = data.page2.traits.bonds || '';
      document.getElementById('traits_flaws').value = data.page2.traits.flaws || '';
      document.getElementById('traits_allies').value = data.page2.traits.allies || '';
      document.getElementById('traits_appearance').value = data.page2.traits.appearance || '';
    }
  }
  
  // Page 3: Spells
  if (data.page3) {
    if (data.page3.spellNotes) {
    document.getElementById('spell_notes').value = data.page3.spellNotes;
    }
    
    // Load spellcasting info
    if (data.page3.spellcastingInfo) {
      document.getElementById('spellcasting_ability').value = data.page3.spellcastingInfo.ability || 'int';
      document.getElementById('spell_save_dc').value = data.page3.spellcastingInfo.saveDC || '8';
      document.getElementById('spell_attack_bonus').value = data.page3.spellcastingInfo.attackBonus || '0';
      document.getElementById('caster_type').value = data.page3.spellcastingInfo.casterType || 'prepared';
      document.getElementById('spells_prepared').value = data.page3.spellcastingInfo.spellsPrepared || '0';
    }
    
    // Load spell slots
    if (data.page3.spellSlots) {
      document.getElementById('cantrip_slots').value = data.page3.spellSlots.cantrip || '0';
      for (let i = 1; i <= 9; i++) {
        const element = document.getElementById(`spell_slots_${i}`);
        if (element) element.value = data.page3.spellSlots[i] || '0';
      }
    }
    
    // Load spell slots used
    if (data.page3.spellSlotsUsed) {
      spellSlotsUsed = data.page3.spellSlotsUsed;
    }
    
    // Load spells data
    if (data.page3.spellsData) {
      spellsData = data.page3.spellsData;
    }
    
    // Load favorites data
    if (data.page3.favoritesData) {
      favoritesData = data.page3.favoritesData;
    }
    
    // Update spell system
    updateSpellSlots();
    renderSpells();
  }
  
  // Page 4: Inventory
  if (data.page4) {
    // Gold
    if (data.page4.gold) {
      document.getElementById('gold_field').value = data.page4.gold;
    }
    
    // Equipment
    if (data.page4.equipment) {
      equipmentData = data.page4.equipment;
      updateEquipmentPreviews();
    }
    
    // Main Inventory
    if (data.page4.inventory) {
      const tbody = document.getElementById('inventory_table').querySelector('tbody');
      tbody.innerHTML = '';
      
      data.page4.inventory.forEach(item => {
        const row = tbody.insertRow();
        row.className = 'item-row';
        row.innerHTML = `
          <td>${item.name || ''}</td>
          <td>${item.description || ''}</td>
          <td class="table-notes">${item.notes || ''}</td>
          <td>${item.weight || 0}</td>
          <td>${(item.weight * 0.453592).toFixed(2)}</td>
          <td><button onclick="this.closest('tr').remove(); updateWeight(); autosave()">Remove</button></td>
        `;
        row.onclick = () => showItemDetails(item, 'inventory');
      });
      
      updateWeight();
    }
    
    // Containers
    if (data.page4.containers) {
      const extraContainers = document.getElementById('extra_containers');
      extraContainers.innerHTML = '';
      const containerDropdown = document.getElementById('item_container');
      
      while (containerDropdown.children.length > 1) {
        containerDropdown.removeChild(containerDropdown.lastChild);
      }
      
      data.page4.containers.forEach(containerData => {
        const containerId = 'container_' + Date.now();
        const containerHTML = `
          <div class="section" id="${containerId}">
            <div class="inventory-controls">
              <h3>${containerData.name}</h3>
              ${containerData.maxWeight > 0 ? `<div>Max Weight: ${containerData.maxWeight} lbs</div>` : ''}
              <button class="delete-container-btn" onclick="confirmContainerDeletion('${containerId}')">Delete Container</button>
            </div>
            <table>
              <thead>
                <tr>
                  <th>Item</th>
                  <th>Description</th>
                  <th>Notes</th>
                  <th>Weight (lbs)</th>
                  <th>Weight (kg)</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                ${containerData.items.map(item => `
                  <tr class="item-row">
                    <td>${item.name || ''}</td>
                    <td>${item.description || ''}</td>
                    <td class="table-notes">${item.notes || ''}</td>
                    <td>${item.weight || 0}</td>
                    <td>${(item.weight * 0.453592).toFixed(2)}</td>
                    <td><button onclick="this.closest('tr').remove(); updateContainerWeight('${containerId}'); autosave()">Remove</button></td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
            <button onclick="showAddContainerItemPopup('${containerId}')" style="margin-top: 10px;">+ Add Item</button>
            <div class="weight-display">Current: ${containerData.items.reduce((sum, item) => sum + (parseFloat(item.weight) || 0), 0).toFixed(1)} lbs / 
              ${(containerData.items.reduce((sum, item) => sum + (parseFloat(item.weight) || 0), 0) * 0.453592).toFixed(1)} kg</div>
          </div>
        `;
        
        extraContainers.insertAdjacentHTML('beforeend', containerHTML);
        
        containerData.items.forEach(item => {
          const rows = document.querySelectorAll(`#${containerId} tbody tr`);
          rows.forEach(row => {
            if (row.cells[0].textContent === item.name) {
              row.onclick = () => showItemDetails(item, 'inventory');
            }
          });
        });
        
        const option = document.createElement('option');
        option.value = containerId;
        option.textContent = containerData.name;
        containerDropdown.appendChild(option);
      });
    }
  }
  
  // Page 6: Notes
  if (data.page6) {
    if (data.page6.generalNotes) {
      document.getElementById('general_notes').value = data.page6.generalNotes;
    }
    if (data.page6.questLog) {
      document.getElementById('quest_log').value = data.page6.questLog;
    }
    if (data.page6.npcNotes) {
      document.getElementById('npc_notes').value = data.page6.npcNotes;
    }
  }
  
  // Weapons
  if (data.weapons) {
    weaponsData = data.weapons;
    updateWeaponsPreview();
  }
  
  // Conditions
  if (data.conditions) {
    const container = document.getElementById('conditions_container');
    container.innerHTML = '';
    
    data.conditions.forEach(condition => {
      const conditionId = Date.now();
      const conditionHTML = `
        <div class="condition ${condition.color}" id="condition_${conditionId}">
          <div class="condition-header">
            <span>${condition.name}</span>
            <span class="condition-turns">${condition.turns}</span>
          </div>
          <div>${condition.effect}</div>
          <button onclick="removeCondition('${conditionId}')" style="float:right; padding:2px 5px; margin-top:5px;">Remove</button>
        </div>
      `;
      
      container.insertAdjacentHTML('beforeend', conditionHTML);
    });
  }
}

// ========== EXISTING FUNCTIONS (UPDATED) ==========
function exportData() {
  if (!currentCharacter) {
    alert("No character loaded to export");
    return;
  }
  
  const characters = JSON.parse(localStorage.getItem('dndCharacters')) || [];
  const character = characters.find(char => char.id === currentCharacter);
  
  if (!character) return;
  
  const blob = new Blob([JSON.stringify(character.data)], {type: 'application/json'});
  const url = URL.createObjectURL(blob);
  
  const a = document.createElement('a');
  a.href = url;
  a.download = `${character.name || 'dnd_character'}_backup.json`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

function importData(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const importedData = JSON.parse(e.target.result);
      const charName = importedData.characterInfo?.name || 'Imported Character';
      
      const newChar = {
        id: Date.now().toString(),
        name: charName,
        data: importedData
      };
      
      let characters = JSON.parse(localStorage.getItem('dndCharacters')) || [];
      characters.push(newChar);
      localStorage.setItem('dndCharacters', JSON.stringify(characters));
      
      currentCharacter = newChar.id;
      loadCharacterList();
      loadData();
      
      alert(`Character "${charName}" imported successfully!`);
      document.querySelector('.tab[data-tab="page1"]').click();
    } catch (err) {
      alert("Error importing file: " + err.message);
    }
    event.target.value = '';
  };
  reader.readAsText(file);
}

// ========== WEAPONS SYSTEM ==========
function showWeaponsPopup() {
  const tbody = document.getElementById('weapons_table_popup').querySelector('tbody');
  tbody.innerHTML = '';
  
  weaponsData.forEach((weapon, index) => {
    const row = tbody.insertRow();
    row.innerHTML = `
      <td><input type="text" value="${weapon.name || ''}" oninput="weaponsData[${index}].name = this.value"></td>
      <td><input type="text" value="${weapon.toHit || ''}" oninput="weaponsData[${index}].toHit = this.value"></td>
      <td><input type="text" value="${weapon.damage || ''}" oninput="weaponsData[${index}].damage = this.value"></td>
      <td><input type="text" value="${weapon.bonusDamage || ''}" oninput="weaponsData[${index}].bonusDamage = this.value"></td>
      <td><textarea class="table-notes" oninput="weaponsData[${index}].notes = this.value">${weapon.notes || ''}</textarea></td>
      <td><input type="text" value="${weapon.properties || ''}" oninput="weaponsData[${index}].properties = this.value"></td>
      <td><button onclick="weaponsData.splice(${index}, 1); showWeaponsPopup()">Remove</button></td>
    `;
  });
  
  showPopup('weaponsPopup');
}

function addWeapon() {
  weaponsData.push({ name: '', toHit: '', damage: '', bonusDamage: '', notes: '', properties: '' });
  showWeaponsPopup();
}

function updateWeaponsPreview() {
  const preview = document.getElementById('weapons_preview');
  preview.innerHTML = '';
  
  if (weaponsData.length === 0) {
    preview.innerHTML = '<p>No weapons added</p>';
    return;
  }
  
  const table = document.createElement('table');
  const header = table.createTHead();
  const headerRow = header.insertRow();
  headerRow.innerHTML = '<th>Weapon</th><th>To Hit</th><th>Dmg</th><th>Bonus Dmg</th><th>Notes</th><th>Properties</th>';
  
  const body = table.createTBody();
  weaponsData.forEach(weapon => {
    const row = body.insertRow();
    row.className = 'item-row';
    row.innerHTML = `
      <td>${weapon.name || '-'}</td>
      <td>${weapon.toHit || '-'}</td>
      <td>${weapon.damage || '-'}</td>
      <td>${weapon.bonusDamage || '-'}</td>
      <td>${weapon.notes || '-'}</td>
      <td>${weapon.properties || '-'}</td>
    `;
    row.onclick = () => showItemDetails(weapon, 'weapon');
  });
  
  preview.appendChild(table);
  autosave();
}

// ========== EQUIPMENT SYSTEM ==========
function showEquipmentPopup() {
  const tbody = document.getElementById('equipment_table_popup').querySelector('tbody');
  tbody.innerHTML = '';
  
  equipmentData.forEach((item, index) => {
    const row = tbody.insertRow();
    row.innerHTML = `
      <td><input type="text" value="${item.name || ''}" oninput="equipmentData[${index}].name = this.value"></td>
      <td><input type="text" value="${item.type || ''}" oninput="equipmentData[${index}].type = this.value"></td>
      <td><input type="text" value="${item.bonus || ''}" oninput="equipmentData[${index}].bonus = this.value"></td>
      <td><input type="number" value="${item.weight || 0}" step="0.1" oninput="equipmentData[${index}].weight = parseFloat(this.value) || 0"></td>
      <td><textarea class="table-notes" oninput="equipmentData[${index}].notes = this.value">${item.notes || ''}</textarea></td>
      <td><button onclick="removeEquipmentItem(${index}); showEquipmentPopup()">Remove</button></td>
    `;
  });
  
  showPopup('equipmentPopup');
}

function addEquipment() {
  equipmentData.push({ name: '', type: '', bonus: '', weight: 0, notes: '' });
  showEquipmentPopup();
}

function updateEquipmentPreviews() {

  
  // Clear both tables completely before rebuilding
  const popupTbody = document.getElementById('equipment_table_popup').querySelector('tbody');
  const inventoryTbody = document.getElementById('equipment_table_inventory').querySelector('tbody');
  const equipmentStatsPreview = document.getElementById('equipment_stats_preview');
  
  popupTbody.innerHTML = '';
  inventoryTbody.innerHTML = '';
  equipmentStatsPreview.innerHTML = ''; // Clear the stats page preview
  
  if (equipmentData.length === 0) {
    equipmentStatsPreview.innerHTML = '<p>No equipment added</p>'; // Update for stats page
    inventoryTbody.innerHTML = '<tr><td colspan="6"><p>No equipment added</p></td></tr>'; // Update for inventory page
    updateEquipmentWeight();
    autosave();
    return;
  }
  
  // Rebuild stats page preview (simpler display)
  const statsTable = document.createElement('table');
  const statsHeader = statsTable.createTHead();
  const statsHeaderRow = statsHeader.insertRow();
  statsHeaderRow.innerHTML = '<th>Name</th><th>Type</th><th>Bonus</th><th>Weight</th><th>Notes</th>';
  const statsBody = statsTable.createTBody();
  equipmentData.forEach(item => {
    const row = statsBody.insertRow();
    row.className = 'item-row';
    row.innerHTML = `
      <td>${item.name || '-'}</td>
      <td>${item.type || '-'}</td>
      <td>${item.bonus || '-'}</td>
      <td>${item.weight || 0}</td>
      <td>${item.notes || '-'}</td>
    `;
    row.onclick = () => showItemDetails(item, 'equipment');
  });
  equipmentStatsPreview.appendChild(statsTable);
  
  // Rebuild inventory table (with remove button)
  equipmentData.forEach((item, index) => {
    const row = inventoryTbody.insertRow();
    row.className = 'item-row';
    row.innerHTML = `
      <td>${item.name || ''}</td>
      <td>${item.type || ''}</td>
      <td>${item.bonus || ''}</td>
      <td>${item.weight || 0}</td>
      <td class="table-notes">${item.notes || ''}</td>
      <td><button onclick="removeEquipmentItem(${index}); updateEquipmentPreviews();">Remove</button></td>
    `;
    row.onclick = () => showItemDetails(item, 'equipment');
  });

  updateEquipmentWeight();
  autosave();
}

function removeEquipmentItem(index) {
  if (index >= 0 && index < equipmentData.length) {
    equipmentData.splice(index, 1);
    updateEquipmentPreviews();
  }
}

function updateEquipmentWeight() {
  let totalWeight = equipmentData.reduce((sum, item) => sum + (parseFloat(item.weight) || 0), 0);
  document.getElementById('equipment_weight_total').textContent = 
    `Total: ${totalWeight.toFixed(1)} lbs / ${(totalWeight * 0.453592).toFixed(1)} kg`;
}

// ========== INVENTORY FUNCTIONS ==========
function showAddItemPopup() {
  document.getElementById('item_name').value = '';
  document.getElementById('item_description').value = '';
  document.getElementById('item_notes').value = '';
  document.getElementById('item_weight').value = '';
  
  const containerDropdown = document.getElementById('item_container');
  containerDropdown.innerHTML = '<option value="main">Main Inventory</option>';
  
  document.querySelectorAll('#extra_containers .section').forEach(container => {
    const option = document.createElement('option');
    option.value = container.id;
    option.textContent = container.querySelector('h3').textContent;
    containerDropdown.appendChild(option);
  });
  
  showPopup('addItemPopup');
}

function addInventoryItem() {
  const name = document.getElementById('item_name').value;
  const description = document.getElementById('item_description').value;
  const notes = document.getElementById('item_notes').value;
  const weight = parseFloat(document.getElementById('item_weight').value) || 0;
  const containerId = document.getElementById('item_container').value;

  if (!name) {
    alert("Please enter an item name");
    return;
  }

  const item = {
    name,
    description,
    notes,
    weight
  };

  if (containerId === 'main') {
    const tbody = document.getElementById('inventory_table').querySelector('tbody');
    const row = tbody.insertRow();
    row.className = 'item-row';
    row.innerHTML = `
      <td>${name}</td>
      <td>${description}</td>
      <td class="table-notes">${notes}</td>
      <td>${weight}</td>
      <td>${(weight * 0.453592).toFixed(2)}</td>
      <td><button onclick="this.closest('tr').remove(); updateWeight(); autosave()">Remove</button></td>
    `;
    row.onclick = () => showItemDetails(item, 'inventory');
    updateWeight();
  } else {
    const container = document.getElementById(containerId);
    if (container) {
      const tbody = container.querySelector('tbody');
      const row = tbody.insertRow();
      row.className = 'item-row';
      row.innerHTML = `
        <td>${name}</td>
        <td>${(weight * 0.453592).toFixed(2)}</td>
        <td><button onclick="this.closest('tr').remove(); updateContainerWeight('${containerId}'); autosave()">Remove</button></td>
      `;
      row.onclick = () => showItemDetails(item, 'inventory');
      updateContainerWeight(containerId);
    }
  }

  closePopup('addItemPopup');
  autosave();
}

function addExtraContainer() {
  const containerName = document.getElementById('container_name').value;
  const maxWeight = document.getElementById('container_max_weight').value;
  
  if (!containerName) {
    alert("Please enter a container name");
    return;
  }
  
  const containerId = 'container_' + Date.now();
  
  const containerHTML = `
    <div class="section" id="${containerId}">
      <div class="inventory-controls">
        <h3>${containerName}</h3>
        ${maxWeight > 0 ? `<div>Max Weight: ${maxWeight} lbs</div>` : ''}
        <button class="delete-container-btn" onclick="confirmContainerDeletion('${containerId}')">Delete Container</button>
      </div>
      <table>
        <thead>
          <tr>
            <th>Item</th>
            <th>Description</th>
            <th>Notes</th>
            <th>Weight (lbs)</th>
            <th>Weight (kg)</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
        </tbody>
      </table>
      <button onclick="showAddContainerItemPopup('${containerId}')" style="margin-top: 10px;">+ Add Item</button>
      <div class="weight-display">Current: 0 lbs / 0 kg</div>
    </div>
  `;
  
  document.getElementById('extra_containers').insertAdjacentHTML('beforeend', containerHTML);
  
  const containerDropdown = document.getElementById('item_container');
  const option = document.createElement('option');
  option.value = containerId;
  option.textContent = containerName;
  containerDropdown.appendChild(option);
  
  document.getElementById('container_name').value = '';
  document.getElementById('container_max_weight').value = '';
  
  autosave();
}

function confirmContainerDeletion(containerId) {
  const container = document.getElementById(containerId);
  const deleteBtn = container.querySelector('.delete-container-btn');
  
  if (deleteBtn.classList.contains('confirm')) {
    const containerDropdown = document.getElementById('item_container');
    const option = containerDropdown.querySelector(`option[value="${containerId}"]`);
    if (option) containerDropdown.removeChild(option);
    
    container.remove();
    autosave();
  } else {
    deleteBtn.textContent = 'Confirm Delete';
    deleteBtn.classList.add('confirm');
    setTimeout(() => {
      if (deleteBtn) {
        deleteBtn.textContent = 'Delete Container';
        deleteBtn.classList.remove('confirm');
      }
    }, 3000);
  }
}

function showAddContainerItemPopup(containerId) {
  document.getElementById('item_container').value = containerId;
  showAddItemPopup();
}

// ========== WEIGHT CALCULATION FUNCTIONS ==========
function updateWeight() {
  let totalWeight = 0;
  const rows = document.querySelectorAll('#inventory_table tbody tr');
  
  rows.forEach(row => {
    const weightCell = row.cells[3];
    totalWeight += parseFloat(weightCell.textContent) || 0;
  });
  
  document.getElementById('inventory_weight_total').textContent = 
    `Total: ${totalWeight.toFixed(1)} lbs / ${(totalWeight * 0.453592).toFixed(1)} kg`;
}

function updateContainerWeight(containerId) {
  const container = document.getElementById(containerId);
  if (!container) return;
  
  let totalWeight = 0;
  const rows = container.querySelectorAll('tbody tr');
  
  rows.forEach(row => {
    const weightCell = row.cells[3];
    totalWeight += parseFloat(weightCell.textContent) || 0;
  });
  
  const weightDisplay = container.querySelector('.weight-display');
  if (weightDisplay) {
    weightDisplay.textContent = 
      `Current: ${totalWeight.toFixed(1)} lbs / ${(totalWeight * 0.453592).toFixed(1)} kg`;
    
    const maxWeightText = container.querySelector('.inventory-controls div');
    if (maxWeightText && maxWeightText.textContent.includes('Max Weight')) {
      const maxWeight = parseFloat(maxWeightText.textContent.match(/[\d.]+/)[0]);
      if (maxWeight > 0 && totalWeight > maxWeight) {
        weightDisplay.classList.add('overweight');
      } else {
        weightDisplay.classList.remove('overweight');
      }
    }
  }
  autosave();
}

// ========== PORTRAIT FUNCTIONS ==========
function handlePortraitUpload(event) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function(e) {
    const portraitPreview = document.getElementById('portraitPreview');
    portraitPreview.innerHTML = '';
    const img = document.createElement('img');
    img.src = e.target.result;
    img.style.maxWidth = '100%';
    img.style.maxHeight = '100%';
    portraitPreview.appendChild(img);
    autosave();
  };
  reader.readAsDataURL(file);
}

function removePortrait() {
  const portraitPreview = document.getElementById('portraitPreview');
  portraitPreview.innerHTML = '<span style="color: #666;">No image</span>';
  document.getElementById('portraitUpload').value = '';
  autosave();
}

// ========== POPUP FUNCTIONS ==========
function showPopup(id) {
  const popup = document.getElementById(id);
  if (!popup) return;
  
  // Reset positioning
  popup.style.top = '50%';
  popup.style.left = '50%';
  popup.style.transform = 'translate(-50%, -50%)';
  
  // Mobile adjustments
  if (window.innerWidth <= 768) {
    popup.style.width = '95vw';
    popup.style.maxHeight = '85vh';
  }
  
  popup.style.display = 'block';
  document.getElementById('popupBackdrop').style.display = 'block';
}

function closePopup(id) {
  document.getElementById(id).style.display = 'none';
  document.getElementById('popupBackdrop').style.display = 'none';
}

function closeAllPopups() {
  document.querySelectorAll('.popup').forEach(popup => {
    popup.style.display = 'none';
  });
  document.getElementById('popupBackdrop').style.display = 'none';
}

// Initialize backdrop click handler
document.getElementById('popupBackdrop').addEventListener('click', closeAllPopups);

// ========== TAB SYSTEM ==========
function switchTab(button) {
  document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
  document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
  
  button.classList.add('active');
  const tabId = button.getAttribute('data-tab');
  document.getElementById(tabId).classList.add('active');
}

// ========== HEALTH SYSTEM ==========
function adjustHP(amount) {
  const currHP = document.getElementById('curr_hp');
  let newHP = parseInt(currHP.value) + amount;
  if (isNaN(newHP)) newHP = 0;
  currHP.value = Math.max(0, newHP);
  autosave();
}

function showHPPopup() {
  document.getElementById('hp_adjust_amount').value = 1;
  showPopup('hpPopup');
}

function longRest() {
  const currHP = document.getElementById('curr_hp');
  const maxHP = document.getElementById('max_hp');
  currHP.value = maxHP.value;
  
  for (let i = 1; i <= 3; i++) {
    document.getElementById(`death_save_success_${i}`).checked = false;
    document.getElementById(`death_save_failure_${i}`).checked = false;
  }
  
  autosave();
  alert("Long rest completed - HP restored, death saves reset");
}

// ========== CONDITIONS SYSTEM ==========
function showConditionPopup() {
  document.getElementById('condition_name').value = '';
  document.getElementById('condition_turns').value = '';
  document.getElementById('condition_effect').value = '';
  document.getElementById('condition_color').value = 'red';
  showPopup('conditionPopup');
}

function addCondition() {
  const name = document.getElementById('condition_name').value;
  const turns = document.getElementById('condition_turns').value;
  const effect = document.getElementById('condition_effect').value;
  const color = document.getElementById('condition_color').value;
  
  if (!name) {
    alert("Please enter a condition name");
    return;
  }
  
  const conditionId = Date.now();
  const conditionHTML = `
    <div class="condition ${color}" id="condition_${conditionId}">
      <div class="condition-header">
        <span>${name}</span>
        <span class="condition-turns">${turns ? turns + ' turns' : 'Indefinite'}</span>
      </div>
      <div>${effect}</div>
      <button onclick="removeCondition('${conditionId}')" style="float:right; padding:2px 5px; margin-top:5px;">Remove</button>
    </div>
  `;
  
  document.getElementById('conditions_container').insertAdjacentHTML('beforeend', conditionHTML);
  closePopup('conditionPopup');
  autosave();
}

function removeCondition(id) {
  document.getElementById(`condition_${id}`).remove();
  autosave();
}

// ========== ITEM DETAILS ==========
function showItemDetails(item, type) {
  document.getElementById('itemDetailsTitle').textContent = item.name || 'Unnamed Item';
  
  let content = '';
  if (type === 'weapon') {
    content = `
      <p><strong>To Hit:</strong> ${item.toHit || '-'}</p>
      <p><strong>Damage:</strong> ${item.damage || '-'}</p>
      <p><strong>Bonus Damage:</strong> ${item.bonusDamage || '-'}</p>
      <p><strong>Notes:</strong> ${item.notes || '-'}</p>
    `;
  } else if (type === 'equipment') {
    content = `
      <p><strong>Type:</strong> ${item.type || '-'}</p>
      <p><strong>Bonus:</strong> ${item.bonus || '-'}</p>
      <p><strong>Weight:</strong> ${item.weight || 0} lbs (${(item.weight * 0.453592).toFixed(2)} kg)</p>
      <p><strong>Notes:</strong> ${item.notes || '-'}</p>
    `;
  } else if (type === 'inventory') {
    content = `
      <p><strong>Description:</strong> ${item.description || '-'}</p>
      <p><strong>Weight:</strong> ${item.weight || 0} lbs (${(item.weight * 0.453592).toFixed(2)} kg)</p>
      <p><strong>Notes:</strong> ${item.notes || '-'}</p>
    `;
  }
  
  document.getElementById('itemDetailsContent').innerHTML = content;
  showPopup('itemDetailsPopup');
}

// ========== ROUND RESET BUTTON ==========
function resetRoundActions() {
  document.getElementById('action_tick').checked = false;
  document.getElementById('bonus_action_tick').checked = false;
  autosave();
  alert("Action counters reset for new round!");
}

function debugLocalStorage() {
  console.log("Checking localStorage...");
  for (let i = 0; i < localStorage.length; i++) {
    const key = localStorage.key(i);
    console.log(`${key}:`, localStorage.getItem(key));
  }
}

// ========== LAYOUT SYSTEM ==========
const LayoutManager = {
  STORAGE_KEY: 'dndSheetLayout_final',
  initialized: false,
  
  init() {
    if (this.initialized) return;
    this.initialized = true;
    
    window.addEventListener('load', () => {
      console.log('LayoutManager ready');
      this.ensureElementIds();
      
      // Set up save button
      const saveBtn = document.getElementById('saveLayoutBtn');
      if (saveBtn) {
        saveBtn.addEventListener('click', (e) => {
          e.preventDefault();
          this.save();
        });
      }
      
      // Set up reset button
      const resetBtn = document.getElementById('resetLayoutBtn');
      if (resetBtn) {
        resetBtn.addEventListener('click', (e) => {
          e.preventDefault();
          this.reset();
        });
      }
      
      this.load();
    });
  },
  
  ensureElementIds() {
    document.querySelectorAll('.section:not([id])').forEach((el, i) => {
      el.id = `section-${i+1}`;
    });
    
    document.querySelectorAll('textarea:not([id])').forEach((el, i) => {
      el.id = `textarea-${i+1}`;
    });
  },
  
  save() {
    try {
      const layout = {
        version: 'final',
        timestamp: new Date().toISOString(),
        sections: {},
        textareas: {}
      };

      document.querySelectorAll('.section').forEach(section => {
        if (section.offsetParent) {
          layout.sections[section.id] = {
            width: section.style.width || `${section.offsetWidth}px`,
            height: section.style.height || `${section.offsetHeight}px`,
            position: window.getComputedStyle(section).position
          };
        }
      });

      document.querySelectorAll('textarea').forEach(textarea => {
        if (textarea.offsetParent) {
          layout.textareas[textarea.id] = {
            width: textarea.style.width || `${textarea.offsetWidth}px`,
            height: textarea.style.height || `${textarea.offsetHeight}px`
          };
        }
      });

      localStorage.setItem(this.STORAGE_KEY, JSON.stringify(layout));
      alert('Layout saved successfully!');
      return true;
    } catch (e) {
      console.error('Save failed:', e);
      alert('Save error: ' + e.message);
      return false;
    }
  },
  
  load() {
    try {
      const data = localStorage.getItem(this.STORAGE_KEY);
      if (!data) return false;

      const layout = JSON.parse(data);
      console.log('Loading layout:', layout);

      Object.entries(layout.sections || {}).forEach(([id, style]) => {
        const el = document.getElementById(id);
        if (el) {
          el.style.width = style.width;
          el.style.height = style.height;
          if (style.position) el.style.position = style.position;
        }
      });

      Object.entries(layout.textareas || {}).forEach(([id, style]) => {
        const el = document.getElementById(id);
        if (el) {
          el.style.width = style.width;
          el.style.height = style.height;
        }
      });

      return true;
    } catch (e) {
      console.error('Load failed:', e);
      return false;
    }
  },
  
  reset() {
    if (confirm('Are you sure you want to reset ALL layout settings to default?')) {
      // Reset sections
      document.querySelectorAll('.section').forEach(section => {
        section.style.width = '';
        section.style.height = '';
        section.style.position = '';
        section.style.left = '';
        section.style.top = '';
      });
      
      // Reset textareas
      document.querySelectorAll('textarea').forEach(textarea => {
        textarea.style.width = '';
        textarea.style.height = '';
      });
      
      // Clear storage
      localStorage.removeItem(this.STORAGE_KEY);
      alert('Layout has been reset to default settings');
    }
  }
};

// Initialize
document.addEventListener('DOMContentLoaded', () => {
  LayoutManager.init();
});

// Settings dropdown functionality
document.getElementById('settingsBtn').addEventListener('click', function(e) {
  e.stopPropagation();
  const dropdown = document.getElementById('settingsDropdown');
  dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
});

// Close dropdown when clicking elsewhere
document.addEventListener('click', function(e) {
  if (!e.target.closest('#settingsDropdown') && !e.target.closest('#settingsBtn')) {
    document.getElementById('settingsDropdown').style.display = 'none';
  }
});

// ========== SPELL SYSTEM ==========

// Spell data storage
let spellsData = {
  cantrips: [],
  spells: []
};

// Favorites storage
let favoritesData = {
  cantrips: [],
  spells: []
};

// Class/level selections for import
let classLevelSelections = [];
let importMode = 'both'; // 'cantrip' | 'spell' | 'both'

// Clear all confirmation tracking
let clearAllConfirmations = {
  cantrip: 0,
  spell: 0
};

// Spell slots tracking
let spellSlotsUsed = {
  cantrip: 0,
  1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0
};

// D&D Spell Database (sample spells)
const dndSpellsDatabase = {
  cantrips: [
    {
      name: "Fire Bolt",
      level: 0,
      school: "Evocation",
      castingTime: "1 action",
      range: "120 feet",
      components: "V, S",
      duration: "Instantaneous",
      damage: "1d10 fire damage",
      save: "",
      attack: "Ranged spell attack",
      ritual: false,
      concentration: false,
      description: "You hurl a mote of fire at a creature or object within range. Make a ranged spell attack against the target. On a hit, the target takes 1d10 fire damage. A flammable object hit by this spell ignites if it isn't being worn or carried."
    },
    {
      name: "Mage Hand",
      level: 0,
      school: "Conjuration",
      castingTime: "1 action",
      range: "30 feet",
      components: "V, S",
      duration: "1 minute",
      damage: "",
      save: "",
      attack: "",
      ritual: false,
      concentration: false,
      description: "A spectral, floating hand appears at a point you choose within range. The hand lasts for the duration or until you dismiss it as an action. The hand vanishes if it is ever more than 30 feet away from you or if you cast this spell again."
    },
    {
      name: "Prestidigitation",
      level: 0,
      school: "Transmutation",
      castingTime: "1 action",
      range: "10 feet",
      components: "V, S",
      duration: "Up to 1 hour",
      damage: "",
      save: "",
      attack: "",
      ritual: false,
      concentration: false,
      description: "This spell is a minor magical trick that novice spellcasters use for practice. You create one of the following magical effects within range."
    }
  ],
  spells: [
    {
      name: "Magic Missile",
      level: 1,
      school: "Evocation",
      castingTime: "1 action",
      range: "120 feet",
      components: "V, S",
      duration: "Instantaneous",
      damage: "1d4+1 force damage per missile",
      save: "",
      attack: "",
      ritual: false,
      concentration: false,
      description: "You create three glowing darts of magical force. Each dart hits a creature of your choice that you can see within range. A dart deals 1d4+1 force damage to its target. The darts all strike simultaneously, and you can direct them to hit one creature or several."
    },
    {
      name: "Fireball",
      level: 3,
      school: "Evocation",
      castingTime: "1 action",
      range: "150 feet",
      components: "V, S, M (a tiny ball of bat guano and sulfur)",
      duration: "Instantaneous",
      damage: "8d6 fire damage",
      save: "Dexterity save",
      attack: "",
      ritual: false,
      concentration: false,
      description: "A bright streak flashes from your pointing finger to a point you choose within range and then blossoms with a low roar into an explosion of flame. Each creature in a 20-foot-radius sphere centered on that point must make a Dexterity saving throw."
    },
    {
      name: "Identify",
      level: 1,
      school: "Divination",
      castingTime: "1 minute",
      range: "Touch",
      components: "V, S, M (a pearl worth at least 100 gp and an owl feather)",
      duration: "Instantaneous",
      damage: "",
      save: "",
      attack: "",
      ritual: true,
      concentration: false,
      description: "You choose one object that you must touch throughout the casting of the spell. If it is a magic item or some other magic-imbued object, you learn its properties and how to use them, whether it requires attunement to use, and how many charges it has, if any."
    }
  ]
};

// Initialize spell system
function initializeSpellSystem() {
  // Data will be populated by loadData() from the main character store
  updateSpellSlots();
  renderSpells();
}

// Update spell slots display
function updateSpellSlots() {
  for (let level = 0; level <= 9; level++) {
    const levelKey = level === 0 ? 'cantrip' : level.toString();
    const slotsInput = document.getElementById(level === 0 ? 'cantrip_slots' : `spell_slots_${level}`);
    const usedContainer = document.getElementById(level === 0 ? 'cantrip_used' : `spell_used_${level}`);
    
    if (slotsInput && usedContainer) {
      const totalSlots = parseInt(slotsInput.value) || 0;
      const usedSlots = spellSlotsUsed[levelKey] || 0;
      
      usedContainer.innerHTML = '';
      for (let i = 0; i < totalSlots; i++) {
        const dot = document.createElement('div');
        dot.className = `spell-slot-dot ${i < usedSlots ? 'used' : ''}`;
        dot.onclick = () => toggleSpellSlot(levelKey, i);
        usedContainer.appendChild(dot);
      }
    }
  }
}

// Toggle spell slot usage
function toggleSpellSlot(level, index) {
  const usedSlots = spellSlotsUsed[level] || 0;
  if (index < usedSlots) {
    spellSlotsUsed[level] = index;
  } else {
    spellSlotsUsed[level] = index + 1;
  }
  updateSpellSlots();
  autosave();
}

// Reset all spell slots
function resetSpellSlots() {
  spellSlotsUsed = {
    cantrip: 0,
    1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0
  };
  updateSpellSlots();
  autosave();
}

// Show spell form
function showSpellForm(type, spellIndex = null) {
  const popup = document.getElementById('spellFormPopup');
  const title = document.getElementById('spellFormTitle');
  const form = document.getElementById('spellForm');
  
  if (spellIndex !== null) {
    // Edit existing spell
    const spell = type === 'cantrip' ? spellsData.cantrips[spellIndex] : spellsData.spells[spellIndex];
    title.textContent = 'Edit Spell';
    populateSpellForm(spell);
  } else {
    // Add new spell
    title.textContent = type === 'cantrip' ? 'Add Cantrip' : 'Add Spell';
    form.reset();
    document.getElementById('spellLevel').value = type === 'cantrip' ? '0' : '1';
  }
  
  showPopup('spellFormPopup');
}

// Populate spell form for editing
function populateSpellForm(spell) {
  document.getElementById('spellName').value = spell.name || '';
  document.getElementById('spellLevel').value = spell.level || '0';
  document.getElementById('spellSchool').value = spell.school || '';
  document.getElementById('spellCastingTime').value = spell.castingTime || '';
  document.getElementById('spellRange').value = spell.range || '';
  document.getElementById('spellComponents').value = spell.components || '';
  document.getElementById('spellDuration').value = spell.duration || '';
  document.getElementById('spellDamage').value = spell.damage || '';
  document.getElementById('spellSave').value = spell.save || '';
  document.getElementById('spellAttack').value = spell.attack || '';
  document.getElementById('spellRitual').checked = spell.ritual || false;
  document.getElementById('spellConcentration').checked = spell.concentration || false;
  document.getElementById('spellPrepared').checked = spell.prepared || false;
  document.getElementById('spellDescription').value = spell.description || '';
  document.getElementById('spellWikiLink').value = spell.wikiLink || '';
}

// Save spell
function saveSpell(event) {
  event.preventDefault();
  
  const spell = {
    name: document.getElementById('spellName').value,
    level: parseInt(document.getElementById('spellLevel').value),
    school: document.getElementById('spellSchool').value,
    castingTime: document.getElementById('spellCastingTime').value,
    range: document.getElementById('spellRange').value,
    components: document.getElementById('spellComponents').value,
    duration: document.getElementById('spellDuration').value,
    damage: document.getElementById('spellDamage').value,
    save: document.getElementById('spellSave').value,
    attack: document.getElementById('spellAttack').value,
    ritual: document.getElementById('spellRitual').checked,
    concentration: document.getElementById('spellConcentration').checked,
    prepared: document.getElementById('spellPrepared').checked,
    description: document.getElementById('spellDescription').value,
    wikiLink: document.getElementById('spellWikiLink').value
  };
  
  const isCantrip = spell.level === 0;
  const spellArray = isCantrip ? spellsData.cantrips : spellsData.spells;
  
  // Check if editing existing spell
  const formTitle = document.getElementById('spellFormTitle').textContent;
  if (formTitle.includes('Edit')) {
    // Find and update existing spell
    const spellName = document.getElementById('spellName').value;
    const index = spellArray.findIndex(s => s.name === spellName);
    if (index !== -1) {
      spellArray[index] = spell;
    }
  } else {
    // Add new spell
    spellArray.push(spell);
  }
  
  renderSpells();
  closePopup('spellFormPopup');
  autosave();
}

// Render spells
function renderSpells() {
  // Render using current filter selections so the dropdowns act as live filters
  filterSpells('cantrip');
  filterSpells('spell');
  renderFavorites();
}

// Render individual spell list
function renderSpellList(type, spells) {
  const container = document.getElementById(`${type}_list`);
  if (!container) return;
  
  container.innerHTML = '';
  
  if (spells.length === 0) {
    container.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No spells added yet. Click the + button to add your first spell!</p>';
    return;
  }
  
  // Group spells by level
  const groupedSpells = {};
  spells.forEach(spell => {
    const level = spell.level;
    if (!groupedSpells[level]) {
      groupedSpells[level] = [];
    }
    groupedSpells[level].push(spell);
  });
  
  // Render each level group
  Object.keys(groupedSpells).sort((a, b) => parseInt(a) - parseInt(b)).forEach(level => {
    const levelSpells = groupedSpells[level];
    const levelSection = document.createElement('div');
    levelSection.className = 'spell-level-section';
    
    const levelHeader = document.createElement('div');
    levelHeader.className = 'spell-level-header';
    levelHeader.innerHTML = `
      <span>${level === '0' ? 'Cantrips' : `${level}${getOrdinalSuffix(parseInt(level))} Level`}</span>
      <span>(${levelSpells.length} spell${levelSpells.length !== 1 ? 's' : ''})</span>
    `;
    levelSection.appendChild(levelHeader);
    
    levelSpells.forEach((spell, index) => {
      const spellItem = createSpellItem(spell, type, index);
      levelSection.appendChild(spellItem);
    });
    
    container.appendChild(levelSection);
  });
}

// Create spell item element
function createSpellItem(spell, type, index) {
  const item = document.createElement('div');
  item.className = 'spell-item';
  
  // Add special classes for spell properties
  if (spell.ritual) item.classList.add('spell-ritual');
  if (spell.concentration) item.classList.add('spell-concentration');
  if (spell.prepared) item.classList.add('spell-prepared');
  
  // Normalize type used by action handlers
  const actionType = (type === 'spells') ? 'spell' : (type === 'cantrips' ? 'cantrip' : type);
  
  // Ensure we act on the correct spell in the master list, not the filtered/group index
  const masterArray = actionType === 'cantrip' ? spellsData.cantrips : spellsData.spells;
  let indexToUse = masterArray.findIndex(s => s.name === spell.name);
  if (indexToUse === -1) {
    // Fallback to provided index if not found; guards against temporary mismatch during import
    indexToUse = index;
  }
  const isFav = isFavorited(actionType, spell.name);
  
  const spellInfo = document.createElement('div');
  spellInfo.innerHTML = `
    <strong>${spell.name}</strong>
    <span style="color: #888; font-size: 0.9em;">
      ${spell.school} • ${spell.castingTime} • ${spell.range}
      ${spell.damage ? ` • ${spell.damage}` : ''}
    </span>
  `;
  // Build favorite star with a safe event handler
  const star = document.createElement('span');
  star.className = `favorite-star ${isFav ? 'favorited' : 'not-favorited'}`;
  star.textContent = '★';
  star.title = isFav ? 'Remove from favorites' : 'Add to favorites';
  star.style.marginRight = '6px';
  star.addEventListener('click', function(e) {
    e.stopPropagation();
    toggleFavoriteByName(actionType, spell.name);
  });
  // Prepend star to info
  spellInfo.prepend(star);
  
  const actions = document.createElement('div');
  actions.className = 'spell-item-actions';
  actions.innerHTML = `
    <button class="spell-item-btn" onclick="showSpellDetails('${actionType}', ${indexToUse})">View</button>
    <button class="spell-item-btn" onclick="showSpellForm('${actionType}', ${indexToUse})">Edit</button>
    <button class="spell-item-btn" onclick="toggleSpellPrepared('${actionType}', ${indexToUse})">
      ${spell.prepared ? 'Unprepare' : 'Prepare'}
    </button>
    <button class="spell-item-btn" onclick="removeSpell('${actionType}', ${indexToUse})">Remove</button>
  `;
  
  item.appendChild(spellInfo);
  item.appendChild(actions);
  
  return item;
}

// Show spell details
function showSpellDetails(type, index) {
  const spell = type === 'cantrip' ? spellsData.cantrips[index] : spellsData.spells[index];
  if (!spell) return;
  
  document.getElementById('spellDetailName').textContent = spell.name;
  document.getElementById('spellDetailLevel').textContent = spell.level === 0 ? 'Cantrip' : `${spell.level}${getOrdinalSuffix(spell.level)} Level`;
  document.getElementById('spellDetailSchool').textContent = spell.school;
  document.getElementById('spellDetailCastingTime').textContent = spell.castingTime;
  document.getElementById('spellDetailRange').textContent = spell.range;
  document.getElementById('spellDetailComponents').textContent = spell.components;
  document.getElementById('spellDetailDuration').textContent = spell.duration;
  document.getElementById('spellDetailDamage').textContent = spell.damage || 'None';
  document.getElementById('spellDetailSave').textContent = spell.save || 'None';
  document.getElementById('spellDetailAttack').textContent = spell.attack || 'None';
  document.getElementById('spellDetailRitual').textContent = spell.ritual ? 'Yes' : 'No';
  document.getElementById('spellDetailConcentration').textContent = spell.concentration ? 'Yes' : 'No';
  document.getElementById('spellDetailDescription').textContent = spell.description;
  
  // Show/hide wiki link
  const wikiLinkRow = document.getElementById('spellDetailWikiLink');
  const wikiLink = document.getElementById('spellWikiLink');
  
  if (spell.wikiLink) {
    wikiLink.href = spell.wikiLink;
    wikiLinkRow.style.display = 'block';
  } else {
    wikiLinkRow.style.display = 'none';
  }
  
  showPopup('spellDetailsPopup');
}

// Toggle spell prepared status
function toggleSpellPrepared(type, index) {
  const spell = type === 'cantrip' ? spellsData.cantrips[index] : spellsData.spells[index];
  if (spell) {
    spell.prepared = !spell.prepared;
    renderSpells(); // live update
    autosave();
  }
}

// Remove spell
function removeSpell(type, index) {
  if (confirm('Are you sure you want to remove this spell?')) {
    if (type === 'cantrip') {
      const removed = spellsData.cantrips.splice(index, 1)[0];
      if (removed) {
        // Also remove from favorites by name
        favoritesData.cantrips = favoritesData.cantrips.filter(f => f.name !== removed.name);
      }
    } else {
      const removed = spellsData.spells.splice(index, 1)[0];
      if (removed) {
        favoritesData.spells = favoritesData.spells.filter(f => f.name !== removed.name);
      }
    }
    renderSpells();
    autosave();
  }
}

// Render favorites
function renderFavorites() {
  // Use actual container IDs in the DOM
  renderFavoritesList('favorites_cantrips_list', favoritesData.cantrips);
  renderFavoritesList('favorites_spells_list', favoritesData.spells);
}

// Render favorites list
function renderFavoritesList(containerId, favorites) {
  const container = document.getElementById(containerId);
  if (!container) return;
  
  container.innerHTML = '';
  
  if (favorites.length === 0) {
    container.innerHTML = '<p style="text-align: center; color: #666; padding: 20px; font-style: italic;">No favorites yet. Click the star (★) next to any spell to add it to favorites!</p>';
    return;
  }
  
  // Group favorites by level
  const groupedFavorites = {};
  favorites.forEach(spell => {
    const level = spell.level;
    if (!groupedFavorites[level]) {
      groupedFavorites[level] = [];
    }
    groupedFavorites[level].push(spell);
  });
  
  // Render each level group
  Object.keys(groupedFavorites).sort((a, b) => parseInt(a) - parseInt(b)).forEach(level => {
    const levelSpells = groupedFavorites[level];
    const levelSection = document.createElement('div');
    levelSection.className = 'spell-level-section';
    
    const levelHeader = document.createElement('div');
    levelHeader.className = 'spell-level-header';
    levelHeader.innerHTML = `
      <span>${level === '0' ? 'Cantrips' : `${level}${getOrdinalSuffix(parseInt(level))} Level`}</span>
      <span>(${levelSpells.length} spell${levelSpells.length !== 1 ? 's' : ''})</span>
    `;
    levelSection.appendChild(levelHeader);
    
    levelSpells.forEach((spell, index) => {
      // Find the original index in the main spell list
      const originalIndex = containerId.includes('cantrips') ? 
        spellsData.cantrips.findIndex(s => s.name === spell.name) :
        spellsData.spells.findIndex(s => s.name === spell.name);
      
      const spellItem = createSpellItem(spell, containerId.includes('cantrips') ? 'cantrip' : 'spell', originalIndex);
      levelSection.appendChild(spellItem);
    });
    
    container.appendChild(levelSection);
  });
}

// Filter spells
function filterSpells(type) {
  // Map type to list container keys used in DOM ids
  const listKey = type === 'cantrip' ? 'cantrips' : 'spells';
  const spells = type === 'cantrip' ? spellsData.cantrips : spellsData.spells;
  const container = document.getElementById(`${listKey}_list`);
  if (!container) return;
  
  // Get filter values
  let levelFilter = 'all';
  let schoolFilter = 'all';
  let statusFilter = 'all';
  
  if (type === 'cantrip') {
    statusFilter = document.getElementById('cantrip_filter').value;
  } else {
    levelFilter = document.getElementById('spell_level_filter').value;
    schoolFilter = document.getElementById('spell_school_filter').value;
    statusFilter = document.getElementById('spell_status_filter').value;
  }
  
  // Filter spells
  let filteredSpells = spells.filter(spell => {
    // Level filter
    if (levelFilter !== 'all' && spell.level.toString() !== levelFilter) {
      return false;
    }
    
    // School filter
    if (schoolFilter !== 'all' && spell.school !== schoolFilter) {
      return false;
    }
    
    // Status filter
    if (statusFilter !== 'all') {
      if (statusFilter === 'prepared' && !spell.prepared) return false;
      if (statusFilter === 'known' && spell.prepared) return false;
      if (statusFilter === 'ritual' && !spell.ritual) return false;
      if (statusFilter === 'favorites' && !isFavorited(type, spell.name)) return false;
    }
    
    return true;
  });
  
  // Render filtered spells
  renderSpellList(listKey, filteredSpells);
}

// Utility function for ordinal suffixes
function getOrdinalSuffix(num) {
  const j = num % 10;
  const k = num % 100;
  if (j === 1 && k !== 11) return 'st';
  if (j === 2 && k !== 12) return 'nd';
  if (j === 3 && k !== 13) return 'rd';
  return 'th';
}

// Removed legacy standalone localStorage for spells.

// Import common cantrips
function importCommonCantrips() {
  const commonCantrips = [
    {
      name: "Eldritch Blast",
      level: 0,
      school: "Evocation",
      castingTime: "1 action",
      range: "120 feet",
      components: "V, S",
      duration: "Instantaneous",
      damage: "1d10 force damage",
      save: "",
      attack: "Ranged spell attack",
      ritual: false,
      concentration: false,
      description: "A beam of crackling energy streaks toward a creature within range. Make a ranged spell attack against the target. On a hit, the target takes 1d10 force damage."
    },
    {
      name: "Guidance",
      level: 0,
      school: "Divination",
      castingTime: "1 action",
      range: "Touch",
      components: "V, S",
      duration: "Concentration, up to 1 minute",
      damage: "",
      save: "",
      attack: "",
      ritual: false,
      concentration: true,
      description: "You touch one willing creature. Once before the spell ends, the target can roll a d4 and add the number rolled to one ability check of its choice."
    },
    {
      name: "Light",
      level: 0,
      school: "Evocation",
      castingTime: "1 action",
      range: "Touch",
      components: "V, M (a firefly or phosphorescent moss)",
      duration: "1 hour",
      damage: "",
      save: "",
      attack: "",
      ritual: false,
      concentration: false,
      description: "You touch one object that is no larger than 10 feet in any dimension. Until the spell ends, the object sheds bright light in a 20-foot radius and dim light for an additional 20 feet."
    },
    {
      name: "Minor Illusion",
      level: 0,
      school: "Illusion",
      castingTime: "1 action",
      range: "30 feet",
      components: "S, M (a bit of fleece)",
      duration: "1 minute",
      damage: "",
      save: "Intelligence save",
      attack: "",
      ritual: false,
      concentration: false,
      description: "You create a sound or an image of an object within range that lasts for the duration. The illusion also ends if you dismiss it as an action or cast this spell again."
    },
    {
      name: "Sacred Flame",
      level: 0,
      school: "Evocation",
      castingTime: "1 action",
      range: "60 feet",
      components: "V, S",
      duration: "Instantaneous",
      damage: "1d8 radiant damage",
      save: "Dexterity save",
      attack: "",
      ritual: false,
      concentration: false,
      description: "Flame-like radiance descends on a creature that you can see within range. The target must succeed on a Dexterity saving throw or take 1d8 radiant damage."
    }
  ];
  
  // Add cantrips that don't already exist
  commonCantrips.forEach(cantrip => {
    if (!spellsData.cantrips.find(spell => spell.name === cantrip.name)) {
      spellsData.cantrips.push(cantrip);
    }
  });
  
  renderSpells();
  autosave();
  alert(`Imported ${commonCantrips.length} common cantrips!`);
}

// Import common spells
function importCommonSpells() {
  const commonSpells = [
    {
      name: "Cure Wounds",
      level: 1,
      school: "Evocation",
      castingTime: "1 action",
      range: "Touch",
      components: "V, S",
      duration: "Instantaneous",
      damage: "1d8 + spellcasting ability modifier healing",
      save: "",
      attack: "",
      ritual: false,
      concentration: false,
      description: "A creature you touch regains a number of hit points equal to 1d8 + your spellcasting ability modifier. This spell has no effect on undead or constructs."
    },
    {
      name: "Detect Magic",
      level: 1,
      school: "Divination",
      castingTime: "1 action",
      range: "Self",
      components: "V, S",
      duration: "Concentration, up to 10 minutes",
      damage: "",
      save: "",
      attack: "",
      ritual: true,
      concentration: true,
      description: "For the duration, you sense the presence of magic within 30 feet of you. If you sense magic in this way, you can use your action to see a faint aura around any visible creature or object in the area that bears magic."
    },
    {
      name: "Shield",
      level: 1,
      school: "Abjuration",
      castingTime: "1 reaction, which you take when you are hit by an attack or targeted by the magic missile spell",
      range: "Self",
      components: "V, S",
      duration: "1 round",
      damage: "",
      save: "",
      attack: "",
      ritual: false,
      concentration: false,
      description: "An invisible barrier of magical force appears and protects you. Until the start of your next turn, you have a +5 bonus to AC, including against the triggering attack, and you take no damage from magic missile."
    },
    {
      name: "Sleep",
      level: 1,
      school: "Enchantment",
      castingTime: "1 action",
      range: "90 feet",
      components: "V, S, M (a pinch of fine sand, rose petals, or a cricket)",
      duration: "1 minute",
      damage: "",
      save: "",
      attack: "",
      ritual: false,
      concentration: false,
      description: "This spell sends creatures into a magical slumber. Roll 5d8; the total is how many hit points of creatures this spell can affect. Creatures within 20 feet of a point you choose within range are affected in ascending order of their current hit points."
    },
    {
      name: "Bless",
      level: 1,
      school: "Enchantment",
      castingTime: "1 action",
      range: "30 feet",
      components: "V, S, M (a sprinkling of holy water)",
      duration: "Concentration, up to 1 minute",
      damage: "",
      save: "",
      attack: "",
      ritual: false,
      concentration: true,
      description: "You bless up to three creatures of your choice within range. Whenever a target makes an attack roll or a saving throw before the spell ends, the target can roll a d4 and add the number rolled to the attack roll or saving throw."
    }
  ];
  
  // Add spells that don't already exist
  commonSpells.forEach(spell => {
    if (!spellsData.spells.find(s => s.name === spell.name)) {
      spellsData.spells.push(spell);
    }
  });
  
  renderSpells();
  autosave();
  alert(`Imported ${commonSpells.length} common spells!`);
}

// D&D 5e Classes and their spell lists (Updated 2025)
const dndClasses = {
  'Artificer': {
    cantrips: ['Acid Splash', 'Dancing Lights', 'Fire Bolt', 'Guidance', 'Light', 'Mage Hand', 'Mending', 'Message', 'Minor Illusion', 'Poison Spray', 'Prestidigitation', 'Ray of Frost', 'Resistance', 'Shocking Grasp', 'Spare the Dying', 'Thorn Whip'],
    spells: {
      1: ['Absorb Elements', 'Alarm', 'Cure Wounds', 'Detect Magic', 'Disguise Self', 'Expeditious Retreat', 'Faerie Fire', 'False Life', 'Feather Fall', 'Grease', 'Identify', 'Jump', 'Longstrider', 'Purify Food and Drink', 'Sanctuary', 'Snare', 'Tasha\'s Caustic Brew'],
      2: ['Aid', 'Alter Self', 'Arcane Lock', 'Blur', 'Continual Flame', 'Darkvision', 'Enhance Ability', 'Enlarge/Reduce', 'Heat Metal', 'Invisibility', 'Lesser Restoration', 'Levitate', 'Magic Mouth', 'Magic Weapon', 'Protection from Poison', 'Pyrotechnics', 'Rope Trick', 'See Invisibility', 'Skywrite', 'Spider Climb', 'Suggestion', 'Web'],
      3: ['Blink', 'Catnap', 'Counterspell', 'Create Food and Water', 'Dispel Magic', 'Elemental Weapon', 'Flame Arrows', 'Fly', 'Glyph of Warding', 'Haste', 'Intellect Fortress', 'Protection from Energy', 'Revivify', 'Tiny Servant', 'Water Breathing', 'Water Walk'],
      4: ['Arcane Eye', 'Elemental Bane', 'Fabricate', 'Freedom of Movement', 'Leomund\'s Secret Chest', 'Mordenkainen\'s Faithful Hound', 'Mordenkainen\'s Private Sanctum', 'Otiluke\'s Resilient Sphere', 'Stone Shape', 'Stoneskin', 'Wall of Fire'],
      5: ['Animate Objects', 'Bigby\'s Hand', 'Creation', 'Greater Restoration', 'Skill Empowerment', 'Transmute Rock', 'Wall of Stone']
    }
  },
  'Bard': {
    cantrips: ['Blade Ward', 'Dancing Lights', 'Friends', 'Light', 'Mage Hand', 'Mending', 'Message', 'Minor Illusion', 'Prestidigitation', 'True Strike', 'Vicious Mockery'],
    spells: {
      1: ['Animal Friendship', 'Bane', 'Charm Person', 'Comprehend Languages', 'Cure Wounds', 'Detect Magic', 'Disguise Self', 'Faerie Fire', 'Feather Fall', 'Healing Word', 'Heroism', 'Identify', 'Illusory Script', 'Longstrider', 'Silent Image', 'Sleep', 'Speak with Animals', 'Tasha\'s Hideous Laughter', 'Thunderwave', 'Unseen Servant'],
      2: ['Animal Messenger', 'Blindness/Deafness', 'Calm Emotions', 'Cloud of Daggers', 'Crown of Madness', 'Detect Thoughts', 'Enhance Ability', 'Enthrall', 'Heat Metal', 'Hold Person', 'Invisibility', 'Knock', 'Lesser Restoration', 'Locate Object', 'Magic Mouth', 'Phantasmal Force', 'Shatter', 'Silence', 'Suggestion', 'Zone of Truth'],
      3: ['Bestow Curse', 'Clairvoyance', 'Dispel Magic', 'Fear', 'Feign Death', 'Glyph of Warding', 'Hypnotic Pattern', 'Leomund\'s Tiny Hut', 'Major Image', 'Nondetection', 'Plant Growth', 'Sending', 'Speak with Dead', 'Speak with Plants', 'Stinking Cloud', 'Tongues'],
      4: ['Compulsion', 'Confusion', 'Dimension Door', 'Freedom of Movement', 'Greater Invisibility', 'Hallucinatory Terrain', 'Locate Creature', 'Polymorph'],
      5: ['Animate Objects', 'Awaken', 'Dominate Person', 'Dream', 'Geas', 'Greater Restoration', 'Hold Monster', 'Legend Lore', 'Mass Cure Wounds', 'Mislead', 'Modify Memory', 'Planar Binding', 'Raise Dead', 'Scrying', 'Seeming', 'Teleportation Circle']
    }
  },
  'Cleric': {
    cantrips: ['Guidance', 'Light', 'Mending', 'Resistance', 'Sacred Flame', 'Spare the Dying', 'Thaumaturgy'],
    spells: {
      1: ['Bane', 'Bless', 'Command', 'Create or Destroy Water', 'Cure Wounds', 'Detect Evil and Good', 'Detect Magic', 'Detect Poison and Disease', 'Guiding Bolt', 'Healing Word', 'Inflict Wounds', 'Protection from Evil and Good', 'Purify Food and Drink', 'Sanctuary', 'Shield of Faith'],
      2: ['Aid', 'Augury', 'Blindness/Deafness', 'Calm Emotions', 'Continual Flame', 'Enhance Ability', 'Find Traps', 'Gentle Repose', 'Hold Person', 'Lesser Restoration', 'Locate Object', 'Prayer of Healing', 'Protection from Poison', 'Silence', 'Spiritual Weapon', 'Warding Bond', 'Zone of Truth'],
      3: ['Animate Dead', 'Beacon of Hope', 'Bestow Curse', 'Clairvoyance', 'Create Food and Water', 'Daylight', 'Dispel Magic', 'Feign Death', 'Glyph of Warding', 'Locate Object', 'Magic Circle', 'Mass Healing Word', 'Meld into Stone', 'Protection from Energy', 'Remove Curse', 'Revivify', 'Sending', 'Speak with Dead', 'Spirit Guardians', 'Tongues', 'Water Walk'],
      4: ['Banishment', 'Control Water', 'Death Ward', 'Divination', 'Freedom of Movement', 'Guardian of Faith', 'Locate Creature', 'Stone Shape'],
      5: ['Commune', 'Contagion', 'Dispel Evil and Good', 'Flame Strike', 'Geas', 'Greater Restoration', 'Hallow', 'Insect Plague', 'Legend Lore', 'Mass Cure Wounds', 'Planar Binding', 'Raise Dead', 'Scrying', 'Tree Stride']
    }
  },
  'Druid': {
    cantrips: ['Druidcraft', 'Guidance', 'Mending', 'Poison Spray', 'Produce Flame', 'Resistance', 'Shillelagh', 'Thorn Whip'],
    spells: {
      1: ['Animal Friendship', 'Charm Person', 'Create or Destroy Water', 'Cure Wounds', 'Detect Magic', 'Detect Poison and Disease', 'Entangle', 'Faerie Fire', 'Fog Cloud', 'Goodberry', 'Healing Word', 'Jump', 'Longstrider', 'Purify Food and Drink', 'Speak with Animals', 'Thunderwave'],
      2: ['Animal Messenger', 'Barkskin', 'Beast Sense', 'Darkvision', 'Enhance Ability', 'Find Traps', 'Flame Blade', 'Flaming Sphere', 'Gust of Wind', 'Heat Metal', 'Hold Person', 'Lesser Restoration', 'Locate Object', 'Moonbeam', 'Pass without Trace', 'Protection from Poison', 'Spike Growth'],
      3: ['Call Lightning', 'Conjure Animals', 'Daylight', 'Dispel Magic', 'Feign Death', 'Flame Arrows', 'Giant Insect', 'Gust of Wind', 'Meld into Stone', 'Plant Growth', 'Protection from Energy', 'Sleet Storm', 'Speak with Plants', 'Water Breathing', 'Water Walk', 'Wind Wall'],
      4: ['Blight', 'Confusion', 'Conjure Minor Elementals', 'Conjure Woodland Beings', 'Control Water', 'Dominate Beast', 'Freedom of Movement', 'Giant Insect', 'Grasping Vine', 'Hallucinatory Terrain', 'Ice Storm', 'Locate Creature', 'Polymorph', 'Stone Shape', 'Stoneskin', 'Wall of Fire'],
      5: ['Antilife Shell', 'Awaken', 'Commune with Nature', 'Conjure Elemental', 'Contagion', 'Geas', 'Greater Restoration', 'Insect Plague', 'Mass Cure Wounds', 'Planar Binding', 'Reincarnate', 'Scrying', 'Tree Stride', 'Wall of Stone']
    }
  },
  'Paladin': {
    cantrips: [],
    spells: {
      1: ['Bless', 'Command', 'Compelled Duel', 'Cure Wounds', 'Detect Evil and Good', 'Detect Magic', 'Detect Poison and Disease', 'Divine Favor', 'Heroism', 'Protection from Evil and Good', 'Purify Food and Drink', 'Searing Smite', 'Shield of Faith', 'Thunderous Smite', 'Wrathful Smite'],
      2: ['Aid', 'Branding Smite', 'Find Steed', 'Lesser Restoration', 'Locate Object', 'Magic Weapon', 'Protection from Poison', 'Zone of Truth'],
      3: ['Aura of Vitality', 'Blinding Smite', 'Create Food and Water', 'Crusader\'s Mantle', 'Daylight', 'Dispel Magic', 'Elemental Weapon', 'Magic Circle', 'Remove Curse', 'Revivify'],
      4: ['Aura of Life', 'Aura of Purity', 'Banishment', 'Death Ward', 'Locate Creature', 'Staggering Smite'],
      5: ['Banishing Smite', 'Circle of Power', 'Destructive Wave', 'Dispel Evil and Good', 'Geas', 'Raise Dead']
    }
  },
  'Ranger': {
    cantrips: [],
    spells: {
      1: ['Alarm', 'Animal Friendship', 'Cure Wounds', 'Detect Magic', 'Detect Poison and Disease', 'Ensnaring Strike', 'Fog Cloud', 'Goodberry', 'Hail of Thorns', 'Hunter\'s Mark', 'Jump', 'Longstrider', 'Speak with Animals'],
      2: ['Animal Messenger', 'Barkskin', 'Beast Sense', 'Cordon of Arrows', 'Darkvision', 'Find Traps', 'Lesser Restoration', 'Locate Object', 'Pass without Trace', 'Protection from Poison', 'Silence', 'Spike Growth'],
      3: ['Conjure Animals', 'Conjure Barrage', 'Daylight', 'Lightning Arrow', 'Locate Creature', 'Nondetection', 'Plant Growth', 'Protection from Energy', 'Speak with Plants', 'Water Breathing', 'Water Walk', 'Wind Wall'],
      4: ['Conjure Woodland Beings', 'Freedom of Movement', 'Grasping Vine', 'Locate Creature', 'Stoneskin'],
      5: ['Commune with Nature', 'Conjure Volley', 'Greater Restoration', 'Swift Quiver', 'Tree Stride']
    }
  },
  'Sorcerer': {
    cantrips: ['Acid Splash', 'Blade Ward', 'Chill Touch', 'Dancing Lights', 'Fire Bolt', 'Friends', 'Light', 'Mage Hand', 'Mending', 'Message', 'Minor Illusion', 'Poison Spray', 'Prestidigitation', 'Ray of Frost', 'Shocking Grasp', 'True Strike'],
    spells: {
      1: ['Burning Hands', 'Charm Person', 'Chromatic Orb', 'Color Spray', 'Comprehend Languages', 'Detect Magic', 'Disguise Self', 'Expeditious Retreat', 'False Life', 'Feather Fall', 'Fog Cloud', 'Jump', 'Mage Armor', 'Magic Missile', 'Ray of Sickness', 'Shield', 'Silent Image', 'Sleep', 'Thunderwave', 'Witch Bolt'],
      2: ['Alter Self', 'Blindness/Deafness', 'Blur', 'Cloud of Daggers', 'Crown of Madness', 'Darkness', 'Darkvision', 'Detect Thoughts', 'Enhance Ability', 'Enlarge/Reduce', 'Gust of Wind', 'Hold Person', 'Invisibility', 'Knock', 'Levitate', 'Mirror Image', 'Misty Step', 'Phantasmal Force', 'Scorching Ray', 'See Invisibility', 'Shatter', 'Spider Climb', 'Suggestion', 'Web'],
      3: ['Blink', 'Counterspell', 'Daylight', 'Fear', 'Fireball', 'Fly', 'Gaseous Form', 'Haste', 'Hypnotic Pattern', 'Lightning Bolt', 'Major Image', 'Protection from Energy', 'Sleet Storm', 'Slow', 'Stinking Cloud', 'Tongues', 'Water Breathing', 'Water Walk'],
      4: ['Banishment', 'Blight', 'Confusion', 'Dimension Door', 'Dominate Beast', 'Greater Invisibility', 'Ice Storm', 'Polymorph', 'Stoneskin', 'Wall of Fire'],
      5: ['Animate Objects', 'Cloudkill', 'Cone of Cold', 'Creation', 'Dominate Person', 'Hold Monster', 'Insect Plague', 'Seeming', 'Telekinesis', 'Teleportation Circle', 'Wall of Stone']
    }
  },
  'Warlock': {
    cantrips: ['Blade Ward', 'Chill Touch', 'Eldritch Blast', 'Friends', 'Mage Hand', 'Minor Illusion', 'Poison Spray', 'Prestidigitation', 'True Strike'],
    spells: {
      1: ['Armor of Agathys', 'Arms of Hadar', 'Charm Person', 'Comprehend Languages', 'Expeditious Retreat', 'Hellish Rebuke', 'Hex', 'Illusory Script', 'Protection from Evil and Good', 'Unseen Servant', 'Witch Bolt'],
      2: ['Cloud of Daggers', 'Crown of Madness', 'Darkness', 'Enthrall', 'Hold Person', 'Invisibility', 'Misty Step', 'Ray of Enfeeblement', 'Shatter', 'Spider Climb', 'Suggestion'],
      3: ['Counterspell', 'Dispel Magic', 'Fear', 'Fly', 'Gaseous Form', 'Hunger of Hadar', 'Hypnotic Pattern', 'Magic Circle', 'Major Image', 'Remove Curse', 'Tongues', 'Vampiric Touch'],
      4: ['Banishment', 'Blight', 'Dimension Door', 'Hallucinatory Terrain', 'Locate Creature'],
      5: ['Contact Other Plane', 'Dream', 'Hold Monster', 'Scrying']
    }
  },
  'Wizard': {
    cantrips: ['Acid Splash', 'Blade Ward', 'Chill Touch', 'Dancing Lights', 'Fire Bolt', 'Friends', 'Light', 'Mage Hand', 'Mending', 'Message', 'Minor Illusion', 'Poison Spray', 'Prestidigitation', 'Ray of Frost', 'Shocking Grasp', 'True Strike'],
    spells: {
      1: ['Alarm', 'Burning Hands', 'Charm Person', 'Chromatic Orb', 'Color Spray', 'Comprehend Languages', 'Detect Magic', 'Disguise Self', 'Expeditious Retreat', 'False Life', 'Feather Fall', 'Find Familiar', 'Fog Cloud', 'Grease', 'Identify', 'Illusory Script', 'Jump', 'Longstrider', 'Mage Armor', 'Magic Missile', 'Protection from Evil and Good', 'Ray of Sickness', 'Shield', 'Silent Image', 'Sleep', 'Tasha\'s Hideous Laughter', 'Tenser\'s Floating Disk', 'Thunderwave', 'Unseen Servant', 'Witch Bolt'],
      2: ['Alter Self', 'Arcane Lock', 'Blindness/Deafness', 'Blur', 'Cloud of Daggers', 'Continual Flame', 'Crown of Madness', 'Darkness', 'Darkvision', 'Detect Thoughts', 'Enhance Ability', 'Enlarge/Reduce', 'Flaming Sphere', 'Gentle Repose', 'Gust of Wind', 'Hold Person', 'Invisibility', 'Knock', 'Levitate', 'Locate Object', 'Magic Mouth', 'Magic Weapon', 'Melf\'s Acid Arrow', 'Mirror Image', 'Misty Step', 'Nystul\'s Magic Aura', 'Phantasmal Force', 'Pyrotechnics', 'Ray of Enfeeblement', 'Rope Trick', 'Scorching Ray', 'See Invisibility', 'Shatter', 'Spider Climb', 'Suggestion', 'Web'],
      3: ['Animate Dead', 'Bestow Curse', 'Blink', 'Clairvoyance', 'Counterspell', 'Daylight', 'Dispel Magic', 'Fear', 'Feign Death', 'Fireball', 'Fly', 'Gaseous Form', 'Glyph of Warding', 'Haste', 'Hypnotic Pattern', 'Leomund\'s Tiny Hut', 'Lightning Bolt', 'Magic Circle', 'Major Image', 'Nondetection', 'Phantom Steed', 'Protection from Energy', 'Remove Curse', 'Sending', 'Sleet Storm', 'Slow', 'Speak with Dead', 'Stinking Cloud', 'Tongues', 'Vampiric Touch', 'Water Breathing'],
      4: ['Arcane Eye', 'Banishment', 'Blight', 'Confusion', 'Conjure Minor Elementals', 'Control Water', 'Dimension Door', 'Evard\'s Black Tentacles', 'Fabricate', 'Fire Shield', 'Greater Invisibility', 'Hallucinatory Terrain', 'Ice Storm', 'Leomund\'s Secret Chest', 'Locate Creature', 'Mordenkainen\'s Faithful Hound', 'Mordenkainen\'s Private Sanctum', 'Otiluke\'s Resilient Sphere', 'Phantasmal Killer', 'Polymorph', 'Stone Shape', 'Stoneskin', 'Wall of Fire'],
      5: ['Animate Objects', 'Bigby\'s Hand', 'Cloudkill', 'Cone of Cold', 'Conjure Elemental', 'Contact Other Plane', 'Creation', 'Dominate Person', 'Dream', 'Geas', 'Hold Monster', 'Legend Lore', 'Mislead', 'Modify Memory', 'Passwall', 'Planar Binding', 'Rary\'s Telepathic Bond', 'Scrying', 'Seeming', 'Telekinesis', 'Teleportation Circle', 'Wall of Force', 'Wall of Stone']
    }
  }
};

// Comprehensive D&D 5e Spell Database (Updated 2025)
const spellDatabase = {
  // Cantrips (Level 0)
  'Acid Splash': {
    level: 0,
    school: 'Conjuration',
    castingTime: '1 action',
    range: '60 feet',
    components: 'V, S',
    duration: 'Instantaneous',
    damage: '1d6 acid damage',
    save: 'Dexterity save',
    attack: '',
    ritual: false,
    concentration: false,
    description: 'You hurl a bubble of acid. Choose one creature within range, or choose two creatures within range that are within 5 feet of each other.',
    wikiLink: 'https://www.dndbeyond.com/spells/acid-splash'
  },
  'Blade Ward': {
    level: 0,
    school: 'Abjuration',
    castingTime: '1 action',
    range: 'Self',
    components: 'V, S',
    duration: '1 round',
    damage: '',
    save: '',
    attack: '',
    ritual: false,
    concentration: false,
    description: 'You extend your hand and trace a sigil of warding in the air. Until the end of your next turn, you have resistance against bludgeoning, piercing, and slashing damage dealt by weapon attacks.',
    wikiLink: 'https://www.dndbeyond.com/spells/blade-ward'
  },
  'Chill Touch': {
    level: 0,
    school: 'Necromancy',
    castingTime: '1 action',
    range: '120 feet',
    components: 'V, S',
    duration: '1 round',
    damage: '1d8 necrotic damage',
    save: '',
    attack: 'Ranged spell attack',
    ritual: false,
    concentration: false,
    description: 'You create a ghostly, skeletal hand in the space of a creature within range. Make a ranged spell attack against the creature to assail it with the chill of the grave.',
    wikiLink: 'https://www.dndbeyond.com/spells/chill-touch'
  },
  'Dancing Lights': {
    level: 0,
    school: 'Evocation',
    castingTime: '1 action',
    range: '120 feet',
    components: 'V, S, M (a bit of phosphorus or wychwood, or a glowworm)',
    duration: 'Concentration, up to 1 minute',
    damage: '',
    save: '',
    attack: '',
    ritual: false,
    concentration: true,
    description: 'You create up to four torch-sized lights within range, making them appear as torches, lanterns, or glowing orbs that hover in the air for the duration.',
    wikiLink: 'https://www.dndbeyond.com/spells/dancing-lights'
  },
  'Druidcraft': {
    level: 0,
    school: 'Transmutation',
    castingTime: '1 action',
    range: '30 feet',
    components: 'V, S',
    duration: 'Instantaneous',
    damage: '',
    save: '',
    attack: '',
    ritual: false,
    concentration: false,
    description: 'Whispering to the spirits of nature, you create one of the following effects within range: predict weather, make a flower bloom, create a harmless sensory effect, or light/snuff a small flame.',
    wikiLink: 'https://www.dndbeyond.com/spells/druidcraft'
  },
  'Eldritch Blast': {
    level: 0,
    school: 'Evocation',
    castingTime: '1 action',
    range: '120 feet',
    components: 'V, S',
    duration: 'Instantaneous',
    damage: '1d10 force damage',
    save: '',
    attack: 'Ranged spell attack',
    ritual: false,
    concentration: false,
    description: 'A beam of crackling energy streaks toward a creature within range. Make a ranged spell attack against the target.',
    wikiLink: 'https://www.dndbeyond.com/spells/eldritch-blast'
  },
  'Fire Bolt': {
    level: 0,
    school: 'Evocation',
    castingTime: '1 action',
    range: '120 feet',
    components: 'V, S',
    duration: 'Instantaneous',
    damage: '1d10 fire damage',
    save: '',
    attack: 'Ranged spell attack',
    ritual: false,
    concentration: false,
    description: 'You hurl a mote of fire at a creature or object within range. Make a ranged spell attack against the target.',
    wikiLink: 'https://www.dndbeyond.com/spells/fire-bolt'
  },
  'Friends': {
    level: 0,
    school: 'Enchantment',
    castingTime: '1 action',
    range: 'Self',
    components: 'S, M (a small amount of makeup applied to the face as this spell is cast)',
    duration: 'Concentration, up to 1 minute',
    damage: '',
    save: '',
    attack: '',
    ritual: false,
    concentration: true,
    description: 'For the duration, you have advantage on all Charisma checks directed at one creature of your choice that isn\'t hostile toward you.',
    wikiLink: 'https://www.dndbeyond.com/spells/friends'
  },
  'Guidance': {
    level: 0,
    school: 'Divination',
    castingTime: '1 action',
    range: 'Touch',
    components: 'V, S',
    duration: 'Concentration, up to 1 minute',
    damage: '',
    save: '',
    attack: '',
    ritual: false,
    concentration: true,
    description: 'You touch one willing creature. Once before the spell ends, the target can roll a d4 and add the number rolled to one ability check of its choice.',
    wikiLink: 'https://www.dndbeyond.com/spells/guidance'
  },
  'Light': {
    level: 0,
    school: 'Evocation',
    castingTime: '1 action',
    range: 'Touch',
    components: 'V, M (a firefly or phosphorescent moss)',
    duration: '1 hour',
    damage: '',
    save: '',
    attack: '',
    ritual: false,
    concentration: false,
    description: 'You touch one object that is no larger than 10 feet in any dimension. Until the spell ends, the object sheds bright light in a 20-foot radius and dim light for an additional 20 feet.',
    wikiLink: 'https://www.dndbeyond.com/spells/light'
  },
  'Mage Hand': {
    level: 0,
    school: 'Conjuration',
    castingTime: '1 action',
    range: '30 feet',
    components: 'V, S',
    duration: '1 minute',
    damage: '',
    save: '',
    attack: '',
    ritual: false,
    concentration: false,
    description: 'A spectral, floating hand appears at a point you choose within range. The hand lasts for the duration or until you dismiss it as an action.',
    wikiLink: 'https://www.dndbeyond.com/spells/mage-hand'
  },
  'Mending': {
    level: 0,
    school: 'Transmutation',
    castingTime: '1 minute',
    range: 'Touch',
    components: 'V, S, M (two lodestones)',
    duration: 'Instantaneous',
    damage: '',
    save: '',
    attack: '',
    ritual: false,
    concentration: false,
    description: 'This spell repairs a single break or tear in an object you touch, such as a broken chain link, two halves of a broken key, a torn cloak, or a leaking wineskin.',
    wikiLink: 'https://www.dndbeyond.com/spells/mending'
  },
  'Message': {
    level: 0,
    school: 'Transmutation',
    castingTime: '1 action',
    range: '120 feet',
    components: 'V, S, M (a short piece of copper wire)',
    duration: '1 round',
    damage: '',
    save: '',
    attack: '',
    ritual: false,
    concentration: false,
    description: 'You point your finger toward a creature within range and whisper a message. The target (and only the target) hears the message and can reply in a whisper that only you can hear.',
    wikiLink: 'https://www.dndbeyond.com/spells/message'
  },
  'Minor Illusion': {
    level: 0,
    school: 'Illusion',
    castingTime: '1 action',
    range: '30 feet',
    components: 'S, M (a bit of fleece)',
    duration: '1 minute',
    damage: '',
    save: 'Intelligence save',
    attack: '',
    ritual: false,
    concentration: false,
    description: 'You create a sound or an image of an object within range that lasts for the duration. The illusion also ends if you dismiss it as an action or cast this spell again.',
    wikiLink: 'https://www.dndbeyond.com/spells/minor-illusion'
  },
  'Poison Spray': {
    level: 0,
    school: 'Conjuration',
    castingTime: '1 action',
    range: '10 feet',
    components: 'V, S',
    duration: 'Instantaneous',
    damage: '1d12 poison damage',
    save: 'Constitution save',
    attack: '',
    ritual: false,
    concentration: false,
    description: 'You extend your hand toward a creature you can see within range and project a puff of noxious gas from your palm.',
    wikiLink: 'https://www.dndbeyond.com/spells/poison-spray'
  },
  'Prestidigitation': {
    level: 0,
    school: 'Transmutation',
    castingTime: '1 action',
    range: '10 feet',
    components: 'V, S',
    duration: 'Up to 1 hour',
    damage: '',
    save: '',
    attack: '',
    ritual: false,
    concentration: false,
    description: 'This spell is a minor magical trick that novice spellcasters use for practice. You create one of several magical effects within range.',
    wikiLink: 'https://www.dndbeyond.com/spells/prestidigitation'
  },
  'Produce Flame': {
    level: 0,
    school: 'Conjuration',
    castingTime: '1 action',
    range: 'Self',
    components: 'V, S',
    duration: '10 minutes',
    damage: '1d8 fire damage',
    save: '',
    attack: 'Ranged spell attack',
    ritual: false,
    concentration: false,
    description: 'A flickering flame appears in your hand. The flame remains there for the duration and harms neither you nor your equipment.',
    wikiLink: 'https://www.dndbeyond.com/spells/produce-flame'
  },
  'Ray of Frost': {
    level: 0,
    school: 'Evocation',
    castingTime: '1 action',
    range: '60 feet',
    components: 'V, S',
    duration: 'Instantaneous',
    damage: '1d8 cold damage',
    save: '',
    attack: 'Ranged spell attack',
    ritual: false,
    concentration: false,
    description: 'A frigid beam of blue-white light streaks toward a creature within range. Make a ranged spell attack against the target.',
    wikiLink: 'https://www.dndbeyond.com/spells/ray-of-frost'
  },
  'Resistance': {
    level: 0,
    school: 'Abjuration',
    castingTime: '1 action',
    range: 'Touch',
    components: 'V, S, M (a miniature cloak)',
    duration: 'Concentration, up to 1 minute',
    damage: '',
    save: '',
    attack: '',
    ritual: false,
    concentration: true,
    description: 'You touch one willing creature. Once before the spell ends, the target can roll a d4 and add the number rolled to one saving throw of its choice.',
    wikiLink: 'https://www.dndbeyond.com/spells/resistance'
  },
  'Sacred Flame': {
    level: 0,
    school: 'Evocation',
    castingTime: '1 action',
    range: '60 feet',
    components: 'V, S',
    duration: 'Instantaneous',
    damage: '1d8 radiant damage',
    save: 'Dexterity save',
    attack: '',
    ritual: false,
    concentration: false,
    description: 'Flame-like radiance descends on a creature that you can see within range. The target must succeed on a Dexterity saving throw or take 1d8 radiant damage.',
    wikiLink: 'https://www.dndbeyond.com/spells/sacred-flame'
  },
  'Shillelagh': {
    level: 0,
    school: 'Transmutation',
    castingTime: '1 bonus action',
    range: 'Touch',
    components: 'V, S, M (mistletoe, a shamrock leaf, and a club or quarterstaff)',
    duration: '1 minute',
    damage: '',
    save: '',
    attack: '',
    ritual: false,
    concentration: false,
    description: 'The wood of a club or quarterstaff you are holding is imbued with nature\'s power. For the duration, you can use your spellcasting ability instead of Strength for the attack and damage rolls of melee attacks using that weapon.',
    wikiLink: 'https://www.dndbeyond.com/spells/shillelagh'
  },
  'Shocking Grasp': {
    level: 0,
    school: 'Evocation',
    castingTime: '1 action',
    range: 'Touch',
    components: 'V, S',
    duration: 'Instantaneous',
    damage: '1d8 lightning damage',
    save: '',
    attack: 'Melee spell attack',
    ritual: false,
    concentration: false,
    description: 'Lightning springs from your hand to deliver a shock to a creature you try to touch. Make a melee spell attack against the target.',
    wikiLink: 'https://www.dndbeyond.com/spells/shocking-grasp'
  },
  'Spare the Dying': {
    level: 0,
    school: 'Necromancy',
    castingTime: '1 action',
    range: 'Touch',
    components: 'V, S',
    duration: 'Instantaneous',
    damage: '',
    save: '',
    attack: '',
    ritual: false,
    concentration: false,
    description: 'You touch a living creature that has 0 hit points. The creature becomes stable. This spell has no effect on undead or constructs.',
    wikiLink: 'https://www.dndbeyond.com/spells/spare-the-dying'
  },
  'Thaumaturgy': {
    level: 0,
    school: 'Transmutation',
    castingTime: '1 action',
    range: '30 feet',
    components: 'V',
    duration: 'Up to 1 minute',
    damage: '',
    save: '',
    attack: '',
    ritual: false,
    concentration: false,
    description: 'You manifest a minor wonder, a sign of supernatural power, within range. You create one of several magical effects within range.',
    wikiLink: 'https://www.dndbeyond.com/spells/thaumaturgy'
  },
  'Thorn Whip': {
    level: 0,
    school: 'Transmutation',
    castingTime: '1 action',
    range: '30 feet',
    components: 'V, S, M (the stem of a plant with thorns)',
    duration: 'Instantaneous',
    damage: '1d6 piercing damage',
    save: '',
    attack: 'Melee spell attack',
    ritual: false,
    concentration: false,
    description: 'You create a long, vine-like whip covered in thorns that lashes out at your command toward a creature in range.',
    wikiLink: 'https://www.dndbeyond.com/spells/thorn-whip'
  },
  'True Strike': {
    level: 0,
    school: 'Divination',
    castingTime: '1 action',
    range: '30 feet',
    components: 'S',
    duration: 'Concentration, up to 1 round',
    damage: '',
    save: '',
    attack: '',
    ritual: false,
    concentration: true,
    description: 'You extend your hand and point a finger at a target in range. Your magic grants you a brief insight into the target\'s defenses.',
    wikiLink: 'https://www.dndbeyond.com/spells/true-strike'
  },
  'Vicious Mockery': {
    level: 0,
    school: 'Enchantment',
    castingTime: '1 action',
    range: '60 feet',
    components: 'V',
    duration: 'Instantaneous',
    damage: '1d4 psychic damage',
    save: 'Wisdom save',
    attack: '',
    ritual: false,
    concentration: false,
    description: 'You unleash a string of insults laced with subtle enchantments at a creature you can see within range.',
    wikiLink: 'https://www.dndbeyond.com/spells/vicious-mockery'
  },
  'Booming Blade': {
    level: 0,
    school: 'Evocation',
    castingTime: '1 action',
    range: 'Self (5-foot radius)',
    components: 'S, M (a melee weapon worth at least 1 sp)',
    duration: '1 round',
    damage: '1d8 thunder damage',
    save: '',
    attack: 'Melee weapon attack',
    ritual: false,
    concentration: false,
    description: 'You brandish the weapon used in the spell\'s casting and make a melee attack with it against one creature within 5 feet of you.',
    wikiLink: 'https://www.dndbeyond.com/spells/booming-blade'
  },
  'Green-Flame Blade': {
    level: 0,
    school: 'Evocation',
    castingTime: '1 action',
    range: 'Self (5-foot radius)',
    components: 'S, M (a melee weapon worth at least 1 sp)',
    duration: 'Instantaneous',
    damage: '1d8 fire damage',
    save: '',
    attack: 'Melee weapon attack',
    ritual: false,
    concentration: false,
    description: 'You brandish the weapon used in the spell\'s casting and make a melee attack with it against one creature within 5 feet of you.',
    wikiLink: 'https://www.dndbeyond.com/spells/green-flame-blade'
  },
  'Sword Burst': {
    level: 0,
    school: 'Conjuration',
    castingTime: '1 action',
    range: 'Self (5-foot radius)',
    components: 'V',
    duration: 'Instantaneous',
    damage: '1d6 force damage',
    save: 'Dexterity save',
    attack: '',
    ritual: false,
    concentration: false,
    description: 'You create a momentary circle of spectral blades that sweep around you.',
    wikiLink: 'https://www.dndbeyond.com/spells/sword-burst'
  },
  'Toll the Dead': {
    level: 0,
    school: 'Necromancy',
    castingTime: '1 action',
    range: '60 feet',
    components: 'V, S',
    duration: 'Instantaneous',
    damage: '1d8 necrotic damage',
    save: 'Wisdom save',
    attack: '',
    ritual: false,
    concentration: false,
    description: 'You point at one creature you can see within range, and the sound of a dolorous bell fills the air around it for a moment.',
    wikiLink: 'https://www.dndbeyond.com/spells/toll-the-dead'
  },
  
  // 1st Level Spells
  'Absorb Elements': {
    level: 1,
    school: 'Abjuration',
    castingTime: '1 reaction, which you take when you take acid, cold, fire, lightning, or thunder damage',
    range: 'Self',
    components: 'S',
    duration: '1 round',
    damage: '',
    save: '',
    attack: '',
    ritual: false,
    concentration: false,
    description: 'The spell captures some of the incoming energy, lessening its effect on you and storing it for your next melee attack.',
    wikiLink: 'https://www.dndbeyond.com/spells/absorb-elements'
  },
  'Alarm': {
    level: 1,
    school: 'Abjuration',
    castingTime: '1 minute',
    range: '30 feet',
    components: 'V, S, M (a tiny bell and a piece of fine silver wire)',
    duration: '8 hours',
    damage: '',
    save: '',
    attack: '',
    ritual: true,
    concentration: false,
    description: 'You set an alarm against unwanted intrusion. Choose a door, a window, or an area within range that is no larger than a 20-foot cube.',
    wikiLink: 'https://www.dndbeyond.com/spells/alarm'
  },
  'Burning Hands': {
    level: 1,
    school: 'Evocation',
    castingTime: '1 action',
    range: 'Self (15-foot cone)',
    components: 'V, S',
    duration: 'Instantaneous',
    damage: '3d6 fire damage',
    save: 'Dexterity save',
    attack: '',
    ritual: false,
    concentration: false,
    description: 'As you hold your hands with thumbs touching and fingers spread, a thin sheet of flames shoots forth from your outstretched fingertips.',
    wikiLink: 'https://www.dndbeyond.com/spells/burning-hands'
  },
  'Charm Person': {
    level: 1,
    school: 'Enchantment',
    castingTime: '1 action',
    range: '30 feet',
    components: 'V, S',
    duration: '1 hour',
    damage: '',
    save: 'Wisdom save',
    attack: '',
    ritual: false,
    concentration: false,
    description: 'You attempt to charm a humanoid you can see within range. It must make a Wisdom saving throw, and does so with advantage if you or your companions are fighting it.',
    wikiLink: 'https://www.dndbeyond.com/spells/charm-person'
  },
  'Cure Wounds': {
    level: 1,
    school: 'Evocation',
    castingTime: '1 action',
    range: 'Touch',
    components: 'V, S',
    duration: 'Instantaneous',
    damage: '1d8 + spellcasting ability modifier healing',
    save: '',
    attack: '',
    ritual: false,
    concentration: false,
    description: 'A creature you touch regains a number of hit points equal to 1d8 + your spellcasting ability modifier. This spell has no effect on undead or constructs.',
    wikiLink: 'https://www.dndbeyond.com/spells/cure-wounds'
  },
  'Detect Magic': {
    level: 1,
    school: 'Divination',
    castingTime: '1 action',
    range: 'Self',
    components: 'V, S',
    duration: 'Concentration, up to 10 minutes',
    damage: '',
    save: '',
    attack: '',
    ritual: true,
    concentration: true,
    description: 'For the duration, you sense the presence of magic within 30 feet of you. If you sense magic in this way, you can use your action to see a faint aura around any visible creature or object in the area that bears magic.',
    wikiLink: 'https://www.dndbeyond.com/spells/detect-magic'
  },
  'Disguise Self': {
    level: 1,
    school: 'Illusion',
    castingTime: '1 action',
    range: 'Self',
    components: 'V, S',
    duration: '1 hour',
    damage: '',
    save: '',
    attack: '',
    ritual: false,
    concentration: false,
    description: 'You make yourself—including your clothing, armor, weapons, and other belongings on your person—look different until the spell ends or until you use your action to dismiss it.',
    wikiLink: 'https://www.dndbeyond.com/spells/disguise-self'
  },
  'Faerie Fire': {
    level: 1,
    school: 'Evocation',
    castingTime: '1 action',
    range: '60 feet',
    components: 'V',
    duration: 'Concentration, up to 1 minute',
    damage: '',
    save: 'Dexterity save',
    attack: '',
    ritual: false,
    concentration: true,
    description: 'Each object in a 20-foot cube within range is outlined in blue, green, or violet light (your choice). Any creature in the area when the spell is cast is also outlined in light if it fails a Dexterity saving throw.',
    wikiLink: 'https://www.dndbeyond.com/spells/faerie-fire'
  },
  'Feather Fall': {
    level: 1,
    school: 'Transmutation',
    castingTime: '1 reaction, which you take when you or a creature within 60 feet of you falls',
    range: '60 feet',
    components: 'V, M (a small feather or piece of down)',
    duration: '1 minute',
    damage: '',
    save: '',
    attack: '',
    ritual: false,
    concentration: false,
    description: 'Choose up to five falling creatures within range. A falling creature\'s rate of descent slows to 60 feet per round until the spell ends.',
    wikiLink: 'https://www.dndbeyond.com/spells/feather-fall'
  },
  'Find Familiar': {
    level: 1,
    school: 'Conjuration',
    castingTime: '1 hour',
    range: '10 feet',
    components: 'V, S, M (10 gp worth of charcoal, incense, and herbs that must be consumed by fire in a brass brazier)',
    duration: 'Instantaneous',
    damage: '',
    save: '',
    attack: '',
    ritual: true,
    concentration: false,
    description: 'You gain the service of a familiar, a spirit that takes an animal form you choose: bat, cat, crab, frog (toad), hawk, lizard, octopus, owl, poisonous snake, fish (quipper), rat, raven, sea horse, spider, or weasel.',
    wikiLink: 'https://www.dndbeyond.com/spells/find-familiar'
  },
  'Healing Word': {
    level: 1,
    school: 'Evocation',
    castingTime: '1 bonus action',
    range: '60 feet',
    components: 'V',
    duration: 'Instantaneous',
    damage: '1d4 + spellcasting ability modifier healing',
    save: '',
    attack: '',
    ritual: false,
    concentration: false,
    description: 'A creature of your choice that you can see within range regains hit points equal to 1d4 + your spellcasting ability modifier. This spell has no effect on undead or constructs.',
    wikiLink: 'https://www.dndbeyond.com/spells/healing-word'
  },
  'Magic Missile': {
    level: 1,
    school: 'Evocation',
    castingTime: '1 action',
    range: '120 feet',
    components: 'V, S',
    duration: 'Instantaneous',
    damage: '1d4 + 1 force damage per missile',
    save: '',
    attack: '',
    ritual: false,
    concentration: false,
    description: 'You create three glowing darts of magical force. Each dart hits a creature of your choice that you can see within range. A dart deals 1d4 + 1 force damage to its target.',
    wikiLink: 'https://www.dndbeyond.com/spells/magic-missile'
  },
  'Shield': {
    level: 1,
    school: 'Abjuration',
    castingTime: '1 reaction, which you take when you are hit by an attack or targeted by the magic missile spell',
    range: 'Self',
    components: 'V, S',
    duration: '1 round',
    damage: '',
    save: '',
    attack: '',
    ritual: false,
    concentration: false,
    description: 'An invisible barrier of magical force appears and protects you. Until the start of your next turn, you have a +5 bonus to AC, including against the triggering attack, and you take no damage from magic missile.',
    wikiLink: 'https://www.dndbeyond.com/spells/shield'
  },
  'Sleep': {
    level: 1,
    school: 'Enchantment',
    castingTime: '1 action',
    range: '90 feet',
    components: 'V, S, M (a pinch of fine sand, rose petals, or a cricket)',
    duration: '1 minute',
    damage: '',
    save: '',
    attack: '',
    ritual: false,
    concentration: false,
    description: 'This spell sends creatures into a magical slumber. Roll 5d8; the total is how many hit points of creatures this spell can affect. Creatures within 20 feet of a point you choose within range are affected in ascending order of their current hit points.',
    wikiLink: 'https://www.dndbeyond.com/spells/sleep'
  },
  'Thunderwave': {
    level: 1,
    school: 'Evocation',
    castingTime: '1 action',
    range: 'Self (15-foot cube)',
    components: 'V, S',
    duration: 'Instantaneous',
    damage: '2d8 thunder damage',
    save: 'Constitution save',
    attack: '',
    ritual: false,
    concentration: false,
    description: 'A wave of thunderous force sweeps out from you. Each creature in a 15-foot cube originating from you must make a Constitution saving throw.',
    wikiLink: 'https://www.dndbeyond.com/spells/thunderwave'
  },
  
  // 2nd Level Spells
  'Aid': {
    level: 2,
    school: 'Enchantment',
    castingTime: '1 action',
    range: '30 feet',
    components: 'V, S, M (a tiny strip of white cloth)',
    duration: '8 hours',
    damage: '',
    save: '',
    attack: '',
    ritual: false,
    concentration: false,
    description: 'Your spell bolsters your allies with toughness and resolve. Choose up to three creatures within range. Each target\'s hit point maximum and current hit points increase by 5 for the duration.',
    wikiLink: 'https://www.dndbeyond.com/spells/aid'
  },
  'Blur': {
    level: 2,
    school: 'Illusion',
    castingTime: '1 action',
    range: 'Self',
    components: 'V',
    duration: 'Concentration, up to 1 minute',
    damage: '',
    save: '',
    attack: '',
    ritual: false,
    concentration: true,
    description: 'Your body becomes blurred, shifting and wavering to all who can see you. For the duration, any creature has disadvantage on attack rolls against you.',
    wikiLink: 'https://www.dndbeyond.com/spells/blur'
  },
  'Darkvision': {
    level: 2,
    school: 'Transmutation',
    castingTime: '1 action',
    range: 'Touch',
    components: 'V, S, M (either a pinch of dried carrot or an agate)',
    duration: '8 hours',
    damage: '',
    save: '',
    attack: '',
    ritual: false,
    concentration: false,
    description: 'You touch a willing creature to grant it the ability to see in the dark. For the duration, that creature has darkvision out to a range of 60 feet.',
    wikiLink: 'https://www.dndbeyond.com/spells/darkvision'
  },
  'Enhance Ability': {
    level: 2,
    school: 'Transmutation',
    castingTime: '1 action',
    range: 'Touch',
    components: 'V, S, M (fur or a feather from a beast)',
    duration: 'Concentration, up to 1 hour',
    damage: '',
    save: '',
    attack: '',
    ritual: false,
    concentration: true,
    description: 'You touch a creature and bestow upon it a magical enhancement. Choose one of the following effects; the target gains that effect until the spell ends.',
    wikiLink: 'https://www.dndbeyond.com/spells/enhance-ability'
  },
  'Heat Metal': {
    level: 2,
    school: 'Transmutation',
    castingTime: '1 action',
    range: '60 feet',
    components: 'V, S, M (a piece of iron and a flame)',
    duration: 'Concentration, up to 1 minute',
    damage: '2d8 fire damage',
    save: '',
    attack: '',
    ritual: false,
    concentration: true,
    description: 'Choose a manufactured metal object, such as a metal weapon or a suit of heavy or medium metal armor, that you can see within range.',
    wikiLink: 'https://www.dndbeyond.com/spells/heat-metal'
  },
  'Hold Person': {
    level: 2,
    school: 'Enchantment',
    castingTime: '1 action',
    range: '60 feet',
    components: 'V, S, M (a small, straight piece of iron)',
    duration: 'Concentration, up to 1 minute',
    damage: '',
    save: 'Wisdom save',
    attack: '',
    ritual: false,
    concentration: true,
    description: 'Choose a humanoid that you can see within range. The target must succeed on a Wisdom saving throw or be paralyzed for the duration.',
    wikiLink: 'https://www.dndbeyond.com/spells/hold-person'
  },
  'Invisibility': {
    level: 2,
    school: 'Illusion',
    castingTime: '1 action',
    range: 'Touch',
    components: 'V, S, M (an eyelash encased in gum arabic)',
    duration: 'Concentration, up to 1 hour',
    damage: '',
    save: '',
    attack: '',
    ritual: false,
    concentration: true,
    description: 'A creature you touch becomes invisible until the spell ends. Anything the target is wearing or carrying is invisible as long as it is on the target\'s person.',
    wikiLink: 'https://www.dndbeyond.com/spells/invisibility'
  },
  'Lesser Restoration': {
    level: 2,
    school: 'Abjuration',
    castingTime: '1 action',
    range: 'Touch',
    components: 'V, S',
    duration: 'Instantaneous',
    damage: '',
    save: '',
    attack: '',
    ritual: false,
    concentration: false,
    description: 'You touch a creature and can end either one disease or one condition afflicting it. The condition can be blinded, deafened, paralyzed, or poisoned.',
    wikiLink: 'https://www.dndbeyond.com/spells/lesser-restoration'
  },
  'Misty Step': {
    level: 2,
    school: 'Conjuration',
    castingTime: '1 bonus action',
    range: 'Self',
    components: 'V',
    duration: 'Instantaneous',
    damage: '',
    save: '',
    attack: '',
    ritual: false,
    concentration: false,
    description: 'Briefly surrounded by silvery mist, you teleport up to 30 feet to an unoccupied space that you can see.',
    wikiLink: 'https://www.dndbeyond.com/spells/misty-step'
  },
  'Scorching Ray': {
    level: 2,
    school: 'Evocation',
    castingTime: '1 action',
    range: '120 feet',
    components: 'V, S',
    duration: 'Instantaneous',
    damage: '2d6 fire damage per ray',
    save: '',
    attack: 'Ranged spell attack',
    ritual: false,
    concentration: false,
    description: 'You create three rays of fire and hurl them at targets within range. You can hurl them at one target or several. Make a ranged spell attack for each ray.',
    wikiLink: 'https://www.dndbeyond.com/spells/scorching-ray'
  },
  'Suggestion': {
    level: 2,
    school: 'Enchantment',
    castingTime: '1 action',
    range: '30 feet',
    components: 'V, M (a snake\'s tongue and either a bit of honeycomb or a drop of sweet oil)',
    duration: 'Concentration, up to 8 hours',
    damage: '',
    save: 'Wisdom save',
    attack: '',
    ritual: false,
    concentration: true,
    description: 'You suggest a course of activity (limited to a sentence or two) and magically influence a creature you can see within range that can hear and understand you.',
    wikiLink: 'https://www.dndbeyond.com/spells/suggestion'
  },
  'Web': {
    level: 2,
    school: 'Conjuration',
    castingTime: '1 action',
    range: '60 feet',
    components: 'V, S, M (a bit of spiderweb)',
    duration: 'Concentration, up to 1 hour',
    damage: '',
    save: 'Dexterity save',
    attack: '',
    ritual: false,
    concentration: true,
    description: 'You conjure a mass of thick, sticky webbing at a point of your choice within range. The webs fill a 20-foot cube from that point for the duration.',
    wikiLink: 'https://www.dndbeyond.com/spells/web'
  },
  
  // 3rd Level Spells
  'Counterspell': {
    level: 3,
    school: 'Abjuration',
    castingTime: '1 reaction, which you take when you see a creature within 60 feet of you casting a spell',
    range: '60 feet',
    components: 'S',
    duration: 'Instantaneous',
    damage: '',
    save: '',
    attack: '',
    ritual: false,
    concentration: false,
    description: 'You attempt to interrupt a creature in the process of casting a spell. If the creature is casting a spell of 3rd level or lower, its spell fails and has no effect.',
    wikiLink: 'https://www.dndbeyond.com/spells/counterspell'
  },
  'Dispel Magic': {
    level: 3,
    school: 'Abjuration',
    castingTime: '1 action',
    range: '120 feet',
    components: 'V, S',
    duration: 'Instantaneous',
    damage: '',
    save: '',
    attack: '',
    ritual: false,
    concentration: false,
    description: 'Choose any creature, object, or magical effect within range. Any spell of 3rd level or lower on the target ends. For each spell of 4th level or higher on the target, make an ability check using your spellcasting ability.',
    wikiLink: 'https://www.dndbeyond.com/spells/dispel-magic'
  },
  'Fireball': {
    level: 3,
    school: 'Evocation',
    castingTime: '1 action',
    range: '150 feet',
    components: 'V, S, M (a tiny ball of bat guano and sulfur)',
    duration: 'Instantaneous',
    damage: '8d6 fire damage',
    save: 'Dexterity save',
    attack: '',
    ritual: false,
    concentration: false,
    description: 'A bright streak flashes from your pointing finger to a point you choose within range and then blossoms with a low roar into an explosion of flame.',
    wikiLink: 'https://www.dndbeyond.com/spells/fireball'
  },
  'Fly': {
    level: 3,
    school: 'Transmutation',
    castingTime: '1 action',
    range: 'Touch',
    components: 'V, S, M (a wing feather from any bird)',
    duration: 'Concentration, up to 10 minutes',
    damage: '',
    save: '',
    attack: '',
    ritual: false,
    concentration: true,
    description: 'You touch a willing creature. The target gains a flying speed of 60 feet for the duration. When the spell ends, the target falls if it is still aloft, unless it can stop the fall.',
    wikiLink: 'https://www.dndbeyond.com/spells/fly'
  },
  'Haste': {
    level: 3,
    school: 'Transmutation',
    castingTime: '1 action',
    range: '30 feet',
    components: 'V, S, M (a shaving of licorice root)',
    duration: 'Concentration, up to 1 minute',
    damage: '',
    save: '',
    attack: '',
    ritual: false,
    concentration: true,
    description: 'Choose a willing creature that you can see within range. Until the spell ends, the target\'s speed is doubled, it gains a +2 bonus to AC, it has advantage on Dexterity saving throws, and it gains an additional action on each of its turns.',
    wikiLink: 'https://www.dndbeyond.com/spells/haste'
  },
  'Lightning Bolt': {
    level: 3,
    school: 'Evocation',
    castingTime: '1 action',
    range: 'Self (100-foot line)',
    components: 'V, S, M (a bit of fur and a rod of amber, crystal, or glass)',
    duration: 'Instantaneous',
    damage: '8d6 lightning damage',
    save: 'Dexterity save',
    attack: '',
    ritual: false,
    concentration: false,
    description: 'A stroke of lightning forming a line 100 feet long and 5 feet wide blasts out from you in a direction you choose.',
    wikiLink: 'https://www.dndbeyond.com/spells/lightning-bolt'
  },
  'Revivify': {
    level: 3,
    school: 'Necromancy',
    castingTime: '1 action',
    range: 'Touch',
    components: 'V, S, M (diamonds worth 300 gp, which the spell consumes)',
    duration: 'Instantaneous',
    damage: '',
    save: '',
    attack: '',
    ritual: false,
    concentration: false,
    description: 'You touch a creature that has died within the last minute. That creature returns to life with 1 hit point. This spell can\'t return to life a creature that has died of old age, nor can it restore any missing body parts.',
    wikiLink: 'https://www.dndbeyond.com/spells/revivify'
  },
  'Spirit Guardians': {
    level: 3,
    school: 'Conjuration',
    castingTime: '1 action',
    range: 'Self (15-foot radius)',
    components: 'V, S, M (a holy symbol)',
    duration: 'Concentration, up to 10 minutes',
    damage: '3d8 radiant or necrotic damage',
    save: 'Wisdom save',
    attack: '',
    ritual: false,
    concentration: true,
    description: 'You call forth spirits to protect you. They flit around you to a distance of 15 feet for the duration. If you are good or neutral, their spectral form appears angelic or fey (your choice).',
    wikiLink: 'https://www.dndbeyond.com/spells/spirit-guardians'
  },
  
  // 4th Level Spells
  'Banishment': {
    level: 4,
    school: 'Abjuration',
    castingTime: '1 action',
    range: '60 feet',
    components: 'V, S, M (an item distasteful to the target)',
    duration: 'Concentration, up to 1 minute',
    damage: '',
    save: 'Charisma save',
    attack: '',
    ritual: false,
    concentration: true,
    description: 'You attempt to send one creature that you can see within range to another plane of existence. The target must succeed on a Charisma saving throw or be banished.',
    wikiLink: 'https://www.dndbeyond.com/spells/banishment'
  },
  'Greater Invisibility': {
    level: 4,
    school: 'Illusion',
    castingTime: '1 action',
    range: 'Touch',
    components: 'V, S',
    duration: 'Concentration, up to 1 minute',
    damage: '',
    save: '',
    attack: '',
    ritual: false,
    concentration: true,
    description: 'You or a creature you touch becomes invisible until the spell ends. Anything the target is wearing or carrying is invisible as long as it is on the target\'s person.',
    wikiLink: 'https://www.dndbeyond.com/spells/greater-invisibility'
  },
  'Polymorph': {
    level: 4,
    school: 'Transmutation',
    castingTime: '1 action',
    range: '60 feet',
    components: 'V, S, M (a caterpillar cocoon)',
    duration: 'Concentration, up to 1 hour',
    damage: '',
    save: 'Wisdom save',
    attack: '',
    ritual: false,
    concentration: true,
    description: 'This spell transforms a creature that you can see within range into a new form. An unwilling creature must make a Wisdom saving throw to avoid the effect.',
    wikiLink: 'https://www.dndbeyond.com/spells/polymorph'
  },
  'Wall of Fire': {
    level: 4,
    school: 'Evocation',
    castingTime: '1 action',
    range: '120 feet',
    components: 'V, S, M (a small piece of phosphorus)',
    duration: 'Concentration, up to 1 minute',
    damage: '5d8 fire damage',
    save: 'Dexterity save',
    attack: '',
    ritual: false,
    concentration: true,
    description: 'You create a wall of fire on a solid surface within range. You can make the wall up to 60 feet long, 20 feet high, and 1 foot thick, or a ringed wall up to 20 feet in diameter, 20 feet high, and 1 foot thick.',
    wikiLink: 'https://www.dndbeyond.com/spells/wall-of-fire'
  },
  
  // 5th Level Spells
  'Cone of Cold': {
    level: 5,
    school: 'Evocation',
    castingTime: '1 action',
    range: 'Self (60-foot cone)',
    components: 'V, S, M (a small crystal or glass cone)',
    duration: 'Instantaneous',
    damage: '8d8 cold damage',
    save: 'Constitution save',
    attack: '',
    ritual: false,
    concentration: false,
    description: 'A blast of cold air erupts from your hands. Each creature in a 60-foot cone must make a Constitution saving throw.',
    wikiLink: 'https://www.dndbeyond.com/spells/cone-of-cold'
  },
  'Greater Restoration': {
    level: 5,
    school: 'Abjuration',
    castingTime: '1 action',
    range: 'Touch',
    components: 'V, S, M (diamond dust worth at least 100 gp, which the spell consumes)',
    duration: 'Instantaneous',
    damage: '',
    save: '',
    attack: '',
    ritual: false,
    concentration: false,
    description: 'You imbue a creature you touch with positive energy to undo a debilitating effect. You can reduce the target\'s exhaustion level by one, or end one of the following effects on the target.',
    wikiLink: 'https://www.dndbeyond.com/spells/greater-restoration'
  },
  'Mass Cure Wounds': {
    level: 5,
    school: 'Evocation',
    castingTime: '1 action',
    range: '60 feet',
    components: 'V, S',
    duration: 'Instantaneous',
    damage: '3d8 + spellcasting ability modifier healing',
    save: '',
    attack: '',
    ritual: false,
    concentration: false,
    description: 'A wave of healing energy washes out from a point of your choice within range. Choose up to six creatures in a 30-foot-radius sphere centered on that point.',
    wikiLink: 'https://www.dndbeyond.com/spells/mass-cure-wounds'
  },
  'Raise Dead': {
    level: 5,
    school: 'Necromancy',
    castingTime: '1 hour',
    range: 'Touch',
    components: 'V, S, M (a diamond worth at least 500 gp, which the spell consumes)',
    duration: 'Instantaneous',
    damage: '',
    save: '',
    attack: '',
    ritual: false,
    concentration: false,
    description: 'You return a dead creature you touch to life, provided that it has been dead no longer than 10 days. If the creature\'s soul is both willing and at liberty to rejoin the body, the creature returns to life with 1 hit point.',
    wikiLink: 'https://www.dndbeyond.com/spells/raise-dead'
  },
  'Scrying': {
    level: 5,
    school: 'Divination',
    castingTime: '10 minutes',
    range: 'Self',
    components: 'V, S, M (a focus worth at least 1,000 gp, such as a crystal ball, a silver mirror, or a font filled with holy water)',
    duration: 'Concentration, up to 10 minutes',
    damage: '',
    save: 'Wisdom save',
    attack: '',
    ritual: false,
    concentration: true,
    description: 'You can see and hear a particular creature you choose that is on the same plane of existence as you. The target must make a Wisdom saving throw, which is modified by how well you know the target and the sort of physical connection you have to it.',
    wikiLink: 'https://www.dndbeyond.com/spells/scrying'
  }
};


// Show import popup
function showImportPopup(type) {
  const popup = document.getElementById('importSpellsPopup');
  const title = document.getElementById('importSpellsTitle');
  
  title.textContent = type === 'cantrip' ? 'Import Cantrips' : 'Import Spells';
  importMode = (type === 'cantrip') ? 'cantrip' : (type === 'spell' ? 'spell' : 'both');
  
  // Reset class selections
  classLevelSelections = [];
  document.getElementById('classLevelContainer').innerHTML = '';
  document.getElementById('importPreview').innerHTML = '';
  
  // Add first class selection
  addClassLevel();
  
  showPopup('importSpellsPopup');
}

// Add class/level selection row
function addClassLevel() {
  const container = document.getElementById('classLevelContainer');
  const rowId = 'classLevel_' + Date.now();
  
  const row = document.createElement('div');
  row.className = 'class-level-row';
  row.id = rowId;
  
  row.innerHTML = `
    <select onchange="updateImportPreview()">
      <option value="">Select Class</option>
      ${Object.keys(dndClasses).map(cls => `<option value="${cls}">${cls}</option>`).join('')}
    </select>
    <input type="number" min="1" max="20" value="1" onchange="updateImportPreview()" placeholder="Level">
    <button class="remove-class-btn" onclick="removeClassLevel('${rowId}')">Remove</button>
  `;
  
  container.appendChild(row);
  updateImportPreview();
}

// Remove class/level selection row
function removeClassLevel(rowId) {
  document.getElementById(rowId).remove();
  updateImportPreview();
}

// Update import preview
function updateImportPreview() {
  const preview = document.getElementById('importPreview');
  const rows = document.querySelectorAll('.class-level-row');
  
  let spellsToImport = [];
  let cantripsToImport = [];
  
  rows.forEach(row => {
    const classSelect = row.querySelector('select');
    const levelInput = row.querySelector('input');
    
    if (classSelect.value && levelInput.value) {
      const className = classSelect.value;
      const level = parseInt(levelInput.value);
      const classData = dndClasses[className];
      
      // Add cantrips (if allowed by mode)
      if (importMode !== 'spell' && classData.cantrips) {
        classData.cantrips.forEach(cantrip => {
          if (!cantripsToImport.find(c => c.name === cantrip)) {
            cantripsToImport.push({ name: cantrip, class: className });
          }
        });
      }
      
      // Add spells up to the selected level (if allowed by mode)
      if (importMode !== 'cantrip') {
        for (let i = 1; i <= Math.min(level, 9); i++) {
          if (classData.spells && classData.spells[i]) {
            classData.spells[i].forEach(spell => {
              if (!spellsToImport.find(s => s.name === spell)) {
                spellsToImport.push({ name: spell, level: i, class: className });
              }
            });
          }
        }
      }
    }
  });
  
  // Display preview
  let previewHTML = '';
  if (cantripsToImport.length > 0) {
    previewHTML += '<strong>Cantrips:</strong><br>';
    cantripsToImport.forEach(cantrip => {
      previewHTML += `• ${cantrip.name} (${cantrip.class})<br>`;
    });
    previewHTML += '<br>';
  }
  
  if (spellsToImport.length > 0) {
    previewHTML += '<strong>Spells:</strong><br>';
    spellsToImport.forEach(spell => {
      previewHTML += `• ${spell.name} (Level ${spell.level}, ${spell.class})<br>`;
    });
  }
  
  if (previewHTML === '') {
    previewHTML = 'Select classes and levels to see spells to import.';
  }
  
  preview.innerHTML = previewHTML;
}

// Execute import
function executeImport() {
  const rows = document.querySelectorAll('.class-level-row');
  let importedCount = 0;
  
  rows.forEach(row => {
    const classSelect = row.querySelector('select');
    const levelInput = row.querySelector('input');
    
    if (classSelect.value && levelInput.value) {
      const className = classSelect.value;
      const level = parseInt(levelInput.value);
      const classData = dndClasses[className];
      
      // Import cantrips (only if mode allows)
      if (importMode !== 'spell' && classData.cantrips) {
        classData.cantrips.forEach(cantripName => {
          if (!spellsData.cantrips.find(c => c.name === cantripName)) {
            // Create cantrip from database or use default
            const cantrip = createSpellFromName(cantripName, 0);
            if (cantrip) {
              spellsData.cantrips.push(cantrip);
              importedCount++;
            }
          }
        });
      }
      
      // Import spells up to selected level (support up to 9th level) if mode allows
      if (importMode !== 'cantrip') {
        for (let i = 1; i <= Math.min(level, 9); i++) {
          if (classData.spells && classData.spells[i]) {
            classData.spells[i].forEach(spellName => {
              if (!spellsData.spells.find(s => s.name === spellName)) {
                const spell = createSpellFromName(spellName, i);
                if (spell) {
                  spellsData.spells.push(spell);
                  importedCount++;
                }
              }
            });
          }
        }
      }
    }
  });
  
  // Reset filters to show newly imported content
  const cantripFilter = document.getElementById('cantrip_filter');
  if (cantripFilter) cantripFilter.value = 'all';
  const levelFilter = document.getElementById('spell_level_filter');
  if (levelFilter) levelFilter.value = 'all';
  const schoolFilter = document.getElementById('spell_school_filter');
  if (schoolFilter) schoolFilter.value = 'all';
  const statusFilter = document.getElementById('spell_status_filter');
  if (statusFilter) statusFilter.value = 'all';

  renderSpells();
  autosave();
  closePopup('importSpellsPopup');
  alert(importMode === 'cantrip' 
    ? `Imported ${importedCount} cantrips!`
    : (importMode === 'spell' 
      ? `Imported ${importedCount} spells!`
      : `Imported ${importedCount} spells and cantrips!`));
}

// Create spell from name using comprehensive database
function createSpellFromName(name, level) {
  // Check if we have detailed data in our database
  if (spellDatabase[name]) {
    const spellData = spellDatabase[name];
    return {
      name: name,
      level: spellData.level,
      school: spellData.school,
      castingTime: spellData.castingTime,
      range: spellData.range,
      components: spellData.components,
      duration: spellData.duration,
      damage: spellData.damage,
      save: spellData.save,
      attack: spellData.attack,
      ritual: spellData.ritual,
      concentration: spellData.concentration,
      prepared: false,
      description: spellData.description,
      wikiLink: spellData.wikiLink
    };
  }
  
  // Fallback for spells not in our database
  return {
    name: name,
    level: level,
    school: 'Evocation', // Default school
    castingTime: '1 action',
    range: '60 feet',
    components: 'V, S',
    duration: 'Instantaneous',
    damage: level === 0 ? '1d10 damage' : `${level}d6 damage`,
    save: '',
    attack: level === 0 ? 'Ranged spell attack' : '',
    ritual: false,
    concentration: false,
    prepared: false,
    description: `${name} - Official D&D 5e spell. Full description available in Player's Handbook.`,
    wikiLink: `https://www.dndbeyond.com/spells/${name.toLowerCase().replace(/\s+/g, '-').replace(/[^\w-]/g, '')}`
  };
}

// Toggle favorite status
function toggleFavorite(type, index) {
  const spell = type === 'cantrip' ? spellsData.cantrips[index] : spellsData.spells[index];
  if (!spell) return;
  
  const favorites = type === 'cantrip' ? favoritesData.cantrips : favoritesData.spells;
  const existingIndex = favorites.findIndex(f => f.name === spell.name);
  
  if (existingIndex !== -1) {
    favorites.splice(existingIndex, 1);
  } else {
    favorites.push(spell);
  }
  
  renderSpells(); // live update both lists and favorites section
  autosave();
}

// Name-based favorite toggle to avoid index mismatches from filtering/grouping
function toggleFavoriteByName(type, name) {
  const list = type === 'cantrip' ? spellsData.cantrips : spellsData.spells;
  const idx = list.findIndex(s => s.name === name);
  if (idx === -1) return;
  toggleFavorite(type, idx);
}

// Check if spell is favorited
function isFavorited(type, spellName) {
  const favorites = type === 'cantrip' ? favoritesData.cantrips : favoritesData.spells;
  return favorites.some(f => f.name === spellName);
}

// Clear all spells with 3-press confirmation
function clearAllSpells(type) {
  const currentCount = clearAllConfirmations[type];
  const requiredPresses = 3;
  
  // Increment the confirmation count
  clearAllConfirmations[type]++;
  
  if (clearAllConfirmations[type] < requiredPresses) {
    const remaining = requiredPresses - clearAllConfirmations[type];
    const typeName = type === 'cantrip' ? 'Cantrips' : 'Spells';
    
    // Update button text to show progress
    const button = event.target;
    const originalText = button.textContent;
    button.textContent = `Clear All ${typeName} (${remaining} more clicks)`;
    button.style.backgroundColor = '#ff6666';
    
    // Reset button after 3 seconds if not completed
    setTimeout(() => {
      if (clearAllConfirmations[type] < requiredPresses) {
        clearAllConfirmations[type] = 0;
        button.textContent = originalText;
        button.style.backgroundColor = '#ff4444';
      }
    }, 3000);
    
    return;
  }
  
  // Reset confirmation count
  clearAllConfirmations[type] = 0;
  
  // Get the spell array
  const spellArray = type === 'cantrip' ? spellsData.cantrips : spellsData.spells;
  const typeName = type === 'cantrip' ? 'cantrips' : 'spells';
  
  if (spellArray.length === 0) {
    alert(`No ${typeName} to clear!`);
    return;
  }
  
  // Final confirmation
  const confirmed = confirm(`Are you sure you want to clear ALL ${spellArray.length} ${typeName}?\n\nThis action cannot be undone!\n\nNote: This will NOT remove spells from your favorites.`);
  
  if (confirmed) {
    // Clear the spells array
    spellArray.length = 0;
    
    // Update the button back to normal
    const button = event.target;
    button.textContent = `Clear All ${typeName.charAt(0).toUpperCase() + typeName.slice(1)}`;
    button.style.backgroundColor = '#ff4444';
    
    // Re-render the spells
    renderSpells();
    autosave();
    
    alert(`All ${typeName} have been cleared!`);
  } else {
    // Reset button if user cancels
    const button = event.target;
    button.textContent = `Clear All ${typeName.charAt(0).toUpperCase() + typeName.slice(1)}`;
    button.style.backgroundColor = '#ff4444';
  }
}

// Initialize spell system when page loads
document.addEventListener('DOMContentLoaded', function() {
  initializeSpellSystem();
});

function loadLayout() {
  console.log("loadLayout function called.");
  // Add layout loading logic here if needed
}

// ========== FIREBASE CLOUD SYNC ==========

// Firebase Configuration
const firebaseConfig = {
  apiKey: "AIzaSyAgMenA-kiiwESliFp2zXgYLa7a3pPM65I",
  authDomain: "dndcharproject.firebaseapp.com",
  projectId: "dndcharproject",
  storageBucket: "dndcharproject.firebasestorage.app",
  messagingSenderId: "80899162338",
  appId: "1:80899162338:web:b7f9c9fbf96b9553c29ebb"
};

// Initialize Firebase
let firebaseApp, auth, db;
let currentUser = null;

function initializeFirebase() {
  try {
    firebaseApp = firebase.initializeApp(firebaseConfig);
    auth = firebase.auth();
    db = firebase.firestore();
    
    // Listen for auth state changes
    auth.onAuthStateChanged((user) => {
      currentUser = user;
      updateAuthUI();
      if (user) {
        setSyncStatus('Signed in successfully');
        // Auto-sync from cloud when user signs in
        setTimeout(() => syncFromCloud(true), 1000);
      }
    });
    
    console.log('Firebase initialized successfully');
  } catch (error) {
    console.error('Firebase initialization error:', error);
    setSyncStatus('Cloud sync unavailable');
  }
}

function updateAuthUI() {
  const signedInView = document.getElementById('signedInView');
  const signedOutView = document.getElementById('signedOutView');
  const userEmail = document.getElementById('userEmail');
  
  if (currentUser) {
    signedInView.style.display = 'block';
    signedOutView.style.display = 'none';
    userEmail.textContent = currentUser.email;
  } else {
    signedInView.style.display = 'none';
    signedOutView.style.display = 'block';
  }
}

function setSyncStatus(message) {
  const statusElement = document.getElementById('syncStatus');
  if (statusElement) {
    statusElement.textContent = message;
    // Clear status after 3 seconds
    setTimeout(() => {
      statusElement.textContent = '';
    }, 3000);
  }
}

// Authentication Functions
async function signInWithGoogle() {
  try {
    const provider = new firebase.auth.GoogleAuthProvider();
    await auth.signInWithPopup(provider);
    setSyncStatus('Signing in...');
  } catch (error) {
    console.error('Sign-in error:', error);
    setSyncStatus('Sign-in failed: ' + error.message);
  }
}

async function signOut() {
  try {
    await auth.signOut();
    setSyncStatus('Signed out');
  } catch (error) {
    console.error('Sign-out error:', error);
    setSyncStatus('Sign-out failed');
  }
}

// Cloud Sync Functions
async function syncToCloud() {
  if (!currentUser) {
    setSyncStatus('Please sign in first');
    return;
  }
  
  try {
    setSyncStatus('Uploading to cloud...');
    
    // Get current character data
    const characters = JSON.parse(localStorage.getItem('dndCharacters')) || [];
    const theme = localStorage.getItem('dndTheme') || 'dark';
    const accentColor = localStorage.getItem('dndAccentColor') || '#ffd700';
    
    const userData = {
      characters: characters,
      theme: theme,
      accentColor: accentColor,
      lastSync: firebase.firestore.FieldValue.serverTimestamp(),
      version: '1.0'
    };
    
    // Save to Firestore
    await db.collection('userData').doc(currentUser.uid).set(userData);
    
    setSyncStatus(`Uploaded ${characters.length} characters to cloud`);
  } catch (error) {
    console.error('Upload error:', error);
    setSyncStatus('Upload failed: ' + error.message);
  }
}

async function syncFromCloud(silent = false) {
  if (!currentUser) {
    if (!silent) setSyncStatus('Please sign in first');
    return;
  }
  
  try {
    if (!silent) setSyncStatus('Downloading from cloud...');
    
    // Get data from Firestore
    const doc = await db.collection('userData').doc(currentUser.uid).get();
    
    if (!doc.exists) {
      if (!silent) setSyncStatus('No cloud data found');
      return;
    }
    
    const userData = doc.data();
    
    // Ask user if they want to replace local data
    const localCharacters = JSON.parse(localStorage.getItem('dndCharacters')) || [];
    const cloudCharacters = userData.characters || [];
    
    let shouldReplace = true;
    if (!silent && localCharacters.length > 0) {
      shouldReplace = confirm(
        `Replace ${localCharacters.length} local characters with ${cloudCharacters.length} cloud characters?`
      );
    }
    
    if (shouldReplace) {
      // Replace local data with cloud data
      localStorage.setItem('dndCharacters', JSON.stringify(cloudCharacters));
      if (userData.theme) localStorage.setItem('dndTheme', userData.theme);
      if (userData.accentColor) localStorage.setItem('dndAccentColor', userData.accentColor);
      
      // Refresh the page to load new data
      if (!silent) {
        setSyncStatus(`Downloaded ${cloudCharacters.length} characters`);
        setTimeout(() => {
          if (confirm('Reload page to apply synced data?')) {
            location.reload();
          }
        }, 1000);
      } else {
        // Silent sync - just reload character list
        loadCharacterList();
        if (cloudCharacters.length > 0) {
          currentCharacter = cloudCharacters[0].id;
          loadData();
        }
      }
    }
  } catch (error) {
    console.error('Download error:', error);
    if (!silent) setSyncStatus('Download failed: ' + error.message);
  }
}

// Auto-sync functionality
function enableAutoSync() {
  // Auto-save to cloud every 5 minutes if signed in
  setInterval(() => {
    if (currentUser) {
      syncToCloud();
    }
  }, 5 * 60 * 1000); // 5 minutes
}

// Enhanced autosave to include cloud sync
const originalAutosave = autosave;
autosave = function() {
  // Call original autosave
  originalAutosave();
  
  // If user is signed in, schedule a cloud sync
  if (currentUser) {
    // Debounce cloud sync to avoid too many uploads
    clearTimeout(window.cloudSyncTimeout);
    window.cloudSyncTimeout = setTimeout(() => {
      syncToCloud();
    }, 10000); // Sync 10 seconds after last change
  }
};

// Initialize Firebase when page loads
document.addEventListener('DOMContentLoaded', function() {
  initializeFirebase();
  enableAutoSync();
});

</script>
</body>
</html>
